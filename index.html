<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Sistema de Evolu√ß√£o CTI Adulto">
<meta name="theme-color" content="#1a7a6f">

<link rel="icon" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
<text y='.9em' font-size='90'>üè•</text>
</svg>">

<title>Admiss√£o CTI Adulto</title>

<style>

/* ==============================
   RESET / BASE
============================== */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 20px;
  font-family: Arial, Helvetica, sans-serif;
  background: #f2f2f2;
  color: #111;
}

.hidden {
  display: none !important;
}

/* ==============================
   TOPO / HEADER
============================== */
.topo {
  display: flex;
  align-items: center;
  gap: 20px;
  margin-bottom: 20px;
}

.topo img {
  height: 70px;
}

.topo h1 {
  flex: 1;
  text-align: center;
  margin: 0;
  font-size: 26px;
  font-weight: bold;
}

/* ==============================
   SECTIONS
============================== */
.section {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto 20px auto;
}

/* ==============================
   ROW / FORM
============================== */
.row {
  display: flex;
  gap: 16px;
  margin-bottom: 14px;
  flex-wrap: wrap;
}

.row.nowrap {
  flex-wrap: nowrap;
}

label {
  display: flex;
  flex-direction: column;
  min-width: 140px;
  font-size: 14px;
}

input,
select,
textarea {
  padding: 6px 8px;
  font-size: 14px;
  border: 1px solid #bbb;
  border-radius: 4px;
}

textarea {
  resize: vertical;
  width: 100%;
}

button {
  padding: 10px 16px;
  font-size: 15px;
  border: 1px solid #777;
  border-radius: 6px;
  background: #f2f2f2;
  cursor: pointer;
}

button:hover {
  background: #e0e0e0;
}

/* ==============================
   PASS√îMETRO (LEITOS)
============================== */
.passometro {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 14px;
}

.leito {
  padding: 14px;
  border-radius: 10px;
  color: #fff;
  text-align: center;
  cursor: pointer;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
  transition: transform 0.15s;
}

.leito:hover {
  transform: translateY(-3px);
}

.leito strong {
  display: block;
  font-size: 18px;
}

.leito small {
  display: block;
  margin-top: 6px;
  opacity: 0.9;
}

/* ==============================
   STATUS VISUAL
============================== */
.leito.livre {
  background: #2e7d32;
}

.leito.ocupado {
  background: #c62828;
}

.leito.bloqueado {
  background: #f9a825;
  color: #333;
}

.leito.limpeza {
  background: #1565c0;
}

.leito.ativo {
  outline: 4px solid #000;
}

/* ==============================
   HIST√ìRICO
============================== */
.historico-item {
  border-bottom: 1px solid #ddd;
  padding: 10px 0;
}

.historico-item:last-child {
  border-bottom: none;
}

.historico-meta {
  font-size: 12px;
  color: #666;
  margin-bottom: 4px;
}

/* ==============================
   MODAIS
============================== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 1100px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
}

/* ==============================
   RESPONSIVO
============================== */
@media (max-width: 768px) {
  .topo h1 {
    font-size: 20px;
  }

  .topo img {
    height: 55px;
  }
}

</style>
</head>
b
  <body>

<!-- ============================
     TOPO
============================ -->
<div class="topo">
  <img src="HNSS.jpeg" alt="HNSS">
  <h1>Admiss√£o CTI Adulto</h1>
  <img src="intensivale.png" alt="Intensivale">
</div>

<!-- ============================
     LOGIN
============================ -->
<div class="section" id="loginArea">
  <h3>Login</h3>
  <div class="row">
    <label>Email
      <input type="email" id="loginEmail">
    </label>
    <label>Senha
      <input type="password" id="loginSenha">
    </label>
    <button onclick="login()">Entrar</button>
  </div>
</div>

<!-- ============================
     PASS√îMETRO
============================ -->
<div class="section hidden" id="passometroArea">
  <h3>Pass√¥metro</h3>
  <div class="passometro" id="passometroLeitos">
    <!-- leitos renderizados via JS -->
  </div>
</div>

<!-- ============================
     SELETOR CTI (ser√° neutralizado)
============================ -->
<div class="section hidden" id="ctiArea">
  <h3>Selecionar CTI</h3>
  <div class="row">
    <label>CTI
      <select id="ctiSelect">
        <option value="">Selecione</option>
        <option value="CTI1">CTI 1</option>
        <option value="CTI2">CTI 2</option>
      </select>
    </label>
  </div>
</div>

<!-- ============================
     ADMISS√ÉO / EVOLU√á√ÉO
============================ -->
<div class="section hidden" id="admissaoArea">

  <h3 id="tituloLeito">Leito</h3>

  <!-- IDENTIFICA√á√ÉO -->
  <h4>Identifica√ß√£o</h4>
  <div class="row">
    <label>Nome
      <input name="nome">
    </label>
    <label>Idade
      <input name="idade">
    </label>
    <label>Sexo
      <select name="sexo">
        <option></option>
        <option value="M">Masculino</option>
        <option value="F">Feminino</option>
      </select>
    </label>
    <label>Data/Hora admiss√£o
      <input type="datetime-local" name="datahora_admissao">
    </label>
  </div>

  <div class="row">
    <label style="flex:1;">HMA
      <textarea name="hma" rows="3"></textarea>
    </label>
  </div>

  <button onclick="salvarAdmissao()">Salvar admiss√£o</button>

  <hr>

  <!-- EVOLU√á√ÉO -->
  <h4>Evolu√ß√£o di√°ria</h4>
  <div class="row nowrap">
    <label>Data
      <input type="date" id="evoData">
    </label>
    <label>Turno
      <select id="evoTurno">
        <option value="Diurna">Diurna</option>
        <option value="Noturna">Noturna</option>
      </select>
    </label>
  </div>

  <div class="row">
    <label style="flex:1;">Evolu√ß√£o
      <textarea id="evoTexto" rows="4"></textarea>
    </label>
  </div>

  <button onclick="salvarEvolucao()">Salvar evolu√ß√£o</button>

  <hr>

  <!-- HIST√ìRICO -->
  <h4>Hist√≥rico</h4>
  <div id="historicoArea">
    <!-- hist√≥rico via JS -->
  </div>

  <hr>

  <!-- ALTA -->
  <h4>Alta</h4>
  <div class="row">
    <label>Data/Hora alta
      <input type="datetime-local" id="altaData">
    </label>
  </div>

  <div class="row">
    <label style="flex:1;">Resumo de alta
      <textarea id="altaResumo" rows="3"></textarea>
    </label>
  </div>

  <button onclick="darAlta()">Dar alta</button>

</div>
<script type="module">
/* ============================
   FIREBASE IMPORTS
============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  collection,
  addDoc,
  onSnapshot,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* ============================
   FIREBASE CONFIG ‚Äì HNSS
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyB7Mt4NsiXOam36i5MgClhKa-IOimlQ4DE",
  authDomain: "gestaoutihnss.firebaseapp.com",
  projectId: "gestaoutihnss",
  storageBucket: "gestaoutihnss.firebasestorage.app",
  messagingSenderId: "664272211913",
  appId: "1:664272211913:web:66e30e6670126b3e51a218",
  measurementId: "G-K0ZB5KLRGY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ============================
   CONSTANTES FIXADAS
============================ */
const CTI_FIXO = "UTI_HNSS";
const LEITOS_FIXOS = ["01","02","03","04","05","06","07","08","09","10"];

/* ============================
   ESTADO GLOBAL
============================ */
let usuarioLogado = null;
let leitoSelecionado = null;

/* ============================
   LOGIN
============================ */
window.login = function () {
  signInWithEmailAndPassword(
    auth,
    document.getElementById("loginEmail").value,
    document.getElementById("loginSenha").value
  ).catch(e => alert(e.message));
};

onAuthStateChanged(auth, user => {
  if (user) {
    usuarioLogado = user;
    document.getElementById("loginArea").classList.add("hidden");
    document.getElementById("passometroArea").classList.remove("hidden");
    iniciarPassometro();
  }
});

/* ============================
   PASS√îMETRO
============================ */
function iniciarPassometro() {
  const container = document.getElementById("passometroLeitos");
  container.innerHTML = "";

  LEITOS_FIXOS.forEach(num => {
    const div = document.createElement("div");
    div.id = "leito_" + num;
    div.className = "leito livre";
    div.innerHTML = `<strong>Leito ${num}</strong><small></small>`;
    div.onclick = () => selecionarLeito(num);
    container.appendChild(div);

    const ref = doc(db, "leitos", CTI_FIXO + "_" + num);
    onSnapshot(ref, snap => atualizarLeitoVisual(num, snap.exists() ? snap.data() : null));
  });
}

function atualizarLeitoVisual(num, data) {
  const div = document.getElementById("leito_" + num);
  if (!div) return;

  const status = data?.status || "livre";
  const nome = data?.nome || "";

  div.className = `leito ${status} ${leitoSelecionado === num ? "ativo" : ""}`;
  div.querySelector("small").innerText = nome;
}

/* ============================
   SELE√á√ÉO DE LEITO
============================ */
async function selecionarLeito(num) {
  leitoSelecionado = num;

  document.querySelectorAll(".leito").forEach(l => l.classList.remove("ativo"));
  document.getElementById("leito_" + num).classList.add("ativo");

  document.getElementById("admissaoArea").classList.remove("hidden");
  document.getElementById("tituloLeito").innerText = "Leito " + num;

  document.querySelectorAll("[name]").forEach(el => el.value = "");

  const ref = doc(db, "leitos", CTI_FIXO + "_" + num);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const d = snap.data();
    document.querySelectorAll("[name]").forEach(el => {
      if (d[el.name]) el.value = d[el.name];
    });
  }

  carregarHistorico();
}

/* ============================
   ADMISS√ÉO
============================ */
window.salvarAdmissao = async function () {
  if (!leitoSelecionado) return;

  let dados = {
    status: "ocupado",
    atualizado_por: usuarioLogado.email,
    atualizado_em: new Date()
  };

  document.querySelectorAll("[name]").forEach(el => {
    dados[el.name] = el.value;
  });

  await setDoc(doc(db, "leitos", CTI_FIXO + "_" + leitoSelecionado), dados, { merge: true });
  alert("Admiss√£o salva");
};

/* ============================
   EVOLU√á√ÉO DI√ÅRIA
============================ */
window.salvarEvolucao = async function () {
  if (!leitoSelecionado) return;

  await addDoc(collection(db, "evolucoes", CTI_FIXO + "_" + leitoSelecionado, "dias"), {
    data: document.getElementById("evoData").value,
    turno: document.getElementById("evoTurno").value,
    texto: document.getElementById("evoTexto").value,
    criado_em: new Date(),
    usuario: usuarioLogado.email
  });

  document.getElementById("evoTexto").value = "";
};

/* ============================
   HIST√ìRICO
============================ */
function carregarHistorico() {
  const area = document.getElementById("historicoArea");
  area.innerHTML = "";

  onSnapshot(
    collection(db, "evolucoes", CTI_FIXO + "_" + leitoSelecionado, "dias"),
    snap => {
      area.innerHTML = "";
      snap.forEach(docu => {
        const d = docu.data();
        const div = document.createElement("div");
        div.className = "historico-item";
        div.innerHTML = `
          <div class="historico-meta">${d.data} ‚Äì ${d.turno}</div>
          <div>${d.texto}</div>
        `;
        area.appendChild(div);
      });
    }
  );
}

/* ============================
   ALTA COM ARQUIVAMENTO
============================ */
window.darAlta = async function () {
  if (!leitoSelecionado) return;

  const leitoRef = doc(db, "leitos", CTI_FIXO + "_" + leitoSelecionado);
  const leitoSnap = await getDoc(leitoRef);
  if (!leitoSnap.exists()) return;

  const evolSnap = await getDocs(collection(db, "evolucoes", CTI_FIXO + "_" + leitoSelecionado, "dias"));
  let evolucoes = [];
  evolSnap.forEach(e => evolucoes.push(e.data()));

  await addDoc(collection(db, "altas"), {
    leito: leitoSelecionado,
    paciente: leitoSnap.data(),
    evolucoes,
    alta_em: document.getElementById("altaData").value,
    resumo: document.getElementById("altaResumo").value,
    usuario: usuarioLogado.email
  });

  for (const e of evolSnap.docs) {
    await deleteDoc(e.ref);
  }

  await setDoc(leitoRef, { status: "livre" });
  alert("Alta realizada e arquivada");

  document.getElementById("admissaoArea").classList.add("hidden");
};
</script>
</body>
</html>
