<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Sistema de Evolu√ß√£o e Admiss√£o CTI - Hospital Nossa Senhora da Sa√∫de / Intensivale">
<meta name="theme-color" content="#1565c0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<title>Pass√¥metroUTI - Sistema de Evolu√ß√£o CTI</title>
<style>
    
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #fff;
      color: #111;
    }
    h1 { text-align: center; margin-bottom: 24px; }
    .section{
      border: 1px solid #ccc;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .row{
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .row.nowrap{ flex-wrap: nowrap; }
    label{
      display: flex;
      flex-direction: column;
      min-width: 140px;
    }
    input, select, textarea{
      padding: 6px;
      font-size: 14px;
      border: 1px solid #bbb;
      border-radius: 4px;
    }
    input[readonly]{ background: #eaeaea; }
    textarea{ width: 100%; resize: vertical; }
    .hidden{display:none !important;}
  
    .med-item{
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 220px;
      margin-right: 10px;
    }
    .dose-input{
      width: 110px;
      padding: 5px;
      font-size: 13px;
    }
button{
      padding: 10px 16px;
      font-size: 15px;
      border: 1px solid #777;
      border-radius: 6px;
      background: #f2f2f2;
      cursor: pointer;
    }
    button:hover{ filter: brightness(0.98); }
    
    .divider{
      margin-top: 22px;
      border-top: 3px solid #e5e7eb;
      padding-top: 14px;
    }

    /* --- NOVOS ESTILOS PARA GERENCIAMENTO --- */
    #evoHistoryList .evo-item {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        margin: 5px 0;
        background: #f9f9f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #evoHistoryList h4 { margin: 10px 0 5px; }
/* --- ESTILO DE IMPRESS√ÉO (O SEGREDO M√ÅGICO) --- */
    @media print {
      /* Esconde bot√µes, √°reas de controle e t√≠tulos de se√ß√£o desnecess√°rios */
      button, .no-print, #evoHistoryList, .section h3, #status_save, #status_evo_save {
        display: none !important;
      }
      
      /* Remove bordas e fundos dos inputs para parecer texto corrido */
      input, textarea, select {
        border: none !important;
        background: transparent !important;
        resize: none;
        padding: 0;
        font-weight: bold;
        color: #000;
        appearance: none;
        -webkit-appearance: none;
        box-shadow: none !important;
      }
      
      /* For√ßa mostrar o valor selecionado no Select */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        text-indent: 1px;
        text-overflow: '';
      }
/* Expande textareas para mostrar todo o texto sem barra de rolagem */
      textarea {
        height: auto;
        overflow: visible;
        display: block;
      }

      /* Remove sombras e ajusta margens para o papel */
      .section {
        border: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 5px 0 !important;
        page-break-inside: avoid; /* Evita quebrar quadros no meio */
      }
      
      body {
        margin: 0;
        padding: 0;
        font-size: 11pt; /* Letra um pouco menor para caber mais */
      }
      
      /* Remove o fundo cinza da p√°gina */
      body, .section {
        background-color: white !important;
      }
    }
/* --- ESTILOS DO SISTEMA DE LOGIN --- */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }
    
    #loginBox {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    #loginBox h1 {
      color: #1565c0;
      margin-bottom: 10px;
    }
    
    #loginBox h3 {
      color: #666;
      font-weight: normal;
      margin-bottom: 30px;
    }
    
    #loginBox input {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    #loginBox input:focus {
      border-color: #1565c0;
      outline: none;
    }
    
    #loginBox button {
      width: 100%;
      padding: 15px;
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    #loginBox button:hover {
      background: #0d47a1;
    }
    
    #loginError {
      color: #c62828;
      margin-top: 15px;
      font-size: 14px;
    }
    
    #userInfo {
      background: #e8f5e9;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #userInfo button {
      padding: 5px 12px;
      font-size: 12px;
      background: #ef5350;
      color: white;
      border: none;
    }
    
    .admin-only {
      display: none;
    }
    
    .sync-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      margin-left: 10px;
    }
    
    .sync-ok { background: #c8e6c9; color: #2e7d32; }
    .sync-error { background: #ffcdd2; color: #c62828; }
    .sync-pending { background: #fff9c4; color: #f57f17; }
</style>

<!-- Firebase SDKs (MODIFICADO) -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js"; // Adicionado para autentica√ß√£o
    import { getFirestore, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js"; // Adicionado para Firestore e serverTimestamp

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB7Mt4NsiXOam36i5MgClhKa-IOimlQ4DE",
        authDomain: "gestaoutihnss.firebaseapp.com",
        projectId: "gestaoutihnss",
        storageBucket: "gestaoutihnss.firebasestorage.app",
        messagingSenderId: "664272211913",
        appId: "1:664272211913:web:66e30e6670126b3e51a218",
        measurementId: "G-K0ZB5KLRGY"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expondo 'auth', 'db', 'serverTimestamp' e vari√°veis de estado para o escopo global
    // para que fun√ß√µes externas (que n√£o s√£o m√≥dulos) possam acess√°-los.
    window.auth = auth;
    window.db = db;
    window.serverTimestamp = serverTimestamp;
    window.currentUser = null;
    window.isAdmin = false;

    // Listener de mudan√ßa de autentica√ß√£o (MOVIDO PARA DENTRO DO M√ìDULO E ADAPTADO)
    auth.onAuthStateChanged(function(user) {
        if (user) {
            window.currentUser = user; // Atualiza a vari√°vel global
            
            db.collection('usuarios').doc(user.uid).get()
                .then(function(doc) {
                    if (doc.exists) {
                        window.isAdmin = doc.data().admin === true; // Atualiza a vari√°vel global
                        var nome = doc.data().nome || user.email;
                        mostrarSistema(nome);
                    } else {
                        // Criar registro de usu√°rio se n√£o existir
                        db.collection('usuarios').doc(user.uid).set({
                            email: user.email,
                            nome: user.email.split('@')[0],
                            admin: false,
                            criadoEm: serverTimestamp() // Usa a fun√ß√£o serverTimestamp importada
                        });
                        window.isAdmin = false; // Atualiza a vari√°vel global
                        mostrarSistema(user.email);
                    }
                })
                .catch(function(error) {
                    console.error('Erro ao buscar usu√°rio:', error);
                    mostrarSistema(user.email);
                });
        } else {
            window.currentUser = null;
            window.isAdmin = false;
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    });
</script>

<script src="https/cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ===== Helpers (ES5) =====
  function byId(id){ return document.getElementById(id); }
  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return document.querySelectorAll(sel); }
function pad2(n){ return (n<10 ? '0' : '') + n; }

  function nowLocalDatetimeValue(){
    var d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()) +
           'T' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());
  }

  function clearContainer(el) {
    if (!el) return;
    var inputs = el.querySelectorAll('input, textarea, select');
    for (var i=0;i<inputs.length;i++){
      var inp = inputs[i];
      if (inp.type === 'radio' || inp.type === 'checkbox') inp.checked = false;
      else inp.value = '';
    }
  }


  function setNowIfEmptyInput(el){
    if (el && !el.value) el.value = nowLocalDatetimeValue();
  }

  function setNowIfEmpty(idOrName, within){
    var el = null;
    if (within) el = within.querySelector('[name="'+idOrName+'"]') || within.querySelector('#'+idOrName);
    if (!el) el = byId(idOrName) || qs('[name="'+idOrName+'"]');
    setNowIfEmptyInput(el);
  }
function parseLocalDateTime(s){
    if (!s) return null;
    var parts = s.split('T');
    var datePart = parts[0];
    if (!datePart || datePart.length < 10) return null;

    var y = parseInt(datePart.substr(0,4),10);
    var m = parseInt(datePart.substr(5,2),10)-1;
    var d = parseInt(datePart.substr(8,2),10);

    var hh = 0, mm = 0;
    if (parts.length > 1 && parts[1].length >= 5) {
      hh = parseInt(parts[1].substr(0,2),10) || 0;
      mm = parseInt(parts[1].substr(3,2),10) || 0;
    }
    return new Date(y,m,d,hh,mm,0,0);
  }
  // ===== C√°lculos =====
  function calcularIMC() {
    var pesoEl = byId('peso');
    var alturaEl = byId('altura');
    var imcEl = byId('imc');
    if (!imcEl) return;

    var peso = pesoEl ? parseFloat(pesoEl.value) : NaN;
    var alturaCm = alturaEl ? parseFloat(alturaEl.value) : NaN;
if (peso > 0 && alturaCm > 0) {
      var alturaM = alturaCm / 100;
      var imc = peso / (alturaM * alturaM);
      imcEl.value = (Math.round(imc * 100) / 100).toFixed(2);
    } else {
      imcEl.value = '';
    }
  }

  function calcularPBW() {
    var alturaEl = byId('altura');
    var sexoEl = byId('sexo');
    var pbwEl = byId('pbw');
    if (!pbwEl) return;

    var altura = alturaEl ? parseFloat(alturaEl.value) : NaN;
    var sexo = sexoEl ? sexoEl.value : '';

    if (!(altura > 0) || !sexo) { pbwEl.value = ''; return; }

    var base = altura - 152.4;
    var pbw = 0;
    if (sexo === 'M') pbw = 50 + 0.91 * base;
    else if (sexo === 'F') pbw = 45.5 + 0.91 * base;
    else { pbwEl.value = ''; return; }

    pbwEl.value = (Math.round(pbw * 100) / 100).toFixed(2);
  }

  // ===== UI: Alergias =====
  function toggleAlergiaCampo(mostrar) {
    var campo = byId('campoAlergia');
    if (!campo) return;
    if (mostrar) {
      campo.classList.remove('hidden');
    } else {
      var ta = campo.querySelector('textarea');
      if (ta) ta.value = '';
      campo.classList.add('hidden');
    }
  }
// ===== UI: Toggle Admiss√£o (colapsar/expandir) =====
  var admissaoColapsada = false;
  
  function toggleAdmissao() {
    var conteudo = byId('admissaoConteudo');
    var btn = byId('btnToggleAdmissao');
    var resumo = byId('admissaoResumo');
    
    if (!conteudo || !btn) return;
    
    if (admissaoColapsada) {
      // Expandir
      conteudo.style.display = 'block';
      btn.innerHTML = 'üîΩ Recolher';
      resumo.textContent = '';
      admissaoColapsada = false;
    } else {
      // Colapsar
      var nome = document.getElementsByName('nome')[0];
      var idade = byId('idade');
      var dataAdm = byId('datahora_admissao');
      
      var resumoTexto = '';
      if (nome && nome.value) {
        resumoTexto = nome.value;
        if (idade && idade.value) resumoTexto += ', ' + idade.value + ' anos';
        if (dataAdm && dataAdm.value) {
          var d = new Date(dataAdm.value);
          resumoTexto += ' - Adm: ' + d.toLocaleDateString('pt-BR');
        }
        }
      }
      
      conteudo.style.display = 'none';
      btn.innerHTML = 'üîº Expandir';
      resumo.textContent = resumoTexto || '(sem dados)';
      admissaoColapsada = true;
    }
  }
  
  function salvarAdmissao() {
    // Salva os dados da admiss√£o
    salvarLeitoAtual();
    
    // Colapsa automaticamente ap√≥s salvar
    if (!admissaoColapsada) {
      toggleAdmissao();
    }
    
    alert('‚úÖ Admiss√£o salva com sucesso!');
  }
// ===== UI: Toggle Transfus√µes =====
  function toggleTransfusao(tipo) {
    var checkbox = document.getElementsByName('evo_transf_' + tipo)[0];
    var qtdInput = byId('evo_transf_' + tipo + '_qtd');
    
    if (!checkbox || !qtdInput) return;
    
    if (checkbox.checked) {
      qtdInput.style.display = 'inline-block';
      qtdInput.focus();
    } else {
      qtdInput.style.display = 'none';
      qtdInput.value = '';
    }
  }

  // ===== UI: Toggle Neurol√≥gico (Doppler, Brain4care) =====
  function toggleNeuroExtra(tipo) {
    var checkbox = document.getElementsByName('evo_' + tipo + '_check')[0];
    var wrap = byId('evo_' + tipo + '_wrap');
    
    if (!checkbox || !wrap) return;
    
    if (checkbox.checked) {
      wrap.classList.remove('hidden');
    } else {
      wrap.classList.add('hidden');
      var textarea = wrap.querySelector('textarea');
      if (textarea) textarea.value = '';
    }
  }
// ===== UI: Toggle Hemodin√¢mico (Swan Ganz, Marcapasso, esCCO) =====
  function toggleHemoExtra(tipo) {
    var checkbox = document.getElementsByName('evo_' + tipo + '_check')[0];
    var wrap = byId('evo_' + tipo + '_wrap');
    
    if (!checkbox || !wrap) return;
    
    if (checkbox.checked) {
      wrap.classList.remove('hidden');
    } else {
      wrap.classList.add('hidden');
      // Limpar campos
      var inputs = wrap.querySelectorAll('input');
      inputs.forEach(function(input) { input.value = ''; });
    }
  }

  // ===== UI: Nova Evolu√ß√£o R√°pida =====
  function novaEvolucaoRapida() {
    // Colapsa admiss√£o se estiver expandida
    if (!admissaoColapsada) {
      toggleAdmissao();
    }
    // Abre a evolu√ß√£o di√°ria
    abrirEvolucao();
  }
// ===== UI: Respirat√≥rio =====
  function toggleResp(tipo) {
    var vm = byId('resp_vm');
    var venturi = byId('resp_venturi');
    var cn = byId('resp_cn');
    var mr = byId('resp_mr');
    if (!vm || !venturi || !cn || !mr) return;

    vm.classList.add('hidden');
    venturi.classList.add('hidden');
    cn.classList.add('hidden');
    mr.classList.add('hidden');

    
    // Se voltar para Ar ambiente, limpar campos dos suportes anteriores
    if (tipo === 'Ar ambiente') {
      clearContainer(vm);
      clearContainer(venturi);
      clearContainer(cn);
      clearContainer(mr);
      return;
    }
if (tipo === 'VM') vm.classList.remove('hidden');
    else if (tipo === 'Venturi') venturi.classList.remove('hidden');
    else if (tipo === 'CN') cn.classList.remove('hidden');
    else if (tipo === 'MR') mr.classList.remove('hidden');
  }
// ===== UI: Gasometria =====
  function toggleGasometria() {
    var chk = byId('chk_gaso');
    var div = byId('gaso_fields');
    if (!chk || !div) return;

    if (chk.checked) {
      div.classList.remove('hidden');
    } else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }

  // ===== UI: Hemodin√¢mica =====
  function toggleHemoDrug(drug) {
    var map = {
      dobutamina: { chk: 'chk_dobutamina', div: 'drug_dobutamina' },
      milrinona: { chk: 'chk_milrinona', div: 'drug_milrinona' },
      noradrenalina: { chk: 'chk_noradrenalina', div: 'drug_noradrenalina' },
      vasopressina: { chk: 'chk_vasopressina', div: 'drug_vasopressina' }
    };
    if (!map[drug]) return;

    var chk = byId(map[drug].chk);
    var div = byId(map[drug].div);
    if (!chk || !div) return;
if (chk.checked) {
      div.classList.remove('hidden');
    } else {
      var input = div.querySelector('input');
      if (input) input.value = '';
      div.classList.add('hidden');
    }
  }

  function togglePerfusao() {
    var chk = byId('chk_perf');
    var div = byId('perf_fields');
    if (!chk || !div) return;

    if (chk.checked) {
      div.classList.remove('hidden');
    } else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }

  // ===== UI: Culturas =====
  function toggleCultOutros() {
    var chk = byId('cult_outros_chk');
    var wrap = byId('cult_outros_txt_wrap');
    if (!chk || !wrap) return;

    if (chk.checked) wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }
function toggleCulturas(sim) {
    var divSim = byId('culturas_sim');
    var divNao = byId('culturas_nao');
    if (!divSim || !divNao) return;

    if (sim) {
      divSim.classList.remove('hidden');
      divNao.classList.add('hidden');
      var motivo = divNao.querySelector('input');
      if (motivo) motivo.value = '';
    } else {
      divNao.classList.remove('hidden');
      divSim.classList.add('hidden');

      var cbs = divSim.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;

      var outrosTxt = qs('input[name="cult_outros_txt"]');
      if (outrosTxt) outrosTxt.value = '';
      var wrap = byId('cult_outros_txt_wrap');
      if (wrap) wrap.classList.add('hidden');
    }
  }
// ===== UI: Glasgow =====
  function calcGlasgow() {
    var ao = parseFloat((byId('glasgow_ao')||{}).value) || 0;
    var rv = parseFloat((byId('glasgow_rv')||{}).value) || 0;
    var rm = parseFloat((byId('glasgow_rm')||{}).value) || 0;
    var total = ao + rv + rm;
    var out = byId('glasgow_total');
    if (out) out.value = total > 0 ? total : '';
  }

  // ===== UI: Analgesia/Seda√ß√£o =====
  function toggleAnalgesia(sim) {
    var div = byId('analgesia_lista');
    if (!div) return;

    if (sim) {
      div.classList.remove('hidden');
    } else {
      var cbs = div.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;

      var doses = div.querySelectorAll('input.dose-input');
      for (var j=0;j<doses.length;j++) {
        doses[j].value = '';
        doses[j].classList.add('hidden');
      }
      div.classList.add('hidden');
    }
  }
function toggleDose(chkId, doseId) {
    var chk = byId(chkId);
    var dose = byId(doseId);
    if (!chk || !dose) return;

    if (chk.checked) {
      dose.classList.remove('hidden');
      try { dose.focus(); } catch(e){}
    } else {
      dose.value = '';
      dose.classList.add('hidden');
    }
  }

  // ===== Evolu√ß√£o: Neuro igual √† admiss√£o =====
  function evoCalcGlasgow() {
    var ao = parseFloat((byId('evo_glasgow_ao')||{}).value) || 0;
    var rv = parseFloat((byId('evo_glasgow_rv')||{}).value) || 0;
    var rm = parseFloat((byId('evo_glasgow_rm')||{}).value) || 0;
    var total = ao + rv + rm;
    var out = byId('evo_glasgow_total');
    if (out) out.value = total > 0 ? String(total) : '';
  }
function evoToggleDelirium(sim) {
    var tipos = byId('evo_delirium_tipos');
    if (!tipos) return;
    if (sim) {
      tipos.classList.remove('hidden');
    } else {
      var cbs = tipos.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;
      tipos.classList.add('hidden');
    }
  }

  function evoToggleAnalgesia(sim) {
    var div = byId('evo_analgesia_lista');
    if (!div) return;
    if (sim) {
      div.classList.remove('hidden');
    } else {
      var cbs = div.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;

      var doses = div.querySelectorAll('input.dose-input');
      for (var j=0;j<doses.length;j++) { doses[j].value=''; doses[j].classList.add('hidden'); }

      div.classList.add('hidden');
    }
  }
  // ===== UI: Delirium =====
  function toggleDelirium(sim) {
    var tipos = byId('delirium_tipos');
    if (!tipos) return;
if (sim) {
      tipos.classList.remove('hidden');
    } else {
      var cbs = tipos.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;
      tipos.classList.add('hidden');
    }
  }

  // ===== Persist√™ncia (LocalStorage) =====
  function coletarDadosFormulario() {
    var data = {};
    var els = qsa('input, select, textarea');
    for (var i=0;i<els.length;i++) {
      var el = els[i];
      var key = el.name || el.id;
      if (!key) continue;

      if (el.type === 'checkbox') data[key] = !!el.checked;
      else if (el.type === 'radio') {
        if (el.checked) data[key] = el.value;
        else if (typeof data[key] === 'undefined') data[key] = null;
      } else data[key] = el.value;
    }
    return data;
  }
function aplicarDadosFormulario(data) {
    if (!data) return;
    
    // Primeiro, aplicar campos com :: (checkboxes e radios salvos no formato antigo)
    for (var chave in data) {
      if (chave.includes('::')) {
        var partes = chave.split('::');
        var nome = partes[0];
        var valor = partes[1];
        var el = qs('input[name="'+nome+'"][value="'+valor+'"]');
        if (el) el.checked = true;
      }
    }
    
    // Depois, aplicar os demais campos
    var els = qsa('input, select, textarea');
    for (var i=0;i<els.length;i++) {
      var el = els[i];
      var key = el.name || el.id;
      if (!key || typeof data[key] === 'undefined') continue;

      if (el.type === 'checkbox') el.checked = !!data[key];
      else if (el.type === 'radio') el.checked = (data[key] !== null && el.value === data[key]);
      else el.value = data[key] !== null ? data[key] : '';
    }

    calcularIMC();
    calcularPBW();

    // Alergias
    var alSim = qs('input[name="alergias_check"][value="sim"]');
    var alNao = qs('input[name="alergias_check"][value="nao"]');
    if (alSim && alSim.checked) toggleAlergiaCampo(true);
    if (alNao && alNao.checked) toggleAlergiaCampo(false);

    // Respirat√≥rio
    var respSel = qs('input[name="resp_suporte"]:checked');
    if (respSel) toggleResp(respSel.value);

    // Gasometria
    if (byId('chk_gaso')) toggleGasometria();

    // Culturas
    var cultSel = qs('input[name="inf_culturas"]:checked');
    if (cultSel) toggleCulturas(cultSel.value === 'sim');
    if (byId('cult_outros_chk')) toggleCultOutros();

    // Hemo
    var drugs = ['dobutamina','milrinona','noradrenalina','vasopressina'];
    for (var d=0; d<drugs.length; d++) {
      if (byId('chk_' + drugs[d])) toggleHemoDrug(drugs[d]);
    }
    if (byId('chk_perf')) togglePerfusao();
// Analgesia
    var analgSel = qs('input[name="analg_sed"]:checked');
    if (analgSel) toggleAnalgesia(analgSel.value === 'sim');

    // Doses
    var chkMeds = qsa('#analgesia_lista input[type="checkbox"]');
    for (var k=0;k<chkMeds.length;k++) {
      var chk = chkMeds[k];
      var dose = byId('dose_' + chk.id);
      if (dose) {
        if (chk.checked) dose.classList.remove('hidden');
        else dose.classList.add('hidden');
      }
    }

    // Delirium
    var delSel = qs('input[name="delirium"]:checked');
    if (delSel) toggleDelirium(delSel.value === 'sim');

    // Glasgow
    if (byId('glasgow_ao')) calcGlasgow();
  }

  function salvarFormulario() {
    try {
      var data = coletarDadosFormulario();
      localStorage.setItem('admissao_cti_adulto', JSON.stringify(data));
      var st = byId('status_save');
      if (st) {
        st.textContent = 'Salvo ‚úî';
        setTimeout(function(){ st.textContent = ''; }, 2000);
      }
    } catch(e){}
  }
function carregarFormulario() {
    try {
      var raw = localStorage.getItem('admissao_cti_adulto');
      if (!raw) return;
      aplicarDadosFormulario(JSON.parse(raw));
    } catch(e){}
  }

  // ===== Texto para copiar =====
  function val(nameOrId) {
    var el = qs('[name="'+nameOrId+'"]') || byId(nameOrId);
    if (!el) return '';
    if (el.type === 'checkbox') return el.checked ? 'Sim' : 'N√£o';
    if (el.type === 'radio') {
      var sel = qs('input[name="'+nameOrId+'"]:checked');
      return sel ? sel.value : '';
    }
    return (el.value || '').replace(/^\s+|\s+$/g,'');
  }

  function abrirPainelTexto() {
    var p = byId('painelTexto');
    if (p) {
      p.classList.remove('hidden');
      try { p.scrollIntoView({behavior:'smooth', block:'start'}); } catch(e){ p.scrollIntoView(true); }
    }
  }

  function fecharPainelTexto() {
    var p = byId('painelTexto');
    if (p) p.classList.add('hidden');
  }
function copiarTexto() {
    var ta = byId('textoGerado');
    if (!ta) return;
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); } catch(e){}
  }

  function gerarTexto() {
    var linhas = [];

    var nome = val('nome');
    var idade = val('idade');
    var sexoEl = byId('sexo');
    var sexo = sexoEl ? sexoEl.value : '';
    var data = val('data_admissao');
    var peso = val('peso');
    var altura = val('altura');
    var imc = val('imc');
    var pbw = val('pbw');

    linhas.push('ADMISS√ÉO CTI ADULTO');
    var idParts = [];
    if (nome) idParts.push('Nome: ' + nome);
    if (idade) idParts.push('Idade: ' + idade);
    if (sexo) idParts.push('Sexo: ' + sexo);
    if (data) idParts.push('Data: ' + data);
    linhas.push('Identifica√ß√£o: ' + idParts.join(' | '));
var ant = [];
    if (peso) ant.push('Peso: ' + peso + ' kg');
    if (altura) ant.push('Altura: ' + altura + ' cm');
    if (imc) ant.push('IMC: ' + imc);
    if (pbw) ant.push('PBW: ' + pbw + ' kg');
    linhas.push('Dados antropom√©tricos: ' + ant.join(' | '));
    linhas.push('');

    var hma = val('hma'), hpp = val('hpp'), cir = val('cirurgias'), med = val('med_dom');
    var alSim = qs('input[name="alergias_check"][value="sim"]');
    var alergiasSim = alSim ? alSim.checked : false;
    var alergiasTxt = val('alergias');

    if (hma) { linhas.push('HMA: ' + hma); linhas.push(''); }
    if (hpp) { linhas.push('HPP: ' + hpp); linhas.push(''); }
    if (cir) { linhas.push('Cirurgias pr√©vias: ' + cir); linhas.push(''); }
    if (med) { linhas.push('Medica√ß√µes domiciliares: ' + med); linhas.push(''); }
    linhas.push('Alergias: ' + (alergiasSim ? (alergiasTxt || 'Sim') : 'N√£o'));
    linhas.push('');
// Imagem
    var ecg = val('ecg_admissao'), rx = val('rx_torax_admissao'), pocus = val('pocus_admissao'), imgout = val('img_outros');
    if (ecg || rx || pocus || imgout) {
      linhas.push('Exames de imagem:');
      if (ecg) linhas.push('- ECG: ' + ecg);
      if (rx) linhas.push('- Rx t√≥rax: ' + rx);
      if (pocus) linhas.push('- POCUS: ' + pocus);
      if (imgout) linhas.push('- Outros: ' + imgout);
      linhas.push('');
    }

    // Laborat√≥rio
    var labs = [];
    function addLab(lbl, key){ var v = val(key); if (v) labs.push(lbl + ': ' + v); }
    addLab('Hb','hb'); addLab('Leuco','leuco'); addLab('Plaquetas','plaquetas');
    addLab('Ureia','ureia'); addLab('Creatinina','creatinina');
    addLab('Na','na'); addLab('K','k'); addLab('Mg','mg'); addLab('Ca','ca'); addLab('F√≥sforo','fosforo');
    addLab('INR','inr'); addLab('PTT','ptt'); addLab('BT','bt'); addLab('BD','bd'); addLab('TGO','tgo'); addLab('TGP','tgp');
var labOut = val('lab_outros');
    if (labs.length || labOut) {
      linhas.push('Laborat√≥rio:');
      if (labs.length) linhas.push('- ' + labs.join(' | '));
      if (labOut) linhas.push('- Outros relevantes: ' + labOut);
      linhas.push('');
    }

    var previos = val('exames_previos_relevantes');
    if (previos) { linhas.push('Exames pr√©vios relevantes: ' + previos); linhas.push(''); }
    var exameFisico = val('exame_fisico');
    if (exameFisico) { linhas.push('Exame f√≠sico: ' + exameFisico); linhas.push(''); }

    // Sistemas (resumo)
    var suporte = '';
    var respSel = qs('input[name="resp_suporte"]:checked');
    if (respSel) suporte = respSel.value;
var respDet = [];
    if (suporte === 'VM') {
      function addVM(lbl, key){ var v = val(key); if (v) respDet.push(lbl + ': ' + v); }
      addVM('Modo','vm_modo'); addVM('Pinsp/PS','vm_pinsp_ps'); addVM('VC','vm_vc'); addVM('FR','vm_fr');
      addVM('PEEP','vm_peep'); addVM('FiO2','vm_fio2'); addVM('Ppico','vm_ppico'); addVM('Pplat√¥','vm_pplato'); addVM('Drive','vm_drive');
    } else if (suporte === 'Venturi') {
      var vf = val('venturi_fio2'); if (vf) respDet.push('FiO2 Venturi: ' + vf);
    } else if (suporte === 'CN') {
      var cl = val('cn_litros'); if (cl) respDet.push('CN: ' + cl + ' L/min');
    } else if (suporte === 'MR') {
      var ml = val('mr_litros'); if (ml) respDet.push('MR: ' + ml + ' L/min');
    }
var gasChk = byId('chk_gaso');
    var gasMarcada = gasChk ? gasChk.checked : false;
    var gasDet = [];
    function addGas(lbl, key){ var v = val(key); if (v) gasDet.push(lbl + ': ' + v); }
    addGas('pH','gas_ph'); addGas('pO2','gas_po2'); addGas('pCO2','gas_pco2'); addGas('HCO3','gas_hco3'); addGas('BE','gas_be'); addGas('sO2','gas_so2');

    var hemoBase = [];
    function addH(lbl,key){ var v=val(key); if (v) hemoBase.push(lbl+': '+v); }
    addH('Ritmo','hemo_ritmo'); addH('PA','hemo_pa'); addH('FC','hemo_fc'); addH('SpO2','hemo_spo2');

    var drogas = [];
    function addD(lbl,key){ var v=val(key); if (v) drogas.push(lbl+': '+v); }
    addD('Dobutamina','dobutamina_dose'); addD('Milrinona','milrinona_dose'); addD('Noradrenalina','noradrenalina_dose'); addD('Vasopressina','vasopressina_dose');
var perf = [];
    function addP(lbl,key){ var v=val(key); if (v) perf.push(lbl+': '+v); }
    addP('Lactato','perf_lactato'); addP('SvcO2','perf_svco2'); addP('GapCO2','perf_gapco2');

    var foco = val('inf_foco');
    var atbs = [];
    for (var i=1;i<=3;i++){
      var a = val('inf_atb'+i);
      var d = val('inf_dia_atb'+i);
      var t = val('inf_total_atb'+i);
      if (a) {
        var extra = (d || t) ? (' (D' + (d||'') + ' de ' + (t||'') + ')') : '';
        atbs.push(a + extra);
      }
    }
var culturas = '';
    var cultSel = qs('input[name="inf_culturas"]:checked');
    if (cultSel && cultSel.value === 'sim') {
      var sites = [];
      if (qs('input[name="cult_urina"]') && qs('input[name="cult_urina"]').checked) sites.push('urina');
      if (qs('input[name="cult_hemo"]') && qs('input[name="cult_hemo"]').checked) sites.push('hemocultura');
      if (qs('input[name="cult_traqueal"]') && qs('input[name="cult_traqueal"]').checked) sites.push('secre√ß√£o traqueal');
      if (byId('cult_outros_chk') && byId('cult_outros_chk').checked) {
        var ot = val('cult_outros_txt');
        sites.push('outros' + (ot ? (' ('+ot+')') : ''));
      }
      culturas = 'Culturas: sim' + (sites.length ? (' ['+sites.join(', ')+']') : '');
    } else if (cultSel && cultSel.value === 'nao') {
      var mot = val('culturas_motivo');
      culturas = 'Culturas: n√£o' + (mot ? (' (motivo: '+mot+')') : '');
    }

    var glas = val('glasgow_total');
    var rass = val('rass_atual');
var glas = val('glasgow_total');
    var rass = val('rass_atual');

    var delirium = '';
    var delSel = qs('input[name="delirium"]:checked');
    if (delSel && delSel.value === 'nao') delirium = 'Delirium: n√£o';
    if (delSel && delSel.value === 'sim') {
      var tipos = [];
      if (byId('del_hiper') && byId('del_hiper').checked) tipos.push('hiperativo');
      if (byId('del_hipo') && byId('del_hipo').checked) tipos.push('hipoativo');
      if (byId('del_misto') && byId('del_misto').checked) tipos.push('misto');
      delirium = 'Delirium: sim' + (tipos.length ? (' ('+tipos.join(', ')+')' : '');
    }
var analgTxt = '';
    var analgSel = qs('input[name="analg_sed"]:checked');
    if (analgSel && analgSel.value === 'nao') analgTxt = 'Analgesia/seda√ß√£o: n√£o';
    if (analgSel && analgSel.value === 'sim') {
      var meds = [];
      var items = qsa('#analgesia_lista .med-item');
      for (var ii=0; ii<items.length; ii++) {
        var chk = items[ii].querySelector('input[type="checkbox"]');
        var span = items[ii].querySelector('span');
        var dose = items[ii].querySelector('input.dose-input');
        if (chk && chk.checked) {
          meds.push((span ? span.textContent.replace(/^\s+|\s+$/g,'') : '') + (dose && dose.value ? (' ('+dose.value+')') : ''));
        }
      }
      analgTxt = 'Analgesia/seda√ß√£o: sim' + (meds.length ? (' ['+meds.join('; ')+']') : '');
    }
var hasSist = suporte || respDet.length || (gasMarcada && gasDet.length) || hemoBase.length || drogas.length || perf.length || foco || atbs.length || culturas || glas || rass || delirium || analgTxt;
    if (hasSist) {
      linhas.push('Sistemas:');
      var respLine = [];
      if (suporte) respLine.push('Suporte: '+suporte);
      if (respDet.length) respLine.push(respDet.join(' | '));
      if (gasMarcada && gasDet.length) respLine.push('Gasometria: '+gasDet.join(' | '));
      if (respLine.length) linhas.push('- Respirat√≥rio: ' + respLine.join(' | '));

      var hemoLine = [];
      if (hemoBase.length) hemoLine.push(hemoBase.join(' | '));
      if (drogas.length) hemoLine.push('Drogas: '+drogas.join(' | '));
      if (perf.length) hemoLine.push('Perfus√£o: '+perf.join(' | '));
      if (hemoLine.length) linhas.push('- Hemodin√¢mica: ' + hemoLine.join(' | '));
var infLine = [];
      if (foco) infLine.push('Foco: '+foco);
      if (atbs.length) infLine.push('ATB: '+atbs.join(' | '));
      if (culturas) infLine.push(culturas);
      if (infLine.length) linhas.push('- Infec√ß√£o: ' + infLine.join(' | '));

      var neuroLine = [];
      if (glas) neuroLine.push('Glasgow: '+glas);
      if (rass) neuroLine.push('RASS: '+rass);
      if (delirium) neuroLine.push(delirium);
      if (analgTxt) neuroLine.push(analgTxt);
      if (neuroLine.length) linhas.push('- Neuro/Seda√ß√£o: ' + neuroLine.join(' | '));

      linhas.push('');
    }

    // Invasivos
    var inv = [];
    function addInv(lbl, txt){ if (txt) inv.push(lbl + ': ' + txt); }
var cvcLoc = val('cvc_local'), cvcDia = val('cvc_dia');
    if (cvcLoc || cvcDia) addInv('CVC', [cvcLoc, cvcDia ? ('dia '+cvcDia) : ''].join(' | ').replace(/\s\|\s$/,''));
    var artLoc = val('art_local'), artDia = val('art_dia');
    if (artLoc || artDia) addInv('Cateter arterial', [artLoc, artDia ? ('dia '+artDia) : ''].join(' | ').replace(/\s\|\s$/,''));
    var hdLoc = val('hd_local'), hdDia = val('hd_dia');
    if (hdLoc || hdDia) addInv('Cateter de HD', [hdLoc, hdDia ? ('dia '+hdDia) : ''].join(' | ').replace(/\s\|\s$/,''));
    var svd = val('svd_dia'); if (svd) addInv('SVD', 'dia ' + svd);
    var tot = val('tot_tqt_dia'); if (tot) addInv('TOT/TQT', 'dia ' + tot);
    var drenos = val('drenos_outros'); if (drenos) addInv('Drenos/outros', drenos);

    if (inv.length) {
      linhas.push('Invasivos/Dispositivos:');
      for (var iii=0; iii<inv.length; iii++) linhas.push('- ' + inv[iii]);
      linhas.push('');
    }
var diag = val('diagnostico_internacao');
    if (diag) { linhas.push('Diagn√≥stico(s) de interna√ß√£o: ' + diag); linhas.push(''); }

    var plano = val('plano_metas');
    if (plano) { linhas.push('Plano/Metas: ' + plano); linhas.push(''); }

    var ta = byId('textoGerado');
    if (ta) ta.value = linhas.join('\n');
    abrirPainelTexto();
  }

  function abrirEvolucao() {
    var area = byId('evolucaoArea');
    if (!area) return;

    area.classList.remove('hidden');

    // LIMPAR TODOS OS CAMPOS DA EVOLU√á√ÉO PRIMEIRO
    limparCamposEvolucao();

    // auto data/hora evolu√ß√£o (se vazio)
    var inp = area.querySelector('[name="evo_data"]');
    if (inp && !inp.value && typeof nowLocalDatetimeValue === 'function') inp.value = nowLocalDatetimeValue();
// Auto-preencher data/hora da evolu√ß√£o (somente se vazio)
    setNowIfEmpty('evo_data', area);
// Copiar identifica√ß√£o da ADMISS√ÉO (primeira vez)
    evoAutoFromAdmissao();
    
    // Copiar dados da √öLTIMA EVOLU√á√ÉO (se existir)
    copiarDadosEvolucaoAnterior();
    
    evoAtualizarDiaUTI();

    try { area.scrollIntoView({behavior:'smooth', block:'start'}); }
    catch(e) { area.scrollIntoView(true); }
  
    try { evoUpdateBigHeader(); } catch(e) {}
  }

  function limparCamposEvolucao() {
    var area = byId('evolucaoArea');
    if (!area) return;
    
    var els = qsa('#evolucaoArea input, #evolucaoArea textarea, #evolucaoArea select');
    for (var i=0; i<els.length; i++){
      var el = els[i];
      // N√£o limpa campos readonly (identifica√ß√£o vem da admiss√£o)
      if (el.readOnly || el.readonly) continue;
      
      if (el.type === 'checkbox' || el.type === 'radio') {
        el.checked = false;
      } else {
        el.value = '';
      }
    }
  }
function copiarDadosEvolucaoAnterior() {
    try {
      // Usa a chave espec√≠fica do leito
      var prev = localStorage.getItem('evolucao_last_' + ctiAtual + '_' + leitoAtual);
      if (!prev) return; // Primeira evolu√ß√£o, n√£o tem anterior
      
      var data = JSON.parse(prev);
      var area = byId('evolucaoArea');
      
      // LISTA DE CAMPOS A SEREM COPIADOS DA EVOLU√á√ÉO ANTERIOR
      var camposParaCopiar = [
        // Motivo da interna√ß√£o na UTI
        'evo_motivo_uti',
        // Problemas atuais
        'evo_problemas',
        // HPP
        'evo_comorbidades',
        // Cirurgias pr√©vias
        'evo_cirurgias',
        // Medica√ß√µes em uso
        'evo_meds',
        // Alergias
        'evo_alergias',
        // Infec√ß√£o
        'evo_inf_foco', 'evo_inf_atb1', 'evo_inf_dia_atb1', 'evo_inf_total_atb1',
        'evo_inf_atb2', 'evo_inf_dia_atb2', 'evo_inf_total_atb2',
        'evo_inf_atb3', 'evo_inf_dia_atb3', 'evo_inf_total_atb3',
        // Culturas (radio buttons e campos relacionados)
        'evo_culturas', 'evo_cult_pend_data', 'evo_cult_pos_txt',
        // Invasivos/Dispositivos
        'evo_cvc_local', 'evo_cvc_dia', 
        'evo_art_local', 'evo_art_dia',
        'evo_hd_local', 'evo_hd_dia', 
        'evo_svd_dia', 'evo_tot_tqt_dia',
        'evo_swanganz_local', 'evo_swanganz_dia', 
        'evo_bia', 'evo_bia_dia',
        'evo_mp_transv', 'evo_mp_transv_dia', 
        'evo_drenos_outros', 'evo_retirados',
        // Nutri√ß√£o (apenas campos de texto, n√£o checkboxes)
        'evo_dieta_tipo', 'evo_dieta_ml', 'evo_dieta_kcal', 'evo_dieta_ptn',
        'evo_npt_ml', 'evo_npt_kcal', 'evo_npt_ptn',
        // Impress√£o cl√≠nica
        'evo_impressao'
      ];
      
      // Copiar cada campo
      camposParaCopiar.forEach(function(nomeCampo){
        if (typeof data[nomeCampo] === 'undefined') return;
        
        var campo = area.querySelector('[name="'+nomeCampo+'"]');
        if (!campo) return;
        
        if (campo.type === 'radio') {
          // Para radio buttons, marca o que tem o mesmo valor
          var radios = area.querySelectorAll('[name="'+nomeCampo+'"]');
          radios.forEach(function(r) {
            if (r.value === data[nomeCampo]) {
              r.checked = true;
              // Dispara o evento onclick se existir
              if (r.onclick) r.onclick();
            }
          });
        } else if (campo.type === 'checkbox') {
          campo.checked = !!data[nomeCampo];
        } else {
          campo.value = data[nomeCampo] || '';
        }
      });
      
      // Reaplica os toggles condicionais para mostrar/esconder campos
      if (typeof evoToggleCulturas === 'function') evoToggleCulturas();
      
    } catch(e) {
      console.error('Erro ao copiar evolu√ß√£o anterior:', e);
    }
  }
function evoAtualizarDiaUTI() {
    var out = qs('#evolucaoArea [name="evo_dia_uti"]');
    if (!out) return;
    var admDT = val('datahora_admissao');
    var admD = val('data_admissao');
    var adm = admDT || admD;
    var evoEl = qs('#evolucaoArea [name="evo_data"]');
    var evoDT = evoEl ? evoEl.value : '';
    if (!adm) { out.value=''; return; }
    var admDate = parseLocalDateTime(adm);
    var evoDate = evoDT ? parseLocalDateTime(evoDT) : new Date();
    if (!admDate || !evoDate) { out.value=''; return; }
    var diffMs = evoDate.getTime() - admDate.getTime();
    var dia = Math.floor(diffMs / 86400000) + 1;
    out.value = (dia>0 ? String(dia) : '');
  }
// ===== Evolu√ß√£o di√°ria (ES5) =====
  function fecharEvolucao() {
    var area = byId('evolucaoArea');
    if (area) area.classList.add('hidden');
    
    // Limpar modo de edi√ß√£o
    if (typeof evolucaoEmEdicao !== 'undefined') {
      evolucaoEmEdicao = null;
    }
    var statusDiv = document.getElementById('status_evo_save');
    if (statusDiv) statusDiv.innerHTML = '';
  }

  function evoToggleResp(tipo) {
    var vm = byId('evo_resp_vm');
    var venturi = byId('evo_resp_venturi');
    var cn = byId('evo_resp_cn');
    var mr = byId('evo_resp_mr');
    if (!vm || !venturi || !cn || !mr) return;

    vm.classList.add('hidden');
    venturi.classList.add('hidden');
    cn.classList.add('hidden');
    mr.classList.add('hidden');
if (tipo === 'VM') vm.classList.remove('hidden');
    else if (tipo === 'Venturi') venturi.classList.remove('hidden');
    else if (tipo === 'CN') cn.classList.remove('hidden');
    else if (tipo === 'MR') mr.classList.remove('hidden');
    // Ar ambiente: n√£o abre nada
  }

  function evoToggleGasometria() {
    var chk = byId('evo_chk_gaso');
    var div = byId('evo_gaso_fields');
    if (!chk || !div) return;

    if (chk.checked) div.classList.remove('hidden');
    else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }
function evoToggleHemoDrug(drug) {
    var map = {
      dobutamina: { chk: 'evo_chk_dobutamina', div: 'evo_drug_dobutamina' },
      milrinona: { chk: 'evo_chk_milrinona', div: 'evo_drug_milrinona' },
      noradrenalina: { chk: 'evo_chk_noradrenalina', div: 'evo_drug_noradrenalina' },
      vasopressina: { chk: 'evo_chk_vasopressina', div: 'evo_drug_vasopressina' }
    };
    if (!map[drug]) return;

    var chk = byId(map[drug].chk);
    var div = byId(map[drug].div);
    if (!chk || !div) return;

    if (chk.checked) div.classList.remove('hidden');
    else {
      var input = div.querySelector('input');
      if (input) input.value = '';
      div.classList.add('hidden');
    }
  }

  function evoTogglePerfusao() {
    var chk = byId('evo_chk_perf');
    var div = byId('evo_perf_fields');
    if (!chk || !div) return;
if (chk.checked) div.classList.remove('hidden');
    else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }

  function evoToggleECG() {
    var sel = qs('input[name="evo_ecg_dia"]:checked');
    var wrap = byId('evo_ecg_txt_wrap');
    if (!wrap) return;
    if (sel && sel.value === 'sim') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }

  function evoToggleTRS() {
    var sel = qs('input[name="evo_trs"]:checked');
    var wrap = byId('evo_trs_tipo_wrap');
    if (!wrap) return;
    if (sel && sel.value === 'sim') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }
function evoToggleCulturas() {
    var sel = qs('input[name="evo_culturas"]:checked');
    var wrap = byId('evo_cult_pos_wrap');
    if (!wrap) return;
    if (sel && sel.value === 'positivas') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }

  function evoToggleTEV() {
    var sel = qs('input[name="evo_tev"]:checked');
    var wrap = byId('evo_tev_just_wrap');
    if (!wrap) return;
    if (sel && sel.value === 'nao') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }
function evoToggleInterconsulta(name, wrapId) {
    var sel = qs('input[name="'+name+'"]:checked');
    var wrap = byId(wrapId);
    if (!wrap) return;
    if (sel && sel.value === 'sim') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }

  function evoSetRenalPeriodo(horas) {
    var bh = byId('evo_bh_label');
    var diu = byId('evo_diurese_label');
    if (bh) bh.textContent = 'BH ' + horas + 'h';
    if (diu) diu.textContent = 'Diurese ' + horas + 'h';

    // marcar r√°dio correspondente
    var r = document.querySelector('input[name="evo_renal_periodo"][value="'+String(horas)+'"]');
    if (r) r.checked = true;
  }
function evoSyncRenalPeriodoDefault() {
    // Se o usu√°rio n√£o escolheu, define padr√£o pelo turno (diurna=24h, noturna=12h)
    var chosen = document.querySelector('input[name="evo_renal_periodo"]:checked');
    if (chosen) { evoSetRenalPeriodo(parseInt(chosen.value,10)); return; }

    var t = document.querySelector('input[name="evo_turno"]:checked');
    if (t && (t.value === 'Noturna' || t.value === 'noturna')) evoSetRenalPeriodo(12);
    else evoSetRenalPeriodo(24);
  }

  function evoCopiarIdentificacao() {
    evoAutoFromAdmissao();
    try { if (typeof evoAtualizarDiaUTI === 'function') evoAtualizarDiaUTI(); } catch(e) {}
    try { if (typeof evoApply === 'function') evoApply(); } catch(e) {}
  }

  function evoCopiarHPPDaAdmissao() {
    var area = byId('evolucaoArea');
    if (!area) return;

    function byName(n){ return document.querySelector('[name="'+n+'"]'); }
    function vName(n){ var el = byName(n); return el ? (el.value || '') : ''; }
var dstH = area.querySelector('[name="evo_comorbidades"]');
    var dstA = area.querySelector('[name="evo_alergias"]');
    var dstS = area.querySelector('[name="evo_cirurgias"]');

    if (dstH) dstH.value = vName('hpp');
    if (dstA) dstA.value = vName('alergias');
    if (dstS) dstS.value = vName('cirurgias');

    try { evoCalcularTFGeClCr && evoCalcularTFGeClCr(); } catch(e) {}
    try { evoUpdateBigHeader && evoUpdateBigHeader(); } catch(e) {}
  }

  function evoKey(turno) { return 'evolucao_' + (turno === 'Noturna' ? 'noturna' : 'diurna'); }
function evoKey(turno) { return 'evolucao_' + (turno === 'Noturna' ? 'noturna' : 'diurna'); }

  function evoCollect() {
    var data = {};
    var els = qsa('#evolucaoArea input, #evolucaoArea textarea, #evolucaoArea select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      var key = el.name || el.id;
      if (!key) continue;
      if (el.type === 'checkbox') data[key] = !!el.checked;
      else if (el.type === 'radio') {
        if (el.checked) data[key] = el.value;
        else if (typeof data[key] === 'undefined') data[key] = null;
      } else data[key] = el.value;
    }
    return data;
  }

  function evoApply(data) {
    if (!data) return;
    var els = qsa('#evolucaoArea input, #evolucaoArea textarea, #evolucaoArea select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      var key = el.name || el.id;
      if (!key || typeof data[key] === 'undefined') continue;
if (el.type === 'checkbox') el.checked = !!data[key];
      else if (el.type === 'radio') el.checked = (data[key] !== null && el.value === data[key]);
      else el.value = data[key] !== null ? data[key] : '';
    }

    // re-aplicar condicionais
    evoAtualizarLabelsRenal();

    var respSel = qs('input[name="evo_resp_suporte"]:checked');
    if (respSel) evoToggleResp(respSel.value);

    evoToggleGasometria();
    evoTogglePerfusao();
    evoToggleECG();
    evoToggleTRS();
    evoToggleCulturas();
    evoToggleTEV();

    evoToggleInterconsulta('evo_nefro','evo_nefro_txt_wrap');
    evoToggleInterconsulta('evo_cg','evo_cg_txt_wrap');
    evoToggleInterconsulta('evo_ccv','evo_ccv_txt_wrap');
    evoToggleInterconsulta('evo_vasc','evo_vasc_txt_wrap');

    // hemo drugs
    var drugs = ['dobutamina','milrinona','noradrenalina','vasopressina'];
    for (var d=0; d<drugs.length; d++) evoToggleHemoDrug(drugs[d]);
  }
function evoSalvar() {
    try {
      var turnoSel = qs('input[name="evo_turno"]:checked');
      var turno = turnoSel ? turnoSel.value : 'Diurna';
      var data = evoCollect();
      data._saved_at = (new Date()).toISOString();
      data._turno = turno;

      localStorage.setItem(evoKey(turno), JSON.stringify(data));
      localStorage.setItem('evolucao_last', JSON.stringify(data));

      var st = byId('status_evo_save');
      if (st) {
        st.textContent = 'Salvo ‚úî';
        setTimeout(function(){ st.textContent = ''; }, 2000);
      }
    } catch(e){}
  }

  function evoCarregarTurnoAtual() {
    try {
      var turnoSel = qs('input[name="evo_turno"]:checked');
      var turno = turnoSel ? turnoSel.value : 'Diurna';
      var raw = localStorage.getItem(evoKey(turno));
      if (!raw) return;
      evoApply(JSON.parse(raw));
    } catch(e){}
  }
function evoCopiarTurnoAnterior() {
    try {
      var raw = localStorage.getItem('evolucao_last');
      if (!raw) return;
      var data = JSON.parse(raw);
      // n√£o sobrescreve turno selecionado (o usu√°rio escolhe)
      var turnoSel = qs('input[name="evo_turno"]:checked');
      var turnoAtual = turnoSel ? turnoSel.value : 'Diurna';

      // copiar campos comuns
      evoApply(data);

      // ajustes de per√≠odo (diurna/noturna)
      evoAtualizarLabelsRenal();

      // se estiver indo para Noturna e houver dia de UTI num√©rico, manter (usu√°rio ajusta se necess√°rio)
      if (turnoAtual === 'Noturna') {
        var di = qs('[name="evo_dia_uti"]');
        if (di && data['evo_dia_uti']) di.value = data['evo_dia_uti'];
      }
// marcar turno atual visualmente (sem reescrever localStorage)
      var ts = qsa('input[name="evo_turno"]');
      for (var i=0;i<ts.length;i++) ts[i].checked = (ts[i].value === turnoAtual);
      evoAtualizarLabelsRenal();
    } catch(e){}
  }

  function evoAbrirPainelTexto() {
    var p = byId('painelTextoEvo');
    if (p) {
      p.classList.remove('hidden');
      try { p.scrollIntoView({behavior:'smooth', block:'start'}); } catch(e){ p.scrollIntoView(true); }
    }
  }

  function evoFecharPainelTexto() {
    var p = byId('painelTextoEvo');
    if (p) p.classList.add('hidden');
  }

  function evoCopiarTexto() {
    var ta = byId('textoGeradoEvo');
    if (!ta) return;
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); } catch(e){}
  }
function evoVal(nameOrId) {
    var el = qs('#evolucaoArea [name="'+nameOrId+'"]') || byId(nameOrId);
    if (!el) return '';
    if (el.type === 'checkbox') return el.checked ? 'Sim' : 'N√£o';
    if (el.type === 'radio') {
      var sel = qs('#evolucaoArea input[name="'+nameOrId+'"]:checked');
      return sel ? sel.value : '';
    }
    return (el.value || '').replace(/^\s+|\s+$/g,'');
  }

  
  function evoCalcularTFGeClCr() {
    var creatStr = evoVal('evo_creatinina');
    var idadeStr = evoVal('evo_idade');
    var pesoStr  = evoVal('evo_peso');
    var sexoStr  = evoVal('evo_sexo') || '';
    function toNum(s){ return parseFloat(String(s).replace(',', '.')); }
    var creat = toNum(creatStr);
    var idade = toNum(idadeStr);
    var peso  = toNum(pesoStr);

    var area = byId('evolucaoArea');
    if (!area) return;
    var tfgEl  = area.querySelector('[name="evo_tfg_ckd_epi"]');
    var clcrEl = area.querySelector('[name="evo_clcr_cg"]');
if (!(creat > 0) || !(idade > 0) || !(peso > 0)) {
      if (tfgEl) tfgEl.value = '';
      if (clcrEl) clcrEl.value = '';
      return;
    }

    var s = sexoStr.trim().toUpperCase();
    var isFem = (s === 'F' || s.indexOf('FEM') === 0);

    // CKD-EPI 2021 (sem fator de ra√ßa)
    var kappa = isFem ? 0.7 : 0.9;
    var alpha = isFem ? -0.241 : -0.302;
    var ratio = creat / kappa;
    var minPart = Math.min(ratio, 1);
    var maxPart = Math.max(ratio, 1);
    var eGFR = 142 * Math.pow(minPart, alpha) * Math.pow(maxPart, -1.200) *
               Math.pow(0.9938, idade) * (isFem ? 1.012 : 1);

    // Cockcroft-Gault (peso atual)
    var factor = isFem ? 0.85 : 1.0;
    var clCr = ((140 - idade) * peso * factor) / (72 * creat);

    function fmt(x){ return (isFinite(x) ? (Math.round(x*10)/10).toString() : ''); }
    if (tfgEl) tfgEl.value = fmt(eGFR);
    if (clcrEl) clcrEl.value = fmt(clCr);
  }
function evoCopiarMedAtual(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    var el = area.querySelector('[name="evo_meds"]');
    if (el && data.evo_meds) el.value = data.evo_meds;
  }catch(e){
    alert('Erro ao copiar medica√ß√µes: ' + e.message);
  }
}

function evoCopiarMotivoAnterior(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    var campo = area.querySelector('[name="evo_motivo_uti"]');
    if (campo && data.evo_motivo_uti) campo.value = data.evo_motivo_uti;
  }catch(e){
    alert('Erro ao copiar motivo: ' + e.message);
  }
}
function evoCopiarProblemasAnteriores(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    var campo = area.querySelector('[name="evo_problemas"]');
    if (campo && data.evo_problemas) campo.value = data.evo_problemas;
  }catch(e){
    alert('Erro ao copiar problemas: ' + e.message);
  }
}
function evoCopiarHPPAnterior(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    
    // Copiar comorbidades
    var campoComorbidades = area.querySelector('[name="evo_comorbidades"]');
    if (campoComorbidades && data.evo_comorbidades) campoComorbidades.value = data.evo_comorbidades;
    
    // Copiar cirurgias pr√©vias
    var campoCirurgias = area.querySelector('[name="evo_cirurgias"]');
    if (campoCirurgias && data.evo_cirurgias) campoCirurgias.value = data.evo_cirurgias;
    
    // Copiar baseline se existir
    var campoBaseline = area.querySelector('[name="evo_baseline"]');
    if (campoBaseline && data.evo_baseline) campoBaseline.value = data.evo_baseline;
  }catch(e){
    alert('Erro ao copiar HPP: ' + e.message);
  }
}
function evoCopiarAlergiasAnterior(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    var campo = area.querySelector('[name="evo_alergias"]');
    if (campo && data.evo_alergias) campo.value = data.evo_alergias;
  }catch(e){
    alert('Erro ao copiar alergias: ' + e.message);
  }
}
function evoCopiarInfeccaoAnterior(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    
    // Copiar todos os campos de infec√ß√£o (textos)
    var camposTexto = ['evo_inf_foco', 
                       'evo_inf_atb1', 'evo_inf_dia_atb1', 'evo_inf_total_atb1',
                       'evo_inf_atb2', 'evo_inf_dia_atb2', 'evo_inf_total_atb2',
                       'evo_inf_atb3', 'evo_inf_dia_atb3', 'evo_inf_total_atb3',
                       'evo_cult_pos_txt', 'evo_cult_pend_txt',
                       'evo_leuco', 'evo_pcr', 'evo_pct', 'evo_pct_data'];
    
    camposTexto.forEach(function(nomeCampo){
      var campo = area.querySelector('[name="'+nomeCampo+'"]');
      if (campo && data[nomeCampo]) campo.value = data[nomeCampo];
    });
    
    // Copiar campo de culturas (radio)
    if (data.evo_culturas) {
      var radios = area.querySelectorAll('input[name="evo_culturas"]');
      for (var i=0; i<radios.length; i++) {
        if (radios[i].value === data.evo_culturas) {
          radios[i].checked = true;
          // Mostrar campo apropriado
          if (data.evo_culturas === 'positivas') {
            evoToggleBox('evo_cult_pos_wrap', true);
            evoToggleBox('evo_cult_pend_wrap', false);
          } else if (data.evo_culturas === 'pendentes') {
            evoToggleBox('evo_cult_pos_wrap', false);
            evoToggleBox('evo_cult_pend_wrap', true);
          }
          break;
        }
      }
    }
  }catch(e){
    alert('Erro ao copiar infec√ß√£o: ' + e.message);
  }
}
function evoCopiarDispositivosAnterior(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    
    // Copiar todos os campos de dispositivos
    var campos = ['evo_cvc_local', 'evo_cvc_dia', 'evo_art_local', 'evo_art_dia',
                  'evo_hd_local', 'evo_hd_dia', 'evo_svd_dia', 'evo_tot_tqt_dia',
                  'evo_swanganz_local', 'evo_swanganz_dia', 'evo_bia', 'evo_bia_dia',
                  'evo_mp_transv', 'evo_mp_transv_dia', 'evo_drenos_outros', 'evo_retirados'];
    
    campos.forEach(function(nomeCampo){
      var campo = area.querySelector('[name="'+nomeCampo+'"]');
      if (campo && data[nomeCampo]) campo.value = data[nomeCampo];
    });
  }catch(e){
    alert('Erro ao copiar dispositivos: ' + e.message);
  }
}
function evoCopiarImpressaoAnterior(){
  try{
    var prev = localStorage.getItem('evolucao_last');
    if (!prev) {
      alert('Nenhuma evolu√ß√£o anterior encontrada. Salve uma evolu√ß√£o primeiro.');
      return;
    }
    var data = JSON.parse(prev);
    var area = byId('evolucaoArea');
    var campo = area.querySelector('[name="evo_impressao"]');
    if (campo && data.evo_impressao) campo.value = data.evo_impressao;
  }catch(e){
    alert('Erro ao copiar impress√£o: ' + e.message);
  }
}
function evoAtualizarHistorico(){
  var list = byId('evoHistoryList');
  if (!list) return;
  list.innerHTML = "";
  var keys = Object.keys(localStorage).filter(k => k.startsWith("evolucao_"));
  keys.forEach(k => {
    var data = JSON.parse(localStorage.getItem(k) || "{}");
    var btn = document.createElement("button");
    btn.textContent = data.data || k.replace("evolucao_", "");
    btn.style.marginRight = "6px";
    btn.onclick = function(){ evoCarregarEvolucao(k); };
    list.appendChild(btn);
  });
}

function evoCarregarEvolucao(key){
  var data = JSON.parse(localStorage.getItem(key) || "{}");
  if(!data) return;
  evoApply(data);
  try { evoUpdateBigHeader(); } catch(e){}
}
function evoGerarTexto() {
    var linhas = [];
    var turnoSel = qs('input[name="evo_turno"]:checked');
    var turno = turnoSel ? turnoSel.value : '';
    var data = evoVal('evo_data');
linhas.push('EVOLU√á√ÉO ' + (turno ? turno.toUpperCase() : ''));
    if (data) linhas.push('Data/hora: ' + data);
    linhas.push('');

    var nome = evoVal('evo_nome');
    var dia = evoVal('evo_dia_uti');
    var dx = evoVal('evo_dx_principal');
    var motivo = evoVal('evo_motivo_uti');
    linhas.push([nome && ('Nome: '+nome), dia && ('Dia UTI: '+dia), dx && ('Dx principal: '+dx)].filter(Boolean).join(' | '));
    linhas.push('');

    var comb = evoVal('evo_comorbidades');
    var base = evoVal('evo_baseline');
    var al = evoVal('evo_alergias');
    if (comb || base || al) {
      linhas.push('HPP:');
      if (comb) linhas.push('- Comorbidades: ' + comb);
      if (base) linhas.push('- Baseline: ' + base);
      if (al) linhas.push('- Alergias: ' + al);
      linhas.push('');
    }

    var prob = evoVal('evo_problemas');
    if (prob) { linhas.push('Problemas ativos:'); linhas.push(prob); linhas.push(''); }
// Respirat√≥rio
    var supSel = qs('input[name="evo_resp_suporte"]:checked');
    var sup = supSel ? supSel.value : '';
    var respDet = [];
    if (sup === 'VM') {
      function add(lbl, key){ var v=evoVal(key); if (v) respDet.push(lbl+': '+v); }
      add('Modo','evo_vm_modo'); add('Pinsp/PS','evo_vm_pinsp_ps'); add('VC','evo_vm_vc'); add('FR','evo_vm_fr');
      add('PEEP','evo_vm_peep'); add('FiO2','evo_vm_fio2'); add('Ppico','evo_vm_ppico'); add('Pplat√¥','evo_vm_pplato'); add('Drive','evo_vm_drive');
    } else if (sup === 'Venturi') {
      var vf = evoVal('evo_venturi_fio2'); if (vf) respDet.push('FiO2 Venturi: '+vf);
    } else if (sup === 'CN') {
      var cl = evoVal('evo_cn_litros'); if (cl) respDet.push('CN: '+cl+' L/min');
    } else if (sup === 'MR') {
      var ml = evoVal('evo_mr_litros'); if (ml) respDet.push('MR: '+ml+' L/min');
    }
    var gasChk = byId('evo_chk_gaso');
    var gasMarc = gasChk ? gasChk.checked : false;
    var gasDet = [];
    function addG(lbl,key){ var v=evoVal(key); if(v) gasDet.push(lbl+': '+v); }
    addG('pH','evo_gas_ph'); addG('pO2','evo_gas_po2'); addG('pCO2','evo_gas_pco2'); addG('HCO3','evo_gas_hco3'); addG('BE','evo_gas_be'); addG('sO2','evo_gas_so2');
if (sup || respDet.length || (gasMarc && gasDet.length)) {
      linhas.push('Respirat√≥rio: ' + [sup && ('Suporte: '+sup), respDet.length && respDet.join(' | '), (gasMarc && gasDet.length) && ('Gasometria: '+gasDet.join(' | '))].filter(Boolean).join(' | '));
      linhas.push('');
    }

    // Hemodin√¢mica
    var hemo = [];
    function addH(lbl,key){ var v=evoVal(key); if(v) hemo.push(lbl+': '+v); }
    addH('Ritmo','evo_hemo_ritmo'); addH('PA','evo_hemo_pa'); addH('FC','evo_hemo_fc'); addH('SpO2','evo_hemo_spo2');

    var drogas = [];
    function addD(lbl,key){ var v=evoVal(key); if(v) drogas.push(lbl+': '+v); }
    addD('Dobutamina','evo_dobutamina_dose'); addD('Milrinona','evo_milrinona_dose'); addD('Noradrenalina','evo_noradrenalina_dose'); addD('Vasopressina','evo_vasopressina_dose');
var perf = [];
    function addP(lbl,key){ var v=evoVal(key); if(v) perf.push(lbl+': '+v); }
    addP('Lactato','evo_perf_lactato'); addP('SvcO2','evo_perf_svco2'); addP('GapCO2','evo_perf_gapco2');

    var ecg = evoVal('evo_ecg_txt');
    if (hemo.length || drogas.length || perf.length || ecg) {
      var parts = [];
      if (hemo.length) parts.push(hemo.join(' | '));
      if (drogas.length) parts.push('Drogas: '+drogas.join(' | '));
      if (perf.length) parts.push('Perfus√£o: '+perf.join(' | '));
      if (ecg) parts.push('ECG: '+ecg);
      linhas.push('Hemodin√¢mica: ' + parts.join(' | '));
      linhas.push('');
    }
// Renal
    var renal = [];
    function addR(lbl,key){ var v=evoVal(key); if(v) renal.push(lbl+': '+v); }
    var bhLbl = (byId('evo_bh_label') ? byId('evo_bh_label').textContent : 'BH');
    var diuLbl = (byId('evo_diurese_label') ? byId('evo_diurese_label').textContent : 'Diurese');
    addR(bhLbl,'evo_bh_ml'); addR(diuLbl,'evo_diurese_ml'); addR('Ureia','evo_ureia'); addR('Creatinina','evo_creatinina');
    addR('TFG CKD-EPI','evo_tfg_ckd_epi'); addR('ClCr Cockcroft-Gault','evo_clcr_cg');
    addR('Na','evo_na'); addR('K','evo_k'); addR('Ca','evo_ca'); addR('Mg','evo_mg'); addR('F√≥sforo','evo_fosforo');
    var trsSel = qs('input[name="evo_trs"]:checked'); var trs = trsSel ? trsSel.value : '';
    var trsTipo = evoVal('evo_trs_tipo');
    if (trs) renal.push('TRS: '+trs + (trs==='sim' && trsTipo ? ' ('+trsTipo+')' : ''));
    if (renal.length) { linhas.push('Renal/Metab√≥lico: ' + renal.join(' | ')); linhas.push(''); }
var meds = evoVal('evo_meds');
    if (meds) {
        linhas.push('Medica√ß√µes em uso: ' + meds);
        linhas.push('');
    }
// Infec√ß√£o
    var foco = evoVal('evo_inf_foco');
    var atbs = [];
    for (var i=1;i<=3;i++){
      var a = evoVal('evo_inf_atb'+i);
      var d = evoVal('evo_inf_dia_atb'+i);
      var t = evoVal('evo_inf_total_atb'+i);
      if (a) atbs.push(a + ((d||t) ? (' (D'+(d||'')+' de '+(t||'')+')') : ''));
    }
    var cult = evoVal('evo_culturas');
    var cultPos = evoVal('evo_cult_pos_txt');
    var infParts = [];
    if (foco) infParts.push('Foco: '+foco);
    if (atbs.length) infParts.push('ATB: '+atbs.join(' | '));
    if (cult) infParts.push('Culturas: '+cult + (cult==='positivas' && cultPos ? ' ('+cultPos+')' : ''));
    var marc = [];
    function addM(lbl,key){ var v=evoVal(key); if(v) marc.push(lbl+': '+v); }
    addM('Leuco','evo_leuco'); addM('PCR','evo_pcr'); addM('PCT','evo_pct'); 
    var pctd = evoVal('evo_pct_data'); if (pctd) marc.push('Data PCT: '+pctd);
    if (marc.length) infParts.push('Marcadores: '+marc.join(' | '));
    if (infParts.length) { linhas.push('Infec√ß√£o: ' + infParts.join(' | ')); linhas.push(''); }
// Neuro (igual admiss√£o)
    var neuroParts = [];

    var gtot = evoVal('evo_glasgow_total');
    if (gtot) neuroParts.push('Glasgow: ' + gtot);

    var rass = evoVal('evo_rass_atual');
    if (rass) neuroParts.push('RASS: ' + rass);

    var delSel2 = qs('input[name="evo_delirium"]:checked');
    if (delSel2) {
      if (delSel2.value === 'nao') neuroParts.push('Delirium: n√£o');
      if (delSel2.value === 'sim') {
        var tipos = [];
        if (byId('evo_del_hiper') && byId('evo_del_hiper').checked) tipos.push('hiperativo');
        if (byId('evo_del_hipo') && byId('evo_del_hipo').checked) tipos.push('hipoativo');
        if (byId('evo_del_misto') && byId('evo_del_misto').checked) tipos.push('misto');
        neuroParts.push('Delirium: sim' + (tipos.length ? ' ('+tipos.join(', ')+')' : ''));
      }
    }
var analgSel2 = qs('input[name="evo_analg_sed"]:checked');
    if (analgSel2) {
      if (analgSel2.value === 'nao') neuroParts.push('Analgesia/seda√ß√£o: n√£o');
      if (analgSel2.value === 'sim') {
        var meds = [];
        var items = qsa('#evo_analgesia_lista .med-item');
        for (var ii=0; ii<items.length; ii++) {
          var chk = items[ii].querySelector('input[type="checkbox"]');
          var span = items[ii].querySelector('span');
          var dose = items[ii].querySelector('input.dose-input');
          if (chk && chk.checked) {
            meds.push((span ? span.textContent.replace(/^\s+|\s+$/g,'') : '') + (dose && dose.value ? (' ('+dose.value+')') : ''));
          }
        }
        neuroParts.push('Analgesia/seda√ß√£o: sim' + (meds.length ? ' ['+meds.join('; ')+']' : ''));
      }
    }

    if (neuroParts.length) { linhas.push('Neuro/Seda√ß√£o: ' + neuroParts.join(' | ')); linhas.push(''); }
// Hema/TEV
    var hema = [];
    function addHe(lbl,key){ var v=evoVal(key); if(v) hema.push(lbl+': '+v); }
    addHe('Hb','evo_hb'); addHe('Plaquetas','evo_plaquetas'); addHe('INR','evo_inr'); addHe('PTT','evo_ptt');
    var tev = evoVal('evo_tev'); 
    if (tev) hema.push('Profilaxia TEV: '+tev + (tev==='nao' && evoVal('evo_tev_just') ? ' ('+evoVal('evo_tev_just')+')' : ''));
    if (hema.length) { linhas.push('Hematol√≥gico/Trombose: ' + hema.join(' | ')); linhas.push(''); }
// Invasivos
    var inv = [];
    function addI(lbl, txt){ if (txt) inv.push(lbl+': '+txt); }
    addI('CVC', [evoVal('evo_cvc_local'), evoVal('evo_cvc_dia') && ('dia '+evoVal('evo_cvc_dia'))].filter(Boolean).join(' | '));
    addI('Cateter arterial', [evoVal('evo_art_local'), evoVal('evo_art_dia') && ('dia '+evoVal('evo_art_dia'))].filter(Boolean).join(' | '));
    addI('Cateter HD', [evoVal('evo_hd_local'), evoVal('evo_hd_dia') && ('dia '+evoVal('evo_hd_dia'))].filter(Boolean).join(' | '));
    if (evoVal('evo_svd_dia')) addI('SVD', 'dia '+evoVal('evo_svd_dia'));
    if (evoVal('evo_tot_tqt_dia')) addI('TOT/TQT', 'dia '+evoVal('evo_tot_tqt_dia'));
    if (evoVal('evo_drenos_outros')) addI('Drenos/outros', evoVal('evo_drenos_outros'));
    var ret = evoVal('evo_retirados'); if (ret) inv.push('Retirados: '+ret);
    if (inv.length) { linhas.push('Invasivos/Dispositivos:'); for (var ii=0; ii<inv.length; ii++) linhas.push('- '+inv[ii]); linhas.push(''); }
// Nutri√ß√£o
    var nut = [];
    function addNu(lbl,key){ var v=evoVal(key); if(v) nut.push(lbl+': '+v); }
    addNu('VET pleno kcal/dia','evo_vet_kcal');
    addNu('VET pleno prot g/dia','evo_vet_prot');
    addNu('Dieta','evo_dieta_select');
    addNu('Infus√£o mL/h','evo_dieta_mlh');
    addNu('Volume 24h mL','evo_dieta_ml20');
    addNu('Kcal 24h','evo_kcal_admin');
    addNu('Prote√≠na 24h','evo_prot_admin');
    addNu('Whey (g prot)','evo_whey_prot_g');
    addNu('% kcal atingido','evo_pct_kcal');
    addNu('% prot atingido','evo_pct_prot');
    
    // GI - checkboxes
    var vomitos = evoVal('evo_vomitos'); if (vomitos) nut.push('V√¥mitos: '+vomitos);
    var distensao = evoVal('evo_distensao'); if (distensao) nut.push('Distens√£o abd: '+distensao);
    var estase = evoVal('evo_estase'); 
    if (estase) {
      var estaseRes = evoVal('evo_estase_residuo');
      nut.push('Estase: '+estase + (estase==='sim' && estaseRes ? ' ('+estaseRes+')' : ''));
    }
    var hipo = evoVal('evo_hipo');
    if (hipo) {
      var hipoGlic = evoVal('evo_hipo_glicose');
      nut.push('Hipoglicemia: '+hipo + (hipo==='sim' && hipoGlic ? ' ('+hipoGlic+')' : ''));
    }
    var hiper = evoVal('evo_hiper');
    if (hiper) {
      var hiperIns = evoVal('evo_hiper_insulina');
      nut.push('Hiperglicemia: '+hiper + (hiper==='sim' && hiperIns ? ' ('+hiperIns+')' : ''));
    }
    var profUlcera = evoVal('evo_profilaxia_ulcera');
    if (profUlcera) nut.push('Profilaxia √∫lcera estresse: '+profUlcera);
    
    if (nut.length) { linhas.push('Nutri√ß√£o/GI: ' + nut.join(' | ')); linhas.push(''); }
var outros = evoVal('evo_outros_labs'); if (outros) { linhas.push('Outros exames relevantes:'); linhas.push(outros); linhas.push(''); }

    // Interconsultas
    function ic(nome, txtKey){ var v=evoVal(nome); var t=evoVal(txtKey); if (v==='sim') return 'sim' + (t ? ' ('+t+')' : ''); if (v==='nao') return 'n√£o'; return ''; }
    var ics = [];
    var i1 = ic('evo_nefro','evo_nefro_txt'); if (i1) ics.push('Nefro: '+i1);
    var i2 = ic('evo_cg','evo_cg_txt'); if (i2) ics.push('CG: '+i2);
    var i3 = ic('evo_ccv','evo_ccv_txt'); if (i3) ics.push('CCV: '+i3);
    var i4 = ic('evo_vasc','evo_vasc_txt'); if (i4) ics.push('Vascular: '+i4);
    if (ics.length) { linhas.push('Interconsultas: ' + ics.join(' | ')); linhas.push(''); }

    var imp = evoVal('evo_impressao'); if (imp) { linhas.push('Impress√£o cl√≠nica:'); linhas.push(imp); linhas.push(''); }
    var pl = evoVal('evo_plano_24h'); if (pl) { linhas.push('Plano/metas 24h:'); linhas.push(pl); linhas.push(''); }
var ta = byId('textoGeradoEvo');
    if (ta) ta.value = linhas.join('\n');
    evoAbrirPainelTexto();
  }


  // ===== Init =====
  document.addEventListener('DOMContentLoaded', function(){
    
    try { evoSyncRenalPeriodoDefault(); } catch(e) {}
// Auto-preencher data/hora da admiss√£o (somente se vazio)
    setNowIfEmpty('datahora_admissao');

    // Campo data (YYYY-MM-DD) existe apenas para compatibilidade interna (hidden)
    var da = byId('data_admissao') || qs('[name="data_admissao"]');
    var dth = byId('datahora_admissao');

    if (da && !da.value) {
      var now = nowLocalDatetimeValue();
      da.value = now.substr(0,10);
    }

    if (dth) {
      dth.addEventListener('change', function(){
        var v = dth.value || '';
        if (da && v.length >= 10) da.value = v.substr(0,10);
        atualizarDiasInternacao(); // Changed from evoAtualizarDiaUTI
        evoRenderHistory();
    evoUpdateBigHeader();
    bindEvoHeaderLiveUpdate();
  });
    }
// Auto-preencher data/hora da evolu√ß√£o (somente se vazio)
    var evoArea = byId('evolucaoArea');
    if (evoArea) setNowIfEmpty('evo_data', evoArea);

    var ed = qs('#evolucaoArea [name="evo_data"]');
    if (ed) {
      ed.addEventListener('change', evoAtualizarDiaUTI);
      ed.addEventListener('input', evoAtualizarDiaUTI);
    }

    // Carregar dados salvos
    carregarFormulario();
    evoCarregarTurnoAtual();

    // Auto-copiar para evolu√ß√£o e ajustar c√°lculos
    evoAutoFromAdmissao();
    evoAtualizarDiaUTI();
    evoApply();
  });
// ===== Evolu√ß√£o di√°ria: helpers (n√£o mexe na admiss√£o) =====
  function evoToggleBox(id, show) {
    var el = document.getElementById(id);
    if (!el) return;
    if (show) {
      el.classList.remove('hidden');
    } else {
      // limpar campos internos
      var inputs = el.querySelectorAll('input, textarea, select');
      for (var i=0;i<inputs.length;i++) {
        if (inputs[i].type === 'radio' || inputs[i].type === 'checkbox') inputs[i].checked = false;
        else inputs[i].value = '';
      }
      // esconder doses se existirem
      var doses = el.querySelectorAll('.dose-input');
      for (var j=0;j<doses.length;j++) {
        doses[j].classList.add('hidden');
        doses[j].value = '';
      }
      el.classList.add('hidden');
    }
  }
function evoToggleRespSuporte(valor) {
    evoToggleBox('evo_resp_vm', false);
    evoToggleBox('evo_resp_venturi', false);
    evoToggleBox('evo_resp_cn', false);
    evoToggleBox('evo_resp_mr', false);
    if (valor === 'VM') evoToggleBox('evo_resp_vm', true);
    if (valor === 'Venturi') evoToggleBox('evo_resp_venturi', true);
    if (valor === 'CN') evoToggleBox('evo_resp_cn', true);
    if (valor === 'MR') evoToggleBox('evo_resp_mr', true);
  }

  function evoToggleCulturas(valor) {
    evoToggleBox('evo_cult_pos_wrap', valor === 'positivas');
    evoToggleBox('evo_cult_pend_wrap', valor === 'pendentes');
  }

  function evoToggleDelirium(valor) {
    evoToggleBox('evo_delirium_tipos', valor === 'sim');
  }

  function evoToggleAnalgesia(valor) {
    evoToggleBox('evo_analgesia_lista', valor === 'sim');
  }
function evoCopiarIdentificacao() {
    // usa a fun√ß√£o j√° existente que copia dados da admiss√£o para a evolu√ß√£o (v57+)
    if (typeof evoAutoFromAdmissao === 'function') evoAutoFromAdmissao();
    // garantir data/hora se estiver vazio
    var area = document.getElementById('evolucaoArea');
    if (area) {
      var inp = area.querySelector('[name="evo_data"]');
      if (inp && !inp.value && typeof nowLocalDatetimeValue === 'function') inp.value = nowLocalDatetimeValue();
    }
    if (typeof evoAtualizarDiaUTI === 'function') evoAtualizarDiaUTI();
    if (typeof evoApply === 'function') evoApply();
  }


  // ===== Hist√≥rico de evolu√ß√µes (localStorage) =====
  function evoStorageKey() {
    var adm = byId('datahora_admissao');
    var base = (adm && adm.value) ? adm.value : 'sem_admissao';
    return 'INTENSIVALE_EVOHIST_' + base;
  }
function evoGetHistory() {
    try {
      var raw = localStorage.getItem(evoStorageKey());
      return raw ? JSON.parse(raw) : [];
    } catch(e) { return []; }
  }

  function evoSetHistory(arr) {
    try { localStorage.setItem(evoStorageKey(), JSON.stringify(arr)); } catch(e) {}
  }

  function evoCollectFields() {
    var area = byId('evolucaoArea');
    if (!area) return {};
    var data = {};
    var els = area.querySelectorAll('input, textarea, select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      if (!el.name) continue;
      if (el.type === 'radio') {
        if (el.checked) data[el.name] = el.value;
      } else if (el.type === 'checkbox') {
        data[el.name] = !!el.checked;
      } else {
        data[el.name] = el.value;
      }
    }
    return data;
  }

  function evoApplyFields(data) {
    var area = byId('evolucaoArea');
    if (!area || !data) return;
var els = area.querySelectorAll('input, textarea, select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      if (!el.name) continue;
      if (!(el.name in data)) continue;

      if (el.type === 'radio') {
        el.checked = (data[el.name] === el.value);
      } else if (el.type === 'checkbox') {
        el.checked = !!data[el.name];
      } else {
        el.value = data[el.name] || '';
      }
    }

    // re-aplicar toggles da evolu√ß√£o
    try { evoApply(); } catch(e) {}
  
    try { evoUpdateBigHeader(); } catch(e) {}
  }

  function evoRenderHistory() {
    var list = byId('evoHistoryList');
    if (!list) return;

    var hist = evoGetHistory();
    if (!hist.length) {
      list.innerHTML = '<div style="opacity:.75;">Nenhuma evolu√ß√£o salva ainda.</div>';
      return;
    }
var html = '';
    for (var i=0;i<hist.length;i++){
      var item = hist[i];
      var when = item.meta && item.meta.datahora ? item.meta.datahora : '(sem data/hora)';
      var turno = item.meta && item.meta.turno ? item.meta.turno : '';
      html += '<div class="evo-item">';
      html += '  <div class="meta">' + when + (turno ? ' ‚Äî ' + turno : '') + '<br><small>Evolu√ß√£o ' + (i+1) + '</small></div>';
      html += '  <div class="actions">';
      html += '    <button type="button" onclick="evoCarregarEvolucao(' + i + ')">Carregar</button>';
      html += '    <button type="button" onclick="evoImprimirEvolucao(' + i + ')">Imprimir</button>';
      html += '    <button type="button" onclick="evoExcluirEvolucao(' + i + ')" style="background:#fff;">Excluir</button>';
      html += '  </div>';
      html += '</div>';
    }
    list.innerHTML = html;
  }
function evoSalvarEvolucaoAtual() {
    var data = evoCollectFields();
    var turno = data.evo_turno || '';
    var dh = data.evo_data || '';
    var hist = evoGetHistory();
    hist.push({ meta: { datahora: dh, turno: turno }, data: data });
    evoSetHistory(hist);
    evoRenderHistory();
    
    // IMPORTANTE: Tamb√©m salvar em evolucao_last para os bot√µes "Copiar da evolu√ß√£o anterior"
    localStorage.setItem('evolucao_last', JSON.stringify(data));
    
    alert('Evolu√ß√£o salva no hist√≥rico.');
  }
function evoNovaEvolucao() {
    if (!confirm('Iniciar nova evolu√ß√£o?\n\nOs dados da evolu√ß√£o atual ser√£o salvos e os campos ser√£o limpos (mantendo identifica√ß√£o, HPP, dispositivos, ATBs e nutri√ß√£o).')) return;
    
    // Salvar evolu√ß√£o atual em evolucao_last antes de limpar
    try {
      var dataAtual = evoCollectFields();
      if (dataAtual && Object.keys(dataAtual).length > 0) {
        localStorage.setItem('evolucao_last', JSON.stringify(dataAtual));
      }
    } catch(e) {}

    var area = document.getElementById('evolucaoArea');
    if (!area) return;
// LISTA DE CAMPOS QUE DEVEM SER MANTIDOS ENTRE EVOLU√á√ïES
    var manterCampos = [
      // Identifica√ß√£o (readonly e copiados da admiss√£o)
      'evo_nome', 'evo_idade', 'evo_sexo', 'evo_peso', 'evo_altura', 'evo_imc', 'evo_pbw',
      // HPP / Comorbidades / Alergias / Cirurgias
      'evo_comorbidades', 'evo_baseline', 'evo_alergias', 'evo_cirurgias',
      // Diagn√≥stico e Motivo (geralmente n√£o mudam)
      'evo_dx_principal', 'evo_motivo_uti',
      // Problemas ativos (podem ser editados, mas geralmente se mant√™m)
      'evo_problemas',
      // Dispositivos invasivos (importante manter)
      'evo_cvc_local', 'evo_cvc_dia',
      'evo_art_local', 'evo_art_dia',
      'evo_hd_local', 'evo_hd_dia',
      'evo_svd_dia', 'evo_tot_tqt_dia',
      'evo_swanganz_local', 'evo_swanganz_dia',
      'evo_bia', 'evo_bia_dia',
      'evo_mp_transv', 'evo_mp_transv_dia',
      'evo_drenos_outros',
      // Antibi√≥ticos em uso (importante manter e ajustar dias)
      'evo_inf_foco',
      'evo_inf_atb1', 'evo_inf_dia_atb1', 'evo_inf_total_atb1',
      'evo_inf_atb2', 'evo_inf_dia_atb2', 'evo_inf_total_atb2',
      'evo_inf_atb3', 'evo_inf_dia_atb3', 'evo_inf_total_atb3',
      // Nutri√ß√£o (geralmente se mant√©m)
      'evo_vet_kcal', 'evo_vet_prot', 'evo_dieta_select',
      'evo_dieta_kcal_ml', 'evo_dieta_prot_ml', 'evo_dieta_mlh',
      // Outros exames relevantes (importante manter)
      'evo_outros_labs',
      // Impress√£o cl√≠nica (√†s vezes √∫til manter como base)
      'evo_impressao',
      // Medica√ß√µes em uso
      'evo_meds'
    ];
// Limpar campos edit√°veis da evolu√ß√£o, EXCETO os que devem ser mantidos
    var els = area.querySelectorAll('input, textarea, select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      if (!el.name) continue;
      if (el.hasAttribute('readonly')) continue;
      if (el.name === 'evo_turno') continue;
      
      // Se o campo estiver na lista de manter, PULA (n√£o limpa)
      if (manterCampos.indexOf(el.name) !== -1) continue;

      if (el.type === 'radio' || el.type === 'checkbox') el.checked = false;
      else el.value = '';
    }
// Fechar todos os blocos condicionais
    var toHide = [
      'evo_resp_vm','evo_resp_venturi','evo_resp_cn','evo_resp_mr',
      'evo_gaso_fields',
      'evo_pocus_pulm_desc','evo_rx_torax_desc',
      'evo_pocus_card_desc','evo_vexus_desc',
      'evo_ecg_txt_wrap',
      'evo_delirium_tipos','evo_analgesia_lista',
      'evo_trs_tipo_wrap',
      'evo_cult_pend_wrap','evo_cult_pos_wrap',
      'evo_nefro_txt_wrap','evo_cg_txt_wrap','evo_ccv_txt_wrap','evo_vasc_txt_wrap',
      'evo_estase_wrap', 'evo_hipo_wrap', 'evo_hiper_wrap'
    ];
    for (var k=0;k<toHide.length;k++) evoToggleBox(toHide[k], false);

    // Data/hora autom√°tica
    var inp = area.querySelector('[name="evo_data"]');
    if (inp && typeof nowLocalDatetimeValue === 'function') inp.value = nowLocalDatetimeValue();

    // Atualizar Dia de UTI
    try { evoAtualizarDiaUTI(); } catch(e) {}
    // Ir para o topo da evolu√ß√£o
    try { area.scrollIntoView({behavior:'smooth', block:'start'}); } catch(e) { area.scrollIntoView(true); }
  
    try { evoUpdateBigHeader(); } catch(e) {}
    
    alert('Nova evolu√ß√£o iniciada! Dados importantes foram mantidos.');
  }

  function evoCarregarEvolucao(idx) {
    var hist = evoGetHistory();
    if (!hist[idx]) return;
    evoApplyFields(hist[idx].data);
  }

  function evoExcluirEvolucao(idx) {
    var hist = evoGetHistory();
    if (!hist[idx]) return;
    if (!confirm('Excluir esta evolu√ß√£o do hist√≥rico?')) return;
    hist.splice(idx, 1);
    evoSetHistory(hist);
    evoRenderHistory();
  }
function evoImprimirEvolucaoAtual() {
    // imprime usando o gerador de texto, se existir
    var texto = '';
    try { texto = gerarTextoEvolucao ? gerarTextoEvolucao() : ''; } catch(e) {}
    if (!texto) {
      // fallback: imprimir campos essenciais
      var data = evoCollectFields();
      texto = JSON.stringify(data, null, 2);
    }
    var w = window.open('', '_blank');
    w.document.write('<pre style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; padding:20px;">' + 
      texto.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</pre>');
    w.document.close();
    w.focus();
    w.print();
  }
function evoImprimirEvolucao(idx) {
    var hist = evoGetHistory();
    if (!hist[idx]) return;
    var texto = '';
    // tentar montar texto carregando temporariamente (sem mexer na tela)
    texto = '';
    try {
      // se existir fun√ß√£o geradora que usa DOM, carregamos, geramos e voltamos
      var current = evoCollectFields();
      evoApplyFields(hist[idx].data);
      texto = gerarTextoEvolucao ? gerarTextoEvolucao() : '';
      evoApplyFields(current);
    } catch(e) {
      texto = JSON.stringify(hist[idx].data, null, 2);
    }
    var w = window.open('', '_blank');
    w.document.write('<pre style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; padding:20px;">' + 
      texto.replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</pre>');
    w.document.close();
    w.focus();
    w.print();
  }
function evoUpdateBigHeader() {
    var area = document.getElementById('evolucaoArea');
    if (!area) return;
    var dh = area.querySelector('[name="evo_data"]');
    var turno = area.querySelector('input[name="evo_turno"]:checked');
    var txt = document.getElementById('evoBigHeaderText');
    if (!txt) return;

    var dhv = dh && dh.value ? dh.value : '';
    // format datetime-local to dd/mm/yyyy hh:mm
    var showDh = dhv;
    try {
      if (dhv && dhv.includes('T')) {
        var d = new Date(dhv);
        if (!isNaN(d.getTime())) {
          var dd = String(d.getDate()).padStart(2,'0');
          var mm = String(d.getMonth()+1).padStart(2,'0');
          var yyyy = d.getFullYear();
          var hh = String(d.getHours()).padStart(2,'0');
          var mi = String(d.getMinutes()).padStart(2,'0');
          showDh = dd + '/' + mm + '/' + yyyy + ' ' + hh + ':' + mi;
        }
      }
    } catch(e) {}
var t = turno ? turno.value : '';
    var labelTurno = t ? (t === 'diurna' ? 'Diurna' : (t === 'noturna' ? 'Noturna' : t)) : '';
    txt.textContent = (showDh ? showDh : 'Sem data/hora') + (labelTurno ? ' ‚Äî ' + labelTurno : '');
  }

  function bindEvoHeaderLiveUpdate() {
    if (window.__evoHeaderBound) return;
    window.__evoHeaderBound = true;
    document.addEventListener('change', function(e){
      var t = e.target;
      if (!t) return;
      if (t.name === 'evo_data' || t.name === 'evo_turno') {
        evoUpdateBigHeader();
      }
      // also update when loading/copying
      if (t.name && t.name.startsWith('evo_')) {
        // lightweight update for date/turno changes
        if (t.name === 'evo_data') evoUpdateBigHeader();
      }
    }, true);
  }
function evoAutoFromAdmissao() {
    // Copiar identifica√ß√£o completa + HPP/Alergias/Cirurgias/Medica√ß√µes da admiss√£o
    function byName(n){ return document.querySelector('[name="'+n+'"]'); }
    function vName(n){ var el = byName(n); return el ? (el.value || '') : ''; }

    var area = byId('evolucaoArea');
    if (!area) return;

    function setByName(name, value){
      var el = area.querySelector('[name="'+name+'"]');
      if (el) el.value = value;
    }

    // Identifica√ß√£o
    setByName('evo_nome', vName('nome'));
    setByName('evo_idade', vName('idade'));
    setByName('evo_sexo', vName('sexo'));
    setByName('evo_peso', vName('peso'));
    setByName('evo_altura', vName('altura')); // cm
    setByName('evo_imc', vName('imc'));
    var pbwVal = vName('peso_predito');
    if (!pbwVal) {
      var pbwEl = byId('pbw');
      pbwVal = pbwEl ? (pbwEl.value || '') : '';
    }
    setByName('evo_pbw', pbwVal);
// HPP / Alergias / Cirurgias / Medica√ß√µes
    setByName('evo_comorbidades', vName('hpp'));
    setByName('evo_alergias', vName('alergias'));
    setByName('evo_cirurgias', vName('cirurgias'));
    setByName('evo_meds', vName('med_dom'));

    try { evoCalcularTFGeClCr && evoCalcularTFGeClCr(); } catch(e) {}
    try { evoUpdateBigHeader && evoUpdateBigHeader(); } catch(e) {}
  }


  // ===== Nutri√ß√£o / GI (Evolu√ß√£o di√°ria) =====
  var EVO_DIETAS = [
    { id: "fresubin_original", nome: "Fresubin Original (1,0 kcal/mL)", kcal_per_ml: 1.0, prot_per_ml: 0.038 },
    { id: "fresubin_hp_energy", nome: "Fresubin HP Energy (1,5 kcal/mL)", kcal_per_ml: 1.5, prot_per_ml: 0.075 },
    { id: "fresubin_2_hp", nome: "Fresubin 2.0 HP (2,0 kcal/mL)", kcal_per_ml: 2.0, prot_per_ml: 0.10 },

    { id: "custom", nome: "Personalizada (preencher kcal/mL e prot/mL)", kcal_per_ml: 0, prot_per_ml: 0 }
  ];
function evoInitDietas() {
    var sel = document.getElementById("evo_dieta_select");
    if (!sel) return;

    // evitar duplicar
    if (sel.options && sel.options.length) return;

    EVO_DIETAS.forEach(function(d) {
      var opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.nome;
      sel.appendChild(opt);
    });

    sel.addEventListener("change", function() {
      var isCustom = sel.value === "custom";
      evoToggleBox("evo_dieta_custom_wrap", isCustom);
      evoRecalcNutricao();
    });

    evoToggleBox("evo_dieta_custom_wrap", sel.value === "custom");
  }

  function evoGetSelectedDieta() {
    var sel = document.getElementById("evo_dieta_select");
    if (!sel) return null;
    for (var i = 0; i < EVO_DIETAS.length; i++) {
      if (EVO_DIETAS[i].id === sel.value) return EVO_DIETAS[i];
    }
    return null;
  }
function evoNum(val) {
    var n = parseFloat(String(val || "").replace(",", "."));
    return isNaN(n) ? 0 : n;
  }

  function evoRecalcNutricao() {
    var area = document.getElementById("evolucaoArea");
    if (!area) return;

    function g(name) {
      var el = area.querySelector('[name="' + name + '"]');
      return el ? el.value : "";
    }
    function s(name, value) {
      var el = area.querySelector('[name="' + name + '"]');
      if (el) el.value = value;
    }

    var vetKcal = evoNum(g("evo_vet_kcal"));
    var vetProt = evoNum(g("evo_vet_prot"));
    var mlh = evoNum(g("evo_dieta_mlh"));
    var ml20 = mlh * 20;

    s("evo_dieta_ml20", ml20 ? Math.round(ml20) : "");

    var dieta = evoGetSelectedDieta();
    var kcalML = 0, protML = 0;
    if (dieta) {
      if (dieta.id === "custom") {
        kcalML = evoNum(g("evo_dieta_kcal_ml"));
        protML = evoNum(g("evo_dieta_prot_ml"));
      } else {
        kcalML = dieta.kcal_per_ml;
        protML = dieta.prot_per_ml;
      }
    }

    var kcalAdmin = ml20 * kcalML;
    var protAdmin = ml20 * protML;

    var wheyProt = evoNum(g("evo_whey_prot_g"));
    protAdmin = protAdmin + wheyProt;

    s("evo_kcal_admin", kcalAdmin ? Math.round(kcalAdmin) : "");
    s("evo_prot_admin", protAdmin ? Math.round(protAdmin) : "");

    var pctK = (vetKcal > 0) ? (kcalAdmin / vetKcal) * 100 : 0;
    var pctP = (vetProt > 0) ? (protAdmin / vetProt) * 100 : 0;

    s("evo_pct_kcal", (vetKcal > 0 && kcalAdmin > 0) ? pctK.toFixed(1) : "");
    s("evo_pct_prot", (vetProt > 0 && protAdmin > 0) ? pctP.toFixed(1) : "");
  }
function evoBindNutricao() {
    var area = document.getElementById("evolucaoArea");
    if (!area) return;

    var names = [
      "evo_vet_kcal", "evo_vet_prot",
      "evo_dieta_mlh", "evo_dieta_kcal_ml", "evo_dieta_prot_ml",
      "evo_whey_prot_g"
    ];

    names.forEach(function(n) {
      var el = area.querySelector('[name="' + n + '"]');
      if (!el) return;
      el.addEventListener("input", evoRecalcNutricao);
      el.addEventListener("change", evoRecalcNutricao);
    });
  }

  document.addEventListener("DOMContentLoaded", function() {
    evoInitDietas();
    evoBindNutricao();
    evoRecalcNutricao();
  });
</script>

<script>
    // --- 1. FUN√á√ÉO: EVOLU√á√ÉO DI√ÅRIA (Turno Seguinte) ---
    function iniciarEvolucaoDiaria() {
        if(!confirm("Iniciar EVOLU√á√ÉO DI√ÅRIA?\n\nIsso manter√° o cadastro, hist√≥rico e diagn√≥sticos, limpando apenas os dados do momento (Sinais Vitais, Exames).")) return;
// LISTA VIP: Tudo o que estiver aqui ser√° MANTIDO.
        // Coloquei varia√ß√µes de nomes comuns para garantir que n√£o apague nada importante.
        const manterDados = [
            // Identifica√ß√£o
            "nome", "idade", "data_nasc", "sexo", "genero", "leito", "prontuario", "registro", "atendimento", "data_admissao", "datahora_admissao", "box", "setor", "peso", "altura", "imc", "pbw", "peso_predito",
            // Hist√≥rico (HPP) e Admiss√£o
            "motivo", "motivo_internacao", "queixa_principal", "evo_motivo_uti",
            "hpp", "historico", "antecedentes",
            "cirurgias", "cirurgias_previas",
            "alergias", "alergias_check",
            "med_uso", "medicacoes_casa", "medicacoes_previas",
            // Diagn√≥sticos e Impress√£o
            "hd", "hd_principal", "diagnostico", "diagnosticos",
            "impressao", "impressao_clinica", "conduta_fixa",
            // Problemas atuais
            "evo_problemas", "problemas_ativos",
            // Exames complementares relevantes (admiss√£o)
            "ecg_admissao", "rx_torax_admissao", "pocus_admissao", "img_outros",
            "exames_previos_relevantes", "lab_outros",
            // Dispositivos Invasivos e Antibi√≥ticos (Geralmente continuam)
            "inv_iot", "inv_tqt", "inv_cvc", "inv_svd", "inv_sne", "inv_pia", "inv_pam",
            "atb_em_uso", "atb_dia", "data_inicio_atb",
            // Nutri√ß√£o (Muitas vezes a dieta se mant√©m)
            "dieta_tipo", "via_alimentacao"
        ];
const inputs = document.querySelectorAll("input, textarea, select");

        inputs.forEach(el => {
            const nome = el.name; 
            const id = el.id;

            // 1. Se estiver na lista VIP, PULA (N√£o apaga)
            if (manterDados.includes(nome) || manterDados.includes(id)) return;

            // 2. Prote√ß√£o extra para dispositivos (campos que come√ßam com 'inv_')
            if ((nome && nome.startsWith("inv_")) || (id && id.startsWith("inv_"))) return;

            // 3. Se n√£o for protegido, LIMPA
            if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = false;
            } else {
                el.value = "";
            }
            // Retorna selects para o primeiro item
            if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
            }
        });
// Atualiza dias de interna√ß√£o
        atualizarDiasInternacao();
        
        // Simula cliques para recalcular (IMC, Dietas, etc)
        document.body.click(); 
        
        window.scrollTo(0, 0); 
        alert("Pronto para Evolu√ß√£o Di√°ria! Dados fixos preservados.");
    }

    // --- 2. CALCULAR DIAS AUTOMATICAMENTE ---
    function atualizarDiasInternacao() { // Changed from evoAtualizarDiaUTI
        const campoData = document.querySelector("input[name='data_admissao']") || document.getElementById("data_admissao");
        // Tenta achar o campo alvo (pode ser dias_internacao, dias_uti, etc)
        const campoDias = document.querySelector("input[name='dias_internacao']") || document.getElementById("dias_internacao") || document.querySelector("input[name='dias_uti']");
if (campoData && campoData.value && campoDias) {
            const dataAdm = new Date(campoData.value);
            const hoje = new Date();
            dataAdm.setHours(0,0,0,0);
            hoje.setHours(0,0,0,0);
            
            // Diferen√ßa em dias
            const diffDays = Math.ceil(Math.abs(hoje - dataAdm) / (1000 * 60 * 60 * 24)); 
            campoDias.value = diffDays; 
        }
    }
// --- 3. SALVAR E HIST√ìRICO ---
    function salvarEvolucao() {
        const nomePct = document.getElementsByName("nome")[0]?.value || "Paciente";
        const idUnico = "evo_" + new Date().getTime();
        
        const inputs = document.querySelectorAll("input, textarea, select");
        let conteudo = {};
        
        inputs.forEach(el => {
            // Ignorar seletores de CTI e Leito
            if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
            
            const chave = el.name || el.id;
            if(!chave) return;
            if (el.type === 'checkbox' || el.type === 'radio') {
                if (el.checked) conteudo[chave + '::' + el.value] = true;
                // Tamb√©m salvar o valor do radio/checkbox de forma simples
                if (el.checked && el.type === 'radio') conteudo[chave] = el.value;
            } else {
                conteudo[chave] = el.value;
            }
        });
// Usar prefixo do leito atual
        const idUnicoLeito = "evo_" + ctiAtual + "_" + leitoAtual + "_" + new Date().getTime();
        const pacote = { id: idUnicoLeito, data: new Date().toLocaleString(), nome: nomePct, cti: ctiAtual, leito: leitoAtual, dados: conteudo };
        
        // Salvar com ID √∫nico vinculado ao leito
        localStorage.setItem(idUnicoLeito, JSON.stringify(pacote));
        
        // Salvar tamb√©m no leito atual
        salvarLeitoAtual();
        
        // Atualizar lista de evolu√ß√µes
        listarEvolucoes();
        
        alert("Salvo com sucesso!");
    }
function novoPaciente() {
        if (!confirm("‚ö†Ô∏è ATEN√á√ÉO: Iniciar NOVO PACIENTE?\n\nTodos os dados atuais ser√£o apagados.\nAs evolu√ß√µes salvas na lista ser√£o mantidas.")) return;
        
        // Limpar todos os campos do formul√°rio
        document.querySelectorAll("input, textarea, select").forEach(el => {
            if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = false;
            } else {
                el.value = "";
            }
            if (el.tagName === 'SELECT') {
                el.selectedIndex = 0;
            }
        });
        
        // Limpar dados salvos do paciente atual (mas manter lista de evolu√ß√µes)
        localStorage.removeItem('admissao_cti_adulto');
        localStorage.removeItem('evolucao_last');
        
        // Esconder campos condicionais
        var toHide = document.querySelectorAll('.hidden');
        
        // Resetar c√°lculos
        if (typeof calcularIMC === 'function') calcularIMC();
        if (typeof calcularPBW === 'function') calcularPBW();
        
        // Preencher data/hora atual
        var dataAdm = document.getElementById('datahora_admissao');
        if (dataAdm) {
            var now = new Date();
            var ano = now.getFullYear();
            var mes = String(now.getMonth() + 1).padStart(2, '0');
            var dia = String(now.getDate()).padStart(2, '0');
            var hora = String(now.getHours()).padStart(2, '0');
            var min = String(now.getMinutes()).padStart(2, '0');
            dataAdm.value = ano + '-' + mes + '-' + dia + 'T' + hora + ':' + min;
        }
        
        // Ir para o topo da p√°gina
        window.scrollTo(0, 0);
        
        alert("Formul√°rio limpo! Pronto para novo paciente.");
    }
function listarEvolucoes() {
        const container = document.getElementById("lista_evolucoes");
        if (!container) return;
        
        container.innerHTML = "";
        
        // Filtrar evolu√ß√µes do leito atual
        const prefixoLeito = "evo_" + ctiAtual + "_" + leitoAtual + "_";
        const chaves = Object.keys(localStorage).filter(k => k.startsWith(prefixoLeito)).sort().reverse();
        
        if (chaves.length === 0) {
            container.innerHTML = "<div style='opacity:.6; font-size: 13px;'>Nenhuma evolu√ß√£o salva para este leito.</div>";
            return;
        }
        
        container.innerHTML = "<h4 style='color:#2e7d32; margin:5px 0 10px; font-size:14px;'>üìã Evolu√ß√µes deste Leito:</h4>";
chaves.forEach(key => {
            let item;
            try { item = JSON.parse(localStorage.getItem(key)); } catch(e){ return; }
            
            const div = document.createElement("div");
            div.style.cssText = "border: 1px solid #c8e6c9; border-radius: 6px; padding: 8px 12px; margin: 5px 0; font-size: 13px; display: flex; justify-content: space-between; align-items: center; background:#fff;";
            
            div.innerHTML = `
                <span><strong>${item.nome || 'Sem nome'}</strong> - ${item.data}</span>
                <div>
                    <button onclick="carregarEvolucao('${key}')" style="cursor:pointer; color:#1565c0; border:1px solid #1565c0; background:#e3f2fd; padding: 4px 10px; border-radius: 4px; margin-right: 5px;">Abrir</button>
                    <button onclick="deletarEvolucao('${key}')" style="cursor:pointer; color:#c62828; border:1px solid #c62828; background:#ffebee; padding: 4px 10px; border-radius: 4px;">Excluir</button>
                </div>
            `;
            container.appendChild(div);
        });
    }
function carregarEvolucao(key) {
        if(!confirm("Carregar esta evolu√ß√£o?\n\nOs dados atuais ser√£o substitu√≠dos.")) return;
        
        try {
            const item = JSON.parse(localStorage.getItem(key));
            const dados = item.dados;
            
            // Limpar antes de carregar
            document.querySelectorAll("input, textarea, select").forEach(el => {
                if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
                if(el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                else el.value = "";
                if(el.tagName === 'SELECT') el.selectedIndex = 0;
            });
// Carregar dados
            for (const [chave, valor] of Object.entries(dados)) {
                if (chave.includes("::")) {
                    const [nome, val] = chave.split("::");
                    let el = document.querySelector(`input[name="${nome}"][value="${val}"]`);
                    if (el) { el.checked = true; if(el.onclick) el.onclick(); }
                } else {
                    let el = document.getElementsByName(chave)[0] || document.getElementById(chave);
                    if (el && el.id !== 'seletorCTI' && el.id !== 'seletorLeito') { 
                        el.value = valor; 
                        if(el.onchange) el.onchange(); 
                    }
                }
            }
            
            // Atualizar c√°lculos
            if(typeof calcularIMC === 'function') calcularIMC();
            if(typeof calcularPBW === 'function') calcularPBW();
            
            alert("Evolu√ß√£o carregada!");
        } catch(e) {
            alert("Erro ao carregar: " + e.message);
        }
    }
function deletarEvolucao(key) {
        if(confirm("Excluir esta evolu√ß√£o?")) {
            localStorage.removeItem(key);
            listarEvolucoes();
        }
    }

    // Fun√ß√£o para obter evolu√ß√µes do leito atual (para usar na alta)
    function obterEvolucoesLeito() {
        const prefixoLeito = "evo_" + ctiAtual + "_" + leitoAtual + "_";
        const chaves = Object.keys(localStorage).filter(k => k.startsWith(prefixoLeito));
        const evolucoes = [];
        
        chaves.forEach(key => {
            try {
                const item = JSON.parse(localStorage.getItem(key));
                evolucoes.push(item);
            } catch(e) {}
        });
        
        return evolucoes;
    }
// Fun√ß√£o para limpar evolu√ß√µes do leito atual
    function limparEvolucoesLeito() {
        const prefixoLeito = "evo_" + ctiAtual + "_" + leitoAtual + "_";
        const chaves = Object.keys(localStorage).filter(k => k.startsWith(prefixoLeito));
        
        chaves.forEach(key => {
            localStorage.removeItem(key);
        });
    }

    // Listar evolu√ß√µes ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        listarEvolucoes();
    });
// --- 4. EXPORTAR PDF ---
    function exportarPDF() {
        const elemento = document.body;
        const nome = document.getElementsByName("nome")[0]?.value || "Paciente";
        const agora = new Date();
        const dataStr = agora.getDate().toString().padStart(2, '0') + "-" + (agora.getMonth()+1).toString().padStart(2, '0') + "-" + agora.getFullYear();
        const horaStr = agora.getHours() + "h" + agora.getMinutes();
        
        const opt = {
          margin:       0.3,
          filename:     `Evolucao_${nome}_${dataStr}_${horaStr}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        const controles = document.querySelector('.no-print');
        if(controles) controles.style.display = 'none';
html2pdf().set(opt).from(elemento).save().then(() => {
            if(controles) controles.style.display = 'block';
        });
    }

    listarEvolucoes();

// ========== SISTEMA DE CTI / LEITOS / ALTAS COM FIREBASE ==========

var leitosCTI1 = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
var leitosCTI2 = [1,2,3,4,5,6,7,8,9,10,11,12,13,15,16,18,19,20]; // Sem 14 e 17

var ctiAtual = 'CTI1';
var leitoAtual = 1;

// ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========
function fazerLogin() {
    var email = document.getElementById('loginEmail').value;
    var senha = document.getElementById('loginPassword').value;
    var errorDiv = document.getElementById('loginError');
    
    if (!email || !senha) {
        errorDiv.textContent = 'Preencha e-mail e senha.';
        return;
    }
    
    errorDiv.textContent = 'Entrando...';
    
    window.auth.signInWithEmailAndPassword(email, senha) // Acessa auth via window
        .then(function(userCredential) {
            errorDiv.textContent = '';
        })
        .catch(function(error) {
            console.error('Erro login:', error);
            if (error.code === 'auth/user-not-found') {
                errorDiv.textContent = 'Usu√°rio n√£o encontrado.';
            } else if (error.code === 'auth/wrong-password') {
                errorDiv.textContent = 'Senha incorreta.';
            } else if (error.code === 'auth/invalid-email') {
                errorDiv.textContent = 'E-mail inv√°lido.';
            } else {
                errorDiv.textContent = 'Erro: ' + error.message;
            }
        });
}
function fazerLogout() {
    if (confirm('Deseja realmente sair?')) {
        window.auth.signOut(); // Acessa auth via window
    }
}
// Listener de mudan√ßa de autentica√ß√£o - AGORA EST√Å DENTRO DO M√ìDULO TYPE="MODULE"
// auth.onAuthStateChanged j√° est√° adaptado l√°.

function mostrarSistema(nomeUsuario) {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    // Atualizar info do usu√°rio
    var userInfoDiv = document.getElementById('userInfoDisplay');
    if (userInfoDiv) {
        userInfoDiv.innerHTML = 'üë§ ' + nomeUsuario + ' <button onclick="fazerLogout()" style="margin-left: 10px;">Sair</button>';
    }
    
    // Mostrar bot√µes de admin
    if (window.isAdmin) { // Acessa isAdmin via window
        var adminBtns = document.querySelectorAll('.admin-only');
        adminBtns.forEach(function(btn) {
            btn.style.display = 'inline-block';
        });
    }
    
    // Testar conex√£o com Firestore
    testarConexaoFirebase();
    
    // Inicializar sistema
    atualizarLeitos();
    iniciarListenerTempoReal();
}
function testarConexaoFirebase() {
    // Tenta ler uma cole√ß√£o para verificar se tem permiss√£o
    window.db.collection('leitos').limit(1).get() // Acessa db via window
        .then(function() {
            console.log('‚úÖ Conex√£o Firebase OK');
            atualizarSyncStatus('ok');
        })
        .catch(function(error) {
            console.error('‚ùå Erro Firebase:', error);
            atualizarSyncStatus('error');
            
            // Mostrar erro detalhado
            var msg = 'Erro de conex√£o com o banco de dados:\n\n';
            if (error.code === 'permission-denied') {
                msg += 'PERMISS√ÉO NEGADA\n\nPoss√≠veis causas:\n';
                msg += '1. Regras do Firestore n√£o configuradas\n';
                msg += '2. Dom√≠nio n√£o autorizado no Firebase\n\n';
                msg += 'Acesse o Firebase Console para corrigir.';
            } else {
                msg += error.message;
            }
            alert(msg);
        });
}
// ========== FUN√á√ïES DE SINCRONIZA√á√ÉO COM FIREBASE ==========

function iniciarListenerTempoReal() {
    // Listener para leitos
    window.db.collection('leitos').onSnapshot(function(snapshot) { // Acessa db via window
        // Atualizar lista de leitos quando houver mudan√ßas
        atualizarSelectLeitos();
        atualizarSyncStatus('ok');
    }, function(error) {
        console.error('Erro no listener:', error);
        atualizarSyncStatus('error');
    });
}

function atualizarSyncStatus(status) {
    var syncDiv = document.getElementById('syncStatus');
    if (!syncDiv) return;
    
    if (status === 'ok') {
        syncDiv.className = 'sync-status sync-ok';
        syncDiv.textContent = '‚úì Sincronizado';
    } else if (status === 'error') {
        syncDiv.className = 'sync-status sync-error';
        syncDiv.textContent = '‚úó Erro de conex√£o';
    } else if (status === 'pending') {
        syncDiv.className = 'sync-status sync-pending';
        syncDiv.textContent = '‚è≥ Salvando...';
    }
}
function getChaveLeitoFirebase() {
    return ctiAtual + '_' + leitoAtual;
}
// Salvar leito no Firebase
function salvarLeitoAtual() {
    var inputs = document.querySelectorAll("input, textarea, select");
    var conteudo = {};
    
    inputs.forEach(function(el) {
        if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
        if (el.id === 'loginEmail' || el.id === 'loginPassword') return;
        
        var chave = el.name || el.id;
        if (!chave) return;
        
        if (el.type === 'checkbox' || el.type === 'radio') {
            if (el.checked) {
                conteudo[chave + '::' + el.value] = true;
                if (el.type === 'radio') conteudo[chave] = el.value;
            }
        } else {
            conteudo[chave] = el.value;
        }
    });
    
    // Adicionar metadados
    conteudo._ultimaAtualizacao = new Date().toISOString();
    conteudo._atualizadoPor = window.currentUser ? window.currentUser.email : 'desconhecido'; // Acessa currentUser via window
    
    atualizarSyncStatus('pending');
    
    // Salvar no Firebase
    window.db.collection('leitos').doc(getChaveLeitoFirebase()).set(conteudo) // Acessa db via window
        .then(function() {
            atualizarSyncStatus('ok');
        })
        .catch(function(error) {
            console.error('Erro ao salvar:', error);
            atualizarSyncStatus('error');
            // Fallback para localStorage
            localStorage.setItem('LEITO_' + ctiAtual + '_' + leitoAtual, JSON.stringify(conteudo));
        });
}
// Carregar leito do Firebase
function carregarLeito() {
    var chave = getChaveLeitoFirebase();
    
    // Limpar formul√°rio primeiro
    document.querySelectorAll("input, textarea, select").forEach(function(el) {
        if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
        if (el.id === 'loginEmail' || el.id === 'loginPassword') return;
        
        if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
        } else {
            el.value = "";
        }
        if (el.tagName === 'SELECT') {
            el.selectedIndex = 0;
        }
    });
    
    window.db.collection('leitos').doc(chave).get() // Acessa db via window
        .then(function(doc) {
            if (!doc.exists) {
                // Leito vazio
                preencherDataHoraAtual();
                atualizarStatusLeito('Leito vazio');
                listarEvolucoes();
                return;
            }
            
            var conteudo = doc.data();
            aplicarDadosFormulario(conteudo);
            
            var nomePaciente = conteudo.nome || 'Sem nome';
            atualizarStatusLeito('Paciente: ' + nomePaciente);
            listarEvolucoes();
            atualizarDiasInternacao();
        })
        .catch(function(error) {
            console.error('Erro ao carregar:', error);
            atualizarStatusLeito('Erro ao carregar');
            // Tentar carregar do localStorage como fallback
            var dadosLocal = localStorage.getItem('LEITO_' + ctiAtual + '_' + leitoAtual);
            if (dadosLocal) {
                try {
                    aplicarDadosFormulario(JSON.parse(dadosLocal));
                } catch(e) {}
            }
        });
}
function aplicarDadosFormulario(conteudo) {
    // Aplicar campos com ::
    for (var chaveItem in conteudo) {
        if (chaveItem.includes('::')) {
            var partes = chaveItem.split('::');
            var nome = partes[0];
            var valor = partes[1];
            var el = document.querySelector('input[name="'+nome+'"][value="'+valor+'"]');
            if (el) el.checked = true;
        }
    }
    
    // Aplicar demais campos
    document.querySelectorAll("input, textarea, select").forEach(function(el) {
        if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
        if (el.id === 'loginEmail' || el.id === 'loginPassword') return;
        
        var key = el.name || el.id;
        if (!key || typeof conteudo[key] === 'undefined') return;
        
        if (el.type === 'checkbox') {
            el.checked = !!conteudo[key];
        } else if (el.type === 'radio') {
            el.checked = (conteudo[key] !== null && el.value === conteudo[key]);
        } else {
            el.value = conteudo[key] !== null && conteudo[key] !== undefined ? conteudo[key] : '';
        }
    });
    
    // Recalcular
    if (typeof calcularIMC === 'function') calcularIMC();
    if (typeof calcularPBW === 'function') calcularPBW();
    
    // Ativar toggles dos campos condicionais
    ativarTogglesCondicionais();
}
function ativarTogglesCondicionais() {
    // Transfus√µes
    ['ch', 'plaq', 'plasma', 'crio'].forEach(function(tipo) {
        var chk = document.getElementsByName('evo_transf_' + tipo)[0];
        var qtd = document.getElementById('evo_transf_' + tipo + '_qtd');
        if (chk && qtd) {
            qtd.style.display = chk.checked ? 'inline-block' : 'none';
        }
    });
    
    // Neurol√≥gico (Doppler, Brain4care)
    ['doppler', 'brain4care'].forEach(function(tipo) {
        var chk = document.getElementsByName('evo_' + tipo + '_check')[0];
        var wrap = document.getElementById('evo_' + tipo + '_wrap');
        if (chk && wrap) {
            if (chk.checked) wrap.classList.remove('hidden');
            else wrap.classList.add('hidden');
        }
    });
    
    // Hemodin√¢mico (Swan Ganz, Marcapasso, esCCO)
    ['swanganz', 'marcapasso', 'escco'].forEach(function(tipo) {
        var chk = document.getElementsByName('evo_' + tipo + '_check')[0];
        var wrap = document.getElementById('evo_' + tipo + '_wrap');
        if (chk && wrap) {
            if (chk.checked) wrap.classList.remove('hidden');
            else wrap.classList.add('hidden');
        }
    });
    
    // Delirium
    var delChk = document.querySelector('input[name="evo_delirium"][value="sim"]');
    var delWrap = document.getElementById('evo_delirium_tipos');
    if (delChk && delWrap) {
        if (delChk.checked) delWrap.classList.remove('hidden');
        else delWrap.classList.add('hidden');
    }
    
    // Analgesia/seda√ß√£o
    var analgChk = document.querySelector('input[name="evo_analg_sed"][value="sim"]');
    var analgWrap = document.getElementById('evo_analgesia_lista');
    if (analgChk && analgWrap) {
        if (analgChk.checked) analgWrap.classList.remove('hidden');
        else analgWrap.classList.add('hidden');
    }
    
    // Medica√ß√µes (dose inputs)
    var meds = ['dipirona', 'tramadol', 'tylex', 'metadona', 'morfina', 'gabapentina', 
                'haloperidol', 'quetiapina', 'risperidona', 'ketamina', 'midazolam', 
                'fentanil', 'remifentanil', 'precedex', 'propofol', 'rocuronio', 'cisatracurio'];
    meds.forEach(function(med) {
        var chk = document.getElementById('evo_med_' + med);
        var dose = document.getElementById('dose_evo_med_' + med);
        if (chk && dose) {
            if (chk.checked) dose.classList.remove('hidden');
            else dose.classList.add('hidden');
        }
    });
    
    // Drogas vasoativas
    var dvas = ['dobutamina', 'milrinona', 'noradrenalina', 'vasopressina'];
    dvas.forEach(function(dva) {
        var chk = document.getElementById('evo_chk_' + dva);
        var div = document.getElementById('evo_drug_' + dva);
        if (chk && div) {
            if (chk.checked) div.classList.remove('hidden');
            else div.classList.add('hidden');
        }
    });
    
    // Perfus√£o
    var perfChk = document.getElementById('evo_chk_perf');
    var perfFields = document.getElementById('evo_perf_fields');
    if (perfChk && perfFields) {
        if (perfChk.checked) perfFields.classList.remove('hidden');
        else perfFields.classList.add('hidden');
    }
    
    // ECG do dia
    var ecgChk = document.querySelector('input[name="evo_ecg_dia"][value="sim"]');
    var ecgWrap = document.getElementById('evo_ecg_txt_wrap');
    if (ecgChk && ecgWrap) {
        if (ecgChk.checked) ecgWrap.classList.remove('hidden');
        else ecgWrap.classList.add('hidden');
    }
    
    // POCUS card√≠aco
    var pocusChk = document.querySelector('input[name="evo_pocus_card"][value="sim"]');
    var pocusWrap = document.getElementById('evo_pocus_card_desc');
    if (pocusChk && pocusWrap) {
        if (pocusChk.checked) pocusWrap.classList.remove('hidden');
        else pocusWrap.classList.add('hidden');
    }
    
    // VExUS
    var vexusChk = document.querySelector('input[name="evo_vexus"][value="sim"]');
    var vexusWrap = document.getElementById('evo_vexus_desc');
    if (vexusChk && vexusWrap) {
        if (vexusChk.checked) vexusWrap.classList.remove('hidden');
        else vexusWrap.classList.add('hidden');
    }
    
    // Profilaxia TEV
    var tevChk = document.querySelector('input[name="evo_tev"][value="nao"]');
    var tevWrap = document.getElementById('evo_tev_just_wrap');
    if (tevChk && tevWrap) {
        if (tevChk.checked) tevWrap.classList.remove('hidden');
        else tevWrap.classList.add('hidden');
    }
    
    // Respirat√≥rio
    var respRadios = document.querySelectorAll('input[name="evo_suporte_resp"]');
    respRadios.forEach(function(radio) {
        if (radio.checked) {
            var tipo = radio.value;
            var vm = document.getElementById('evo_resp_vm');
            var venturi = document.getElementById('evo_resp_venturi');
            var cn = document.getElementById('evo_resp_cn');
            var mr = document.getElementById('evo_resp_mr');
            
            if (vm) vm.classList.add('hidden');
            if (venturi) venturi.classList.add('hidden');
            if (cn) cn.classList.add('hidden');
            if (mr) mr.classList.add('hidden');
            
            if (tipo === 'VM' && vm) vm.classList.remove('hidden');
            else if (tipo === 'Venturi' && venturi) venturi.classList.remove('hidden');
            else if (tipo === 'CN' && cn) cn.classList.remove('hidden');
            else if (tipo === 'MR' && mr) mr.classList.remove('hidden');
        }
    });
    
    // Gasometria
    var gasoChk = document.getElementById('evo_chk_gaso');
    var gasoFields = document.getElementById('evo_gaso_fields');
    if (gasoChk && gasoFields) {
        if (gasoChk.checked) gasoFields.classList.remove('hidden');
        else gasoFields.classList.add('hidden');
    }
    
    // Rx t√≥rax
    var rxChk = document.querySelector('input[name="evo_rx_torax"][value="sim"]');
    var rxWrap = document.getElementById('evo_rx_torax_desc');
    if (rxChk && rxWrap) {
        if (rxChk.checked) rxWrap.classList.remove('hidden');
        else rxWrap.classList.add('hidden');
    }
    
    // Di√°lise
    var dialiseChk = document.querySelector('input[name="evo_dialise"][value="sim"]');
    var dialiseWrap = document.getElementById('evo_dialise_campos');
    if (dialiseChk && dialiseWrap) {
        if (dialiseChk.checked) dialiseWrap.classList.remove('hidden');
        else dialiseWrap.classList.add('hidden');
    }
}
function preencherDataHoraAtual() {
    var dataAdm = document.getElementById('datahora_admissao');
    if (dataAdm) {
        var now = new Date();
        dataAdm.value = now.getFullYear() + '-' + 
            String(now.getMonth()+1).padStart(2,'0') + '-' + 
            String(now.getDate()).padStart(2,'0') + 'T' + 
            String(now.getHours()).padStart(2,'0') + ':' + 
            String(now.getMinutes()).padStart(2,'0');
    }
}

function atualizarLeitos() {
    var selCTI = document.getElementById('seletorCTI');
    var selLeito = document.getElementById('seletorLeito');
    
    if (!selCTI || !selLeito) return;
    
    // Salvar leito atual antes de trocar
    if (window.currentUser) { // Acessa currentUser via window
        salvarLeitoAtual();
    }
    
    ctiAtual = selCTI.value;
    atualizarSelectLeitos();
}
function atualizarSelectLeitos() {
    var selLeito = document.getElementById('seletorLeito');
    if (!selLeito) return;
    
    var leitos = (ctiAtual === 'CTI1') ? leitosCTI1 : leitosCTI2;
    var leitoSelecionadoAntes = selLeito.value;
    
    // Buscar dados de todos os leitos
    window.db.collection('leitos').get() // Acessa db via window
        .then(function(snapshot) {
            var dadosLeitos = {};
            snapshot.forEach(function(doc) {
                dadosLeitos[doc.id] = doc.data();
            });
            
            selLeito.innerHTML = '';
            leitos.forEach(function(num) {
                var opt = document.createElement('option');
                opt.value = num;
                
                var chave = ctiAtual + '_' + num;
                var dados = dadosLeitos[chave];
                var temPaciente = false;
                
                if (dados && dados.nome && dados.nome.trim()) {
                    opt.textContent = 'üî¥ ' + num + ' - ' + dados.nome.substring(0, 12);
                    opt.style.fontWeight = 'bold';
                    opt.style.color = '#c62828';
                    temPaciente = true;
                }
                
                if (!temPaciente) {
                    opt.textContent = 'üü¢ Leito ' + num + ' (vago)';
                    opt.style.color = '#2e7d32';
                }
                
                selLeito.appendChild(opt);
            });
            
            // Restaurar sele√ß√£o se poss√≠vel
            if (leitoSelecionadoAntes && leitos.includes(parseInt(leitoSelecionadoAntes))) {
                selLeito.value = leitoSelecionadoAntes;
                leitoAtual = parseInt(leitoSelecionadoAntes);
            } else {
                leitoAtual = leitos[0];
            }
            
            carregarLeito();
            atualizarTitulo();
        })
        .catch(function(error) {
            console.error('Erro ao buscar leitos:', error);
            // Fallback sem dados
            selLeito.innerHTML = '';
            leitos.forEach(function(num) {
                var opt = document.createElement('option');
                opt.value = num;
                opt.textContent = 'Leito ' + num;
                selLeito.appendChild(opt);
            });
            leitoAtual = leitos[0];
            carregarLeito();
            atualizarTitulo();
        });
}
function trocarLeito() {
    // Salvar leito atual antes de trocar
    salvarLeitoAtual();
    
    var selLeito = document.getElementById('seletorLeito');
    leitoAtual = parseInt(selLeito.value);
    
    carregarLeito();
    atualizarTitulo();
}

function atualizarTitulo() {
    var titulo = document.getElementById('tituloLeito');
    if (titulo) {
        titulo.textContent = ctiAtual.replace('CTI', 'CTI ') + ' - Leito ' + leitoAtual;
    }
}

function atualizarStatusLeito(msg) {
    var status = document.getElementById('statusLeito');
    if (status) {
        status.textContent = msg;
        setTimeout(function() {
            status.textContent = '';
        }, 3000);
    }
}

// ========== EVOLU√á√ïES COM FIREBASE ==========
function listarEvolucoes() {
    var container = document.getElementById('lista_evolucoes');
    if (!container) return;
    
    container.innerHTML = '<div style="opacity:.6; font-size: 13px;">Carregando evolu√ß√µes...</div>';
    
    var prefixo = ctiAtual + '_' + leitoAtual;
    
    // Buscar evolu√ß√µes sem orderBy para evitar necessidade de √≠ndice
    window.db.collection('evolucoes') // Acessa db via window
        .where('leitoId', '==', prefixo)
        .get()
        .then(function(snapshot) {
            if (snapshot.empty) {
                container.innerHTML = '<div style="opacity:.6; font-size: 13px;">Nenhuma evolu√ß√£o salva para este leito.</div>';
                return;
            }
            
            // Ordenar localmente por data
            var evolucoes = [];
            snapshot.forEach(function(doc) {
                var item = doc.data();
                item._id = doc.id;
                evolucoes.push(item);
            });
            
            // Ordenar por data (mais recente primeiro)
            evolucoes.sort(function(a, b) {
                var dataA = a.timestamp ? a.timestamp.toDate() : new Date(0);
                var dataB = b.timestamp ? b.timestamp.toDate() : new Date(0);
                return dataB - dataA;
            });
            
            // Limitar a 20
            evolucoes = evolucoes.slice(0, 20);
            
            container.innerHTML = '<h4 style="color:#2e7d32; margin:5px 0 10px; font-size:14px;">üìã Evolu√ß√µes deste Leito:</h4>';
            
            evolucoes.forEach(function(item) {
                var div = document.createElement('div');
                div.style.cssText = 'border: 1px solid #c8e6c9; border-radius: 6px; padding: 8px 12px; margin: 5px 0; font-size: 13px; display: flex; justify-content: space-between; align-items: center; background:#fff;';
                var dataStr = item.data || '';
                var nome = item.nome || 'Sem nome';
                var turno = item.dados && item.dados.evo_turno ? ' (' + item.dados.evo_turno + ')' : '';
                
                div.innerHTML = '<span><strong>' + nome + '</strong> - ' + dataStr + turno + '</span>' +
                    '<div>' +
                    '<button onclick="editarEvolucaoFirebase(\'' + item._id + '\')" style="cursor:pointer; color:#ff9800; border:1px solid #ff9800; background:#fff3e0; padding: 4px 10px; border-radius: 4px; margin-right: 5px;">‚úèÔ∏è Editar</button>' +
                    '<button onclick="carregarEvolucaoFirebase(\'' + item._id + '\')" style="cursor:pointer; color:#1565c0; border:1px solid #1565c0; background:#e3f2fd; padding: 4px 10px; border-radius: 4px; margin-right: 5px;">üëÅÔ∏è Ver</button>' +
                    '<button onclick="deletarEvolucaoFirebase(\'' + item._id + '\')" style="cursor:pointer; color:#c62828; border:1px solid #c62828; background:#ffebee; padding: 4px 10px; border-radius: 4px;">üóëÔ∏è</button>' +
                    '</div>';
                
                container.appendChild(div);
            });
        })
        .catch(function(error) {
            console.error('Erro ao listar evolu√ß√µes:', error);
            container.innerHTML = '<div style="color: #c62828; font-size: 13px;">Erro ao carregar evolu√ß√µes: ' + error.message + '</div>';
        });
}
function carregarEvolucaoFirebase(docId) {
    if (!confirm('Visualizar esta evolu√ß√£o?\n\nOs dados atuais da evolu√ß√£o ser√£o substitu√≠dos.')) return;
    
    window.db.collection('evolucoes').doc(docId).get() // Acessa db via window
        .then(function(doc) {
            if (doc.exists) {
                var dados = doc.data().dados;
                // Abre a evolu√ß√£o PRIMEIRO (sem limpar, pois vamos preencher)
                abrirEvolucaoSemLimpar();
                // Depois aplica os dados
                aplicarDadosEvolucao(dados);
                alert('Evolu√ß√£o carregada para visualiza√ß√£o!');
            }
        })
        .catch(function(error) {
            alert('Erro ao carregar: ' + error.message);
        });
}

// Vari√°vel para armazenar ID da evolu√ß√£o em edi√ß√£o
var evolucaoEmEdicao = null;
function editarEvolucaoFirebase(docId) {
    if (!confirm('Editar esta evolu√ß√£o?\n\nVoc√™ poder√° modificar e salvar novamente.')) return;
    
    window.db.collection('evolucoes').doc(docId).get() // Acessa db via window
        .then(function(doc) {
            if (doc.exists) {
                var dados = doc.data().dados;
                // Armazena o ID para atualiza√ß√£o
                evolucaoEmEdicao = docId;
                // Abre a evolu√ß√£o PRIMEIRO (sem limpar, pois vamos preencher)
                abrirEvolucaoSemLimpar();
                // Depois aplica os dados
                aplicarDadosEvolucao(dados);
                // Mostra indicador de edi√ß√£o
                var statusDiv = document.getElementById('status_evo_save');
                if (statusDiv) {
                    statusDiv.innerHTML = '<span style="color: #ff9800; font-weight: bold;">‚úèÔ∏è Editando evolu√ß√£o existente</span>';
                }
            }
        })
        .catch(function(error) {
            alert('Erro ao carregar: ' + error.message);
        });
}
// Fun√ß√£o para abrir evolu√ß√£o sem limpar campos (para visualizar/editar)
function abrirEvolucaoSemLimpar() {
    var area = document.getElementById('evolucaoArea');
    if (!area) return;
    area.classList.remove('hidden');
    try { area.scrollIntoView({behavior:'smooth', block:'start'}); }
    catch(e) { area.scrollIntoView(true); }
}
// Fun√ß√£o para aplicar dados especificamente na √°rea de evolu√ß√£o
function aplicarDadosEvolucao(dados) {
    var area = document.getElementById('evolucaoArea');
    if (!area || !dados) return;
    
    // Primeiro limpa todos os campos da evolu√ß√£o
    var els = area.querySelectorAll('input, textarea, select');
    els.forEach(function(el) {
        if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
        } else if (!el.readOnly) {
            el.value = '';
        }
    });
    
    // Aplica os dados
    for (var key in dados) {
        if (!dados.hasOwnProperty(key)) continue;
        
        var valor = dados[key];
        var els = area.querySelectorAll('[name="' + key + '"]');
        
        if (els.length === 0) continue;
        
        els.forEach(function(el) {
            if (el.type === 'checkbox') {
                el.checked = !!valor;
            } else if (el.type === 'radio') {
                el.checked = (el.value === valor);
            } else {
                el.value = valor !== null && valor !== undefined ? valor : '';
            }
        });
    }
    
    // Ativa os toggles condicionais
    ativarTogglesCondicionais();
}
function deletarEvolucaoFirebase(docId) {
    if (!confirm('Excluir esta evolu√ß√£o?')) return;
    
    window.db.collection('evolucoes').doc(docId).delete() // Acessa db via window
        .then(function() {
            listarEvolucoes();
        })
        .catch(function(error) {
            alert('Erro ao excluir: ' + error.message);
        });
}
// Atualizar fun√ß√£o salvarEvolucao para usar Firebase
var salvarEvolucaoOriginal = typeof salvarEvolucao === 'function' ? salvarEvolucao : null;
function salvarEvolucao() {
    var nomePct = document.getElementsByName("nome")[0]?.value || "Paciente";
    
    // Coletar APENAS campos da evolu√ß√£o (dentro de #evolucaoArea)
    var evolucaoArea = document.getElementById('evolucaoArea');
    if (!evolucaoArea) {
        alert('Erro: √°rea de evolu√ß√£o n√£o encontrada');
        return;
    }
    
    var inputs = evolucaoArea.querySelectorAll("input, textarea, select");
    var conteudo = {};
    
    inputs.forEach(function(el) {
        var chave = el.name || el.id;
        if (!chave) return;
        
        if (el.type === 'checkbox') {
            conteudo[chave] = el.checked;
        } else if (el.type === 'radio') {
            if (el.checked) {
                conteudo[chave] = el.value;
            }
        } else {
            conteudo[chave] = el.value;
        }
    });
    
    // Adicionar campos readonly da identifica√ß√£o
    var camposIdentificacao = ['evo_nome', 'evo_idade', 'evo_sexo', 'evo_dia_uti', 'evo_peso', 'evo_altura', 'evo_imc', 'evo_pbw'];
    camposIdentificacao.forEach(function(campo) {
        var el = document.getElementsByName(campo)[0];
        if (el) conteudo[campo] = el.value;
    });
    
    var evolucao = {
        leitoId: ctiAtual + '_' + leitoAtual,
        cti: ctiAtual,
        leito: leitoAtual,
        nome: nomePct,
        data: new Date().toLocaleString('pt-BR'),
        timestamp: window.serverTimestamp(), // Usa serverTimestamp via window
        salvoPor: window.currentUser ? window.currentUser.email : 'desconhecido', // Acessa currentUser via window
        dados: conteudo
    };
    
    atualizarSyncStatus('pending');
    
    // Salvar no localStorage para pr√≥xima evolu√ß√£o
    try {
        localStorage.setItem('evolucao_last_' + ctiAtual + '_' + leitoAtual, JSON.stringify(conteudo));
    } catch(e) {
        console.error('Erro ao salvar no localStorage:', e);
    }
    
    // Verifica se est√° editando ou criando nova evolu√ß√£o
    if (evolucaoEmEdicao) {
        // Atualizar evolu√ß√£o existente
        evolucao.editadoEm = new Date().toLocaleString('pt-BR');
        evolucao.editadoPor = window.currentUser ? window.currentUser.email : 'desconhecido'; // Acessa currentUser via window
        
        window.db.collection('evolucoes').doc(evolucaoEmEdicao).update(evolucao) // Acessa db via window
            .then(function() {
                atualizarSyncStatus('ok');
                salvarLeitoAtual();
                listarEvolucoes();
                evolucaoEmEdicao = null;
                var statusDiv = document.getElementById('status_evo_save');
                if (statusDiv) statusDiv.innerHTML = '';
                alert('‚úÖ Evolu√ß√£o atualizada com sucesso!');
            })
            .catch(function(error) {
                console.error('Erro ao atualizar evolu√ß√£o:', error);
                atualizarSyncStatus('error');
                alert('Erro ao atualizar: ' + error.message);
            });
    } else {
        // Criar nova evolu√ß√£o
        window.db.collection('evolucoes').add(evolucao) // Acessa db via window
            .then(function() {
                atualizarSyncStatus('ok');
                salvarLeitoAtual();
                listarEvolucoes();
                alert('‚úÖ Evolu√ß√£o salva com sucesso!');
            })
            .catch(function(error) {
                console.error('Erro ao salvar evolu√ß√£o:', error);
                atualizarSyncStatus('error');
                alert('Erro ao salvar: ' + error.message);
            });
    }
}
// ========== ALTAS COM FIREBASE ==========

function darAlta() {
    var nomePaciente = document.getElementsByName("nome")[0]?.value || "";
    
    if (!nomePaciente.trim()) {
        alert("N√£o h√° paciente neste leito para dar alta.");
        return;
    }
    
    if (!confirm("‚ö†Ô∏è DAR ALTA ao paciente:\n\n" + nomePaciente + "\n\n" + ctiAtual.replace('CTI', 'CTI ') + " - Leito " + leitoAtual + "\n\nGerar resumo de alta?")) return;
    
    // Mostrar modal
    mostrarModalResumoAlta(nomePaciente, false);
    
    // Coletar dados para o resumo
    var dadosResumo = coletarDadosParaResumo();
    
    // Gerar resumo automaticamente (melhorado)
    var resumo = gerarResumoManual(dadosResumo);
    
    // Atualizar modal com o resumo
    atualizarModalResumoAlta(resumo, nomePaciente, false);
}
function coletarDadosParaResumo() {
    var dados = {};
    
    // Identifica√ß√£o
    dados.nome = document.getElementsByName("nome")[0]?.value || "";
    dados.idade = document.getElementById("idade")?.value || "";
    dados.sexo = document.getElementById("sexo")?.value || "";
    dados.dataAdmissao = document.getElementById("datahora_admissao")?.value || "";
    
    // HMA e HPP
    dados.hma = document.getElementsByName("hma")[0]?.value || "";
    dados.hpp = document.getElementsByName("hpp")[0]?.value || "";
    dados.cirurgias = document.getElementsByName("cirurgias")[0]?.value || "";
    dados.alergias = document.getElementsByName("alergias")[0]?.value || "";
    
    // Evolu√ß√£o - Motivo UTI e Problemas
    dados.motivoUTI = document.getElementsByName("evo_motivo_uti")[0]?.value || "";
    dados.problemasAtuais = document.getElementsByName("evo_problemas")[0]?.value || "";
    
    // Infec√ß√£o e ATBs
    dados.focoInfeccioso = document.getElementsByName("evo_inf_foco")[0]?.value || "";
    dados.atb1 = document.getElementsByName("evo_inf_atb1")[0]?.value || "";
    dados.atb1Dias = document.getElementsByName("evo_inf_dia_atb1")[0]?.value || "";
    dados.atb1Total = document.getElementsByName("evo_inf_total_atb1")[0]?.value || "";
    dados.atb2 = document.getElementsByName("evo_inf_atb2")[0]?.value || "";
    dados.atb2Dias = document.getElementsByName("evo_inf_dia_atb2")[0]?.value || "";
    dados.atb2Total = document.getElementsByName("evo_inf_total_atb2")[0]?.value || "";
    dados.atb3 = document.getElementsByName("evo_inf_atb3")[0]?.value || "";
    dados.atb3Dias = document.getElementsByName("evo_inf_dia_atb3")[0]?.value || "";
    dados.atb3Total = document.getElementsByName("evo_inf_total_atb3")[0]?.value || "";
    
    // Culturas
    var culturas = document.querySelector('input[name="evo_culturas"]:checked');
    dados.culturas = culturas ? culturas.value : "";
    dados.culturasPendentes = document.getElementsByName("evo_cult_pend_data")[0]?.value || "";
    dados.culturasPositivas = document.getElementsByName("evo_cult_pos_txt")[0]?.value || "";
    
    // Transfus√µes
    dados.transfusoes = [];
    if (document.getElementsByName("evo_transf_ch")[0]?.checked) {
        var qtd = document.getElementById("evo_transf_ch_qtd")?.value || "";
        dados.transfusoes.push("Concentrado de Hem√°cias" + (qtd ? " (" + qtd + ")" : ""));
    }
    if (document.getElementsByName("evo_transf_plaq")[0]?.checked) {
        var qtd = document.getElementById("evo_transf_plaq_qtd")?.value || "";
        dados.transfusoes.push("Plaquetas" + (qtd ? " (" + qtd + ")" : ""));
    }
    if (document.getElementsByName("evo_transf_plasma")[0]?.checked) {
        var qtd = document.getElementById("evo_transf_plasma_qtd")?.value || "";
        dados.transfusoes.push("Plasma" + (qtd ? " (" + qtd + ")" : ""));
    }
    if (document.getElementsByName("evo_transf_crio")[0]?.checked) {
        var qtd = document.getElementById("evo_transf_crio_qtd")?.value || "";
        dados.transfusoes.push("Crioprecipitado" + (qtd ? " (" + qtd + ")" : ""));
    }
    
    // Dispositivos invasivos
    dados.dispositivos = [];
    var cvcLocal = document.getElementsByName("evo_cvc_local")[0]?.value;
    var cvcDia = document.getElementsByName("evo_cvc_dia")[0]?.value;
    if (cvcLocal) dados.dispositivos.push("CVC " + cvcLocal + (cvcDia ? " (D" + cvcDia + ")" : ""));
    
    var artLocal = document.getElementsByName("evo_art_local")[0]?.value;
    var artDia = document.getElementsByName("evo_art_dia")[0]?.value;
    if (artLocal) dados.dispositivos.push("Cateter arterial " + artLocal + (artDia ? " (D" + artDia + ")" : ""));
    
    var hdLocal = document.getElementsByName("evo_hd_local")[0]?.value;
    if (hdLocal) dados.dispositivos.push("Cateter HD " + hdLocal);
    
    var svdDia = document.getElementsByName("evo_svd_dia")[0]?.value;
    if (svdDia) dados.dispositivos.push("SVD (D" + svdDia + ")");
    
    var totDia = document.getElementsByName("evo_tot_tqt_dia")[0]?.value;
    if (totDia) dados.dispositivos.push("TOT/TQT (D" + totDia + ")");
    
    var drenos = document.getElementsByName("evo_drenos_outros")[0]?.value;
    if (drenos) dados.dispositivos.push("Drenos: " + drenos);
    
    // Impress√£o cl√≠nica
    dados.impressao = document.getElementsByName("evo_impressao")[0]?.value || "";
    
    // Plano/Metas 24h (√∫ltima evolu√ß√£o)
    dados.plano24h = document.getElementsByName("evo_plano_24h")[0]?.value || "";
    
    return dados;
}
async function gerarResumoAltaIA(dados, nomePaciente) {
    var prompt = `Voc√™ √© um m√©dico intensivista experiente. Gere um RESUMO DE ALTA DE UTI conciso e profissional com base nos dados abaixo.

DADOS DO PACIENTE:
- Nome: ${dados.nome}
- Idade: ${dados.idade} anos
- Sexo: ${dados.sexo === 'M' ? 'Masculino' : 'Feminino'}
- Data de admiss√£o: ${dados.dataAdmissao}

MOTIVO DA INTERNA√á√ÉO NA UTI:
${dados.motivoUTI || 'N√£o informado'}

HIST√ìRIA DA MOL√âSTIA ATUAL:
${dados.hma || 'N√£o informado'}

COMORBIDADES/HPP:
${dados.hpp || 'N√£o informado'}

PROBLEMAS DURANTE A INTERNA√á√ÉO:
${dados.problemasAtuais || 'N√£o informado'}

FOCO INFECCIOSO:
${dados.focoInfeccioso || 'N√£o identificado'}

ANTIBI√ìTICOS UTILIZADOS:
${dados.atb1 ? '- ' + dados.atb1 + ' (D' + dados.atb1Dias + '/' + dados.atb1Total + ')' : ''}
${dados.atb2 ? '- ' + dados.atb2 + ' (D' + dados.atb2Dias + '/' + dados.atb2Total + ')' : ''}
${dados.atb3 ? '- ' + dados.atb3 + ' (D' + dados.atb3Dias + '/' + dados.atb3Total + ')' : ''}
${!dados.atb1 && !dados.atb2 && !dados.atb3 ? 'Nenhum' : ''}

CULTURAS:
${dados.culturas === 'positivas' ? 'Positivas: ' + dados.culturasPositivas : dados.culturas === 'pendentes' ? 'Pendentes desde: ' + dados.culturasPendentes : dados.culturas === 'negativas' ? 'Negativas' : 'N√£o coletadas'}

TRANSFUS√ïES:
${dados.transfusoes.length > 0 ? dados.transfusoes.join(', ') : 'Nenhuma'}

DISPOSITIVOS INVASIVOS UTILIZADOS:
${dados.dispositivos.length > 0 ? dados.dispositivos.join(', ') : 'Nenhum'}

IMPRESS√ÉO CL√çNICA:
${dados.impressao || 'N√£o informada'}

PLANO/METAS 24H (√öLTIMA EVOLU√á√ÉO):
${dados.plano24h || 'N√£o informado'}

---

Por favor, gere um RESUMO DE ALTA estruturado com:
1. **IDENTIFICA√á√ÉO** (1 linha)
2. **MOTIVO DA INTERNA√á√ÉO** (2-3 linhas)
3. **RESUMO DA INTERNA√á√ÉO** (principais eventos, intercorr√™ncias, procedimentos - 4-6 linhas)
4. **ANTIBIOTICOTERAPIA** (ATBs usados com dura√ß√£o)
5. **HEMOTRANSFUS√ïES** (se houver)
6. **DISPOSITIVOS** (quais foram usados)
7. **CONDI√á√ïES DE ALTA** (baseado na impress√£o cl√≠nica)
8. **ORIENTA√á√ïES P√ìS-ALTA** - IMPORTANTE: Base as orienta√ß√µes no PLANO/METAS 24H acima. Transforme as metas do plano em orienta√ß√µes espec√≠ficas para o paciente/fam√≠lia (ex: se o plano menciona "manter oxigenioterapia", oriente "manter oxig√™nio domiciliar conforme prescrito"). Inclua tamb√©m sinais de alerta gerais.

Use linguagem m√©dica profissional, seja objetivo e conciso. O texto deve estar pronto para ser copiado e colado no sistema hospitalar.`;
try {
        var response = await fetch("https://api.anthropic.com/v1/messages", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "anthropic-version": "2023-06-01"
            },
            body: JSON.stringify({
                model: "claude-sonnet-4-20250514",
                max_tokens: 1500,
                messages: [
                    { role: "user", content: prompt }
                ]
            })
        });
        
        var data = await response.json();
        var resumo = data.content[0].text;
        
        // Atualizar modal com o resumo
        atualizarModalResumoAlta(resumo, nomePaciente);
        
    } catch (error) {
        console.error('Erro ao gerar resumo:', error);
        // Gerar resumo manual se a IA falhar
        var resumoManual = gerarResumoManual(dados);
        atualizarModalResumoAlta(resumoManual, nomePaciente, true);
    }
}
function gerarResumoManual(dados) {
    var linhas = [];
    var hoje = new Date();
    
    // CABE√áALHO
    linhas.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    linhas.push("         RESUMO DE ALTA DA UNIDADE DE TERAPIA INTENSIVA");
    linhas.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n");
    
    // 1. IDENTIFICA√á√ÉO
    linhas.push("1. IDENTIFICA√á√ÉO");
    linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
    linhas.push("Nome: " + dados.nome);
    linhas.push("Idade: " + dados.idade + " anos");
    linhas.push("Sexo: " + (dados.sexo === 'M' ? 'Masculino' : 'Feminino'));
    linhas.push("Data de Admiss√£o na UTI: " + (dados.dataAdmissao || 'N√£o informada'));
    linhas.push("Data de Alta: " + hoje.toLocaleDateString('pt-BR') + " √†s " + hoje.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'}));
    linhas.push("");
    
    // 2. MOTIVO DA INTERNA√á√ÉO
    linhas.push("2. MOTIVO DA INTERNA√á√ÉO NA UTI");
    linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
    if (dados.motivoUTI) {
        linhas.push(dados.motivoUTI);
    } else if (dados.hma) {
        linhas.push(dados.hma);
    } else {
        linhas.push("N√£o informado.");
    }
    linhas.push("");
    
    // 3. RESUMO DA INTERNA√á√ÉO
    linhas.push("3. RESUMO DA INTERNA√á√ÉO");
    linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
    
    if (dados.problemasAtuais) {
        linhas.push("Durante a interna√ß√£o na UTI, o paciente evoluiu com:");
        linhas.push(dados.problemasAtuais);
        linhas.push("");
    }
    
    if (dados.hpp) {
        linhas.push("Hist√≥ria Patol√≥gica Pregressa:");
        linhas.push(dados.hpp);
        linhas.push("");
    }
    
    if (dados.cirurgias) {
        linhas.push("Cirurgias Pr√©vias:");
        linhas.push(dados.cirurgias);
        linhas.push("");
    }
    
    if (dados.alergias) {
        linhas.push("Alergias:");
        linhas.push(dados.alergias);
        linhas.push("");
    }
    
    // 4. ANTIBIOTICOTERAPIA
    if (dados.focoInfeccioso || dados.atb1) {
        linhas.push("4. ANTIBIOTICOTERAPIA");
        linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        
        if (dados.focoInfeccioso) {
            linhas.push("Foco Infeccioso: " + dados.focoInfeccioso);
        }
        
        if (dados.atb1) {
            linhas.push("‚Ä¢ " + dados.atb1 + " - Dia " + (dados.atb1Dias || "?") + " de " + (dados.atb1Total || "?"));
        }
        if (dados.atb2) {
            linhas.push("‚Ä¢ " + dados.atb2 + " - Dia " + (dados.atb2Dias || "?") + " de " + (dados.atb2Total || "?"));
        }
        if (dados.atb3) {
            linhas.push("‚Ä¢ " + dados.atb3 + " - Dia " + (dados.atb3Dias || "?") + " de " + (dados.atb3Total || "?"));
        }
        
        if (dados.culturas === 'sim') {
            if (dados.culturasPositivas) {
                linhas.push("\nCulturas Positivas: " + dados.culturasPositivas);
            }
        }
        if (dados.culturasPendentes) {
            linhas.push("Culturas Pendentes: " + dados.culturasPendentes);
        }
        
        linhas.push("");
    }
    
    // 5. HEMOTRANSFUS√ïES
    if (dados.transfusoes && dados.transfusoes.length > 0) {
        linhas.push("5. HEMOTRANSFUS√ïES");
        linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        dados.transfusoes.forEach(function(t) {
            linhas.push("‚Ä¢ " + t);
        });
        linhas.push("");
    }
    
    // 6. DISPOSITIVOS INVASIVOS
    if (dados.dispositivos && dados.dispositivos.length > 0) {
        linhas.push("6. DISPOSITIVOS INVASIVOS UTILIZADOS");
        linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
        dados.dispositivos.forEach(function(d) {
            linhas.push("‚Ä¢ " + d);
        });
        linhas.push("");
    }
    
    // 7. CONDI√á√ïES DE ALTA
    linhas.push("7. CONDI√á√ïES DE ALTA");
    linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
    if (dados.impressao) {
        linhas.push(dados.impressao);
    } else {
        linhas.push("Paciente est√°vel clinicamente, apto para alta da UTI.");
    }
    linhas.push("");
    
    // 8. ORIENTA√á√ïES P√ìS-ALTA
    linhas.push("8. ORIENTA√á√ïES P√ìS-ALTA");
    linhas.push("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
    
    // Usar Plano/Metas 24h para orienta√ß√µes espec√≠ficas
    if (dados.plano24h) {
        linhas.push("CUIDADOS ESPEC√çFICOS (baseados no plano de metas):");
        
        // Processar o plano e transformar em orienta√ß√µes
        var planoLinhas = dados.plano24h.split('\n');
        planoLinhas.forEach(function(linha) {
            linha = linha.trim();
            if (linha && linha.length > 3) {
                // Remover bullets e formata√ß√£o
                linha = linha.replace(/^[-‚Ä¢*]\s*/, '');
                
                // Transformar metas em orienta√ß√µes
                if (linha.toLowerCase().includes('o2') || linha.toLowerCase().includes('oxig')) {
                    linhas.push("‚Ä¢ " + linha.replace(/manter/i, 'Manter').replace(/monitorar/i, 'Monitorar'));
                } else if (linha.toLowerCase().includes('atb') || linha.toLowerCase().includes('antibio')) {
                    linhas.push("‚Ä¢ " + linha.replace(/completar/i, 'Completar'));
                } else if (linha.toLowerCase().includes('fisio')) {
                    linhas.push("‚Ä¢ " + linha.replace(/manter/i, 'Realizar'));
                } else if (linha.toLowerCase().includes('alta')) {
                    // Pular linhas sobre alta
                } else {
                    linhas.push("‚Ä¢ " + linha);
                }
            }
        });
        linhas.push("");
    }
    
    // Orienta√ß√µes gerais sempre presentes
    linhas.push("ORIENTA√á√ïES GERAIS:");
    linhas.push("‚Ä¢ Manter todas as medica√ß√µes prescritas na alta conforme orienta√ß√£o m√©dica");
    linhas.push("‚Ä¢ Retorno ambulatorial conforme agendamento");
    linhas.push("‚Ä¢ Manter acompanhamento com m√©dico de refer√™ncia");
    
    if (dados.atb1) {
        var diasRestantes = (parseInt(dados.atb1Total) || 0) - (parseInt(dados.atb1Dias) || 0);
        if (diasRestantes > 0) {
            linhas.push("‚Ä¢ Completar antibioticoterapia conforme prescrito");
        }
    }
    
    linhas.push("");
    linhas.push("SINAIS DE ALERTA - Procurar emerg√™ncia se apresentar:");
    linhas.push("‚Ä¢ Febre (temperatura > 38¬∞C) ou hipotermia");
    linhas.push("‚Ä¢ Falta de ar ou dificuldade respirat√≥ria");
    linhas.push("‚Ä¢ Dor tor√°cica");
    linhas.push("‚Ä¢ Altera√ß√£o do n√≠vel de consci√™ncia (sonol√™ncia excessiva ou confus√£o)");
    linhas.push("‚Ä¢ Sinais de sangramento");
    linhas.push("‚Ä¢ Piora importante do estado geral");
    
    linhas.push("");
    linhas.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    linhas.push("         Resumo gerado automaticamente em " + hoje.toLocaleDateString('pt-BR'));
    linhas.push("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
    
    return linhas.join("\n");
}
function mostrarModalResumoAlta(nomePaciente, loading) {
    // Criar modal se n√£o existir
    var modal = document.getElementById('modalResumoAlta');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalResumoAlta';
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10000;';
        modal.innerHTML = `
            <div style="background:white;border-radius:12px;width:90%;max-width:800px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
                <div style="background:#1565c0;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;">
                    <h3 style="margin:0;">üìã Resumo de Alta - <span id="resumoAltaNome"></span></h3>
                    <button onclick="fecharModalResumoAlta()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer;">&times;</button>
                </div>
                <div style="padding:20px;overflow-y:auto;flex:1;">
                    <div id="resumoAltaConteudo">
                        <div style="background:#e3f2fd;border:1px solid #2196f3;border-radius:6px;padding:12px;margin-bottom:15px;color:#0d47a1;">
                            ‚ÑπÔ∏è Resumo gerado automaticamente com base nos dados da interna√ß√£o. Revise e edite conforme necess√°rio.
                        </div>
                        <textarea id="resumoAltaTexto" style="width:100%;height:450px;font-family:monospace;font-size:13px;padding:15px;border:1px solid #ddd;border-radius:6px;resize:vertical;"></textarea>
                    </div>
                </div>
                <div style="padding:15px 20px;border-top:1px solid #eee;display:flex;justify-content:space-between;gap:10px;">
                    <button onclick="fecharModalResumoAlta()" style="padding:10px 20px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;cursor:pointer;">Cancelar</button>
                    <div style="display:flex;gap:10px;">
                        <button onclick="copiarResumoAlta()" style="padding:10px 20px;background:#4caf50;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">üìã Copiar Resumo</button>
                        <button onclick="confirmarAltaComResumo()" style="padding:10px 20px;background:#c62828;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">‚úÖ Confirmar Alta</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    document.getElementById('resumoAltaNome').textContent = nomePaciente;
    modal.style.display = 'flex';
}
function atualizarModalResumoAlta(resumo, nomePaciente, isManual) {
    document.getElementById('resumoAltaTexto').value = resumo;
}

function fecharModalResumoAlta() {
    var modal = document.getElementById('modalResumoAlta');
    if (modal) modal.style.display = 'none';
}

function copiarResumoAlta() {
    var textarea = document.getElementById('resumoAltaTexto');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        alert('‚úÖ Resumo copiado para a √°rea de transfer√™ncia!');
    }
}

function confirmarAltaComResumo() {
    var nomePaciente = document.getElementById('resumoAltaNome').textContent;
    
    if (!confirm("‚ö†Ô∏è CONFIRMAR ALTA?\n\nPaciente: " + nomePaciente + "\n\nEsta a√ß√£o n√£o pode ser desfeita.")) return;
    
    fecharModalResumoAlta();
    executarAlta(nomePaciente);
}
function executarAlta(nomePaciente) {
    // Coletar dados atuais
    var inputs = document.querySelectorAll("input, textarea, select");
    var conteudo = {};
    
    inputs.forEach(function(el) {
        if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
        if (el.id === 'loginEmail' || el.id === 'loginPassword') return;
        
        var chave = el.name || el.id;
        if (!chave) return;
        
        if (el.type === 'checkbox' || el.type === 'radio') {
            if (el.checked) {
                conteudo[chave + '::' + el.value] = true;
                if (el.type === 'radio') conteudo[chave] = el.value;
            }
        } else {
            conteudo[chave] = el.value;
        }
    });
    
    var prefixoLeito = ctiAtual + '_' + leitoAtual;
    
    // Incluir o resumo de alta no registro
    var resumoAlta = document.getElementById('resumoAltaTexto')?.value || '';
    
    var registroAlta = {
        nome: nomePaciente,
        cti: ctiAtual,
        leito: leitoAtual,
        dataAlta: new Date().toLocaleString('pt-BR'),
        dataAdmissao: conteudo.datahora_admissao || '',
        timestamp: window.serverTimestamp(), // Usa serverTimestamp via window
        altaDadaPor: window.currentUser ? window.currentUser.email : 'desconhecido', // Acessa currentUser via window
        resumoAlta: resumoAlta,
        dados: conteudo
    };
    
    atualizarSyncStatus('pending');
    
    // Salvar na cole√ß√£o de altas
    window.db.collection('altas').add(registroAlta) // Acessa db via window
        .then(function() {
            // Excluir todas as evolu√ß√µes deste leito
            return window.db.collection('evolucoes') // Acessa db via window
                .where('leitoId', '==', prefixoLeito)
                .get();
        })
        .then(function(snapshot) {
            // Deletar cada evolu√ß√£o encontrada
            var batch = window.db.batch(); // Acessa db via window
            snapshot.forEach(function(doc) {
                batch.delete(doc.ref);
            });
            return batch.commit();
        })
        .then(function() {
            // Limpar leito
            return window.db.collection('leitos').doc(getChaveLeitoFirebase()).delete(); // Acessa db via window
        })
        .then(function() {
            // Limpar localStorage das evolu√ß√µes deste leito
            try {
                localStorage.removeItem('evolucao_last_' + prefixoLeito);
            } catch(e) {
                console.error('Erro ao limpar localStorage:', e);
            }
            
            // Limpar formul√°rio
            document.querySelectorAll("input, textarea, select").forEach(function(el) {
                if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
                if (el.id === 'loginEmail' || el.id === 'loginPassword') return;
                
                if (el.type === 'checkbox' || el.type === 'radio') el.checked = false;
                else el.value = "";
                if (el.tagName === 'SELECT') el.selectedIndex = 0;
            });
            
            // Limpar lista de evolu√ß√µes na tela
            var listaEvo = document.getElementById('lista_evolucoes');
            if (listaEvo) {
                listaEvo.innerHTML = '<div style="opacity:.6; font-size: 13px;">Nenhuma evolu√ß√£o salva para este leito.</div>';
            }
            
            preencherDataHoraAtual();
            atualizarSelectLeitos();
            atualizarSyncStatus('ok');
            
            alert("‚úÖ Alta registrada com sucesso!\n\nPaciente: " + nomePaciente + "\n\nEvolu√ß√µes foram arquivadas.");
        })
        .catch(function(error) {
            console.error('Erro ao dar alta:', error);
            atualizarSyncStatus('error');
            alert('Erro ao registrar alta: ' + error.message);
        });
}
function verAltas() {
    var modal = document.getElementById('modalAltas');
    if (modal) {
        renderizarListaAltas();
        modal.style.display = 'flex';
    }
}

function fecharModalAltas() {
    var modal = document.getElementById('modalAltas');
    if (modal) modal.style.display = 'none';
}
function renderizarListaAltas(filtro) {
    var container = document.getElementById('listaAltas');
    var totalSpan = document.getElementById('totalAltas');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align: center; padding: 40px;">Carregando...</div>';
    
    window.db.collection('altas') // Acessa db via window
        .orderBy('timestamp', 'desc')
        .limit(100)
        .get()
        .then(function(snapshot) {
            var altas = [];
            snapshot.forEach(function(doc) {
                var data = doc.data();
                data.id = doc.id;
                altas.push(data);
            });
            
            // Aplicar filtro se houver
            if (filtro && filtro.trim()) {
                altas = altas.filter(function(a) {
                    return (a.nome || '').toLowerCase().includes(filtro.toLowerCase());
                });
            }
            
            if (totalSpan) {
                totalSpan.textContent = 'Mostrando ' + altas.length + ' registros';
            }
            
            if (altas.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">' + 
                    (filtro ? 'Nenhum paciente encontrado.' : 'Nenhum paciente com alta registrada.') + '</div>';
                return;
            }
            
            var html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
            html += '<thead><tr style="background: #1565c0; color: white;">';
            html += '<th style="padding: 12px; text-align: left;">Paciente</th>';
            html += '<th style="padding: 12px; text-align: left;">CTI/Leito</th>';
            html += '<th style="padding: 12px; text-align: left;">Admiss√£o</th>';
            html += '<th style="padding: 12px; text-align: left;">Alta</th>';
            html += '<th style="padding: 12px; text-align: center;">A√ß√µes</th>';
            html += '</tr></thead><tbody>';
            
            altas.forEach(function(alta, index) {
                html += '<tr style="border-bottom: 1px solid #ddd; ' + (index % 2 === 0 ? 'background: #f9f9f9;' : '') + '">';
                html += '<td style="padding: 10px;"><strong>' + (alta.nome || 'Sem nome') + '</strong></td>';
                html += '<td style="padding: 10px;">' + (alta.cti || '').replace('CTI', 'CTI ') + ' - Leito ' + (alta.leito || '') + '</td>';
                html += '<td style="padding: 10px;">' + formatarData(alta.dataAdmissao) + '</td>';
                html += '<td style="padding: 10px;">' + (alta.dataAlta || '') + '</td>';
                html += '<td style="padding: 10px; text-align: center;">';
                html += '<button onclick="verDetalhesAlta(\'' + alta.id + '\')" style="background: #1976d2; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px;">Ver</button>';
                html += '<button onclick="excluirAlta(\'' + alta.id + '\')" style="background: #c62828; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Excluir</button>';
                html += '</td></tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(function(error) {
            console.error('Erro ao buscar altas:', error);
            container.innerHTML = '<div style="color: #c62828; padding: 20px;">Erro ao carregar hist√≥rico de altas.</div>';
        });
}
function formatarData(dataStr) {
    if (!dataStr) return '-';
    try {
        if (dataStr.includes('T')) {
            var d = new Date(dataStr);
            return d.toLocaleString('pt-BR');
        }
        return dataStr;
    } catch(e) {
        return dataStr;
    }
}

function filtrarAltas() {
    var termo = document.getElementById('buscaAltas').value;
    renderizarListaAltas(termo);
}
function verDetalhesAlta(idAlta) {
    window.db.collection('altas').doc(idAlta).get() // Acessa db via window
        .then(function(doc) {
            if (!doc.exists) {
                alert('Registro n√£o encontrado.');
                return;
            }
            
            var alta = doc.data();
            
            var texto = '=== REGISTRO DE ALTA ===\n\n';
            texto += 'Paciente: ' + (alta.nome || '-') + '\n';
            texto += 'CTI: ' + (alta.cti || '').replace('CTI', 'CTI ') + '\n';
            texto += 'Leito: ' + (alta.leito || '-') + '\n';
            texto += 'Data Admiss√£o: ' + formatarData(alta.dataAdmissao) + '\n';
            texto += 'Data Alta: ' + (alta.dataAlta || '-') + '\n\n';
            
            if (alta.dados) {
                texto += '--- Dados do Paciente ---\n';
                if (alta.dados.idade) texto += 'Idade: ' + alta.dados.idade + '\n';
                if (alta.dados.sexo) texto += 'Sexo: ' + alta.dados.sexo + '\n';
                if (alta.dados.hma) texto += '\nHMA:\n' + alta.dados.hma + '\n';
                if (alta.dados.hpp) texto += '\nHPP:\n' + alta.dados.hpp + '\n';
                if (alta.dados.evo_impressao) texto += '\n√öltima Impress√£o Cl√≠nica:\n' + alta.dados.evo_impressao + '\n';
            }
            
            var modalDetalhes = document.getElementById('modalDetalhesAlta');
            var textareaDetalhes = document.getElementById('textareaDetalhesAlta');
            if (modalDetalhes && textareaDetalhes) {
                textareaDetalhes.value = texto;
                modalDetalhes.style.display = 'flex';
            }
        })
        .catch(function(error) {
            alert('Erro ao carregar detalhes: ' + error.message);
        });
}
function fecharModalDetalhes() {
    var modal = document.getElementById('modalDetalhesAlta');
    if (modal) modal.style.display = 'none';
}

function copiarDetalhesAlta() {
    var textarea = document.getElementById('textareaDetalhesAlta');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        alert('Copiado!');
    }
}

function excluirAlta(idAlta) {
    if (!confirm('Excluir este registro de alta permanentemente?')) return;
    
    window.db.collection('altas').doc(idAlta).delete() // Acessa db via window
        .then(function() {
            renderizarListaAltas();
        })
        .catch(function(error) {
            alert('Erro ao excluir: ' + error.message);
        });
}

// ========== RESUMO CTI ==========

function verResumoCTI() {
    var modal = document.getElementById('modalResumoCTI');
    if (modal) {
        renderizarResumoCTI();
        modal.style.display = 'flex';
    }
}
function fecharModalResumoCTI() {
    var modal = document.getElementById('modalResumoCTI');
    if (modal) modal.style.display = 'none';
}
function renderizarResumoCTI() {
    var container = document.getElementById('conteudoResumoCTI');
    var resumoOcupacao = document.getElementById('resumoOcupacao');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align: center; padding: 40px;">Carregando...</div>';
    
    window.db.collection('leitos').get() // Acessa db via window
        .then(function(snapshot) {
            var dadosLeitos = {};
            snapshot.forEach(function(doc) {
                dadosLeitos[doc.id] = doc.data();
            });
            
            var html = '';
            var totalOcupados = 0;
            var totalLeitos = 0;
            
            // CTI 1
            html += '<div style="margin-bottom: 30px;">';
            html += '<h3 style="color: #1565c0; border-bottom: 2px solid #1565c0; padding-bottom: 10px;">üè• CTI 1</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">';
            leitosCTI1.forEach(function(num) {
                var info = obterInfoLeitoFirebase(dadosLeitos, 'CTI1', num);
                totalLeitos++;
                if (info.ocupado) totalOcupados++;
                html += gerarCardLeito('CTI1', num, info);
            });
            
            html += '</div></div>';
            
            // CTI 2
            html += '<div>';
            html += '<h3 style="color: #1565c0; border-bottom: 2px solid #1565c0; padding-bottom: 10px;">üè• CTI 2</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;">';
            
            leitosCTI2.forEach(function(num) {
                var info = obterInfoLeitoFirebase(dadosLeitos, 'CTI2', num);
                totalLeitos++;
                if (info.ocupado) totalOcupados++;
                html += gerarCardLeito('CTI2', num, info);
            });
            
            html += '</div></div>';
            
            container.innerHTML = html;
            
            var vagos = totalLeitos - totalOcupados;
            resumoOcupacao.innerHTML = 'üõèÔ∏è Ocupados: <span style="color: #c62828;">' + totalOcupados + '</span> | Vagos: <span style="color: #2e7d32;">' + vagos + '</span> | Total: ' + totalLeitos;
        })
        .catch(function(error) {
            console.error('Erro ao carregar resumo:', error);
            container.innerHTML = '<div style="color: #c62828; padding: 20px;">Erro ao carregar resumo.</div>';
        });
}
function obterInfoLeitoFirebase(dadosLeitos, cti, num) {
    var chave = cti + '_' + num;
    var dados = dadosLeitos[chave];
    
    if (!dados || !dados.nome || !dados.nome.trim()) {
        return { ocupado: false };
    }
    
    var dias = 0;
    if (dados.datahora_admissao) {
        var admissao = new Date(dados.datahora_admissao);
        var hoje = new Date();
        dias = Math.ceil(Math.abs(hoje - admissao) / (1000 * 60 * 60 * 24));
    }
    
    return {
        ocupado: true,
        nome: dados.nome,
        dias: dias,
        idade: dados.idade || '',
        sexo: dados.sexo || ''
    };
}
function gerarCardLeito(cti, num, info) {
    var cor = info.ocupado ? '#ffebee' : '#e8f5e9';
    var borderCor = info.ocupado ? '#ef9a9a' : '#a5d6a7';
    var statusIcon = info.ocupado ? 'üî¥' : 'üü¢';
    
    var html = '<div style="background: ' + cor + '; border: 2px solid ' + borderCor + '; border-radius: 8px; padding: 12px; cursor: pointer;" onclick="irParaLeito(\'' + cti + '\',' + num + ')">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
    html += '<strong style="font-size: 16px;">' + statusIcon + ' Leito ' + num + '</strong>';
    
    if (info.ocupado && info.dias !== undefined) {
        var corDias = info.dias > 7 ? '#c62828' : (info.dias > 3 ? '#f57c00' : '#2e7d32');
        html += '<span style="background: ' + corDias + '; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">D' + info.dias + '</span>';
    }
    
    html += '</div>';
    
    if (info.ocupado) {
        html += '<div style="font-size: 14px; color: #333;">' + info.nome + '</div>';
        var detalhes = [];
        if (info.idade) detalhes.push(info.idade + ' anos');
        if (info.sexo) detalhes.push(info.sexo === 'M' ? 'Masc' : 'Fem');
        if (detalhes.length > 0) {
            html += '<div style="font-size: 12px; color: #666;">' + detalhes.join(' | ') + '</div>';
        }
    } else {
        html += '<div style="font-size: 14px; color: #4caf50;">Dispon√≠vel</div>';
    }
    
    html += '</div>';
    return html;
}
function irParaLeito(cti, num) {
    fecharModalResumoCTI();
    
    document.getElementById('seletorCTI').value = cti;
    ctiAtual = cti;
    atualizarSelectLeitos();
    
    setTimeout(function() {
        document.getElementById('seletorLeito').value = num;
        leitoAtual = num;
        carregarLeito();
        atualizarTitulo();
    }, 500);
}

// ========== GEST√ÉO DE USU√ÅRIOS (ADMIN) ==========

function verUsuarios() {
    if (!window.isAdmin) { // Acessa isAdmin via window
        alert('Acesso restrito a administradores.');
        return;
    }
    
    var modal = document.getElementById('modalUsuarios');
    if (modal) {
        renderizarListaUsuarios();
        modal.style.display = 'flex';
    }
}

function fecharModalUsuarios() {
    var modal = document.getElementById('modalUsuarios');
    if (modal) modal.style.display = 'none';
}
function renderizarListaUsuarios() {
    var container = document.getElementById('listaUsuarios');
    if (!container) return;
    
    container.innerHTML = '<div style="text-align: center; padding: 20px;">Carregando...</div>';
    
    window.db.collection('usuarios').get() // Acessa db via window
        .then(function(snapshot) {
            var html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
            html += '<thead><tr style="background: #1565c0; color: white;">';
            html += '<th style="padding: 10px; text-align: left;">Nome</th>';
            html += '<th style="padding: 10px; text-align: left;">E-mail</th>';
            html += '<th style="padding: 10px; text-align: center;">Admin</th>';
            html += '</tr></thead><tbody>';
            
            snapshot.forEach(function(doc) {
                var usuario = doc.data();
                html += '<tr style="border-bottom: 1px solid #ddd;">';
                html += '<td style="padding: 10px;">' + (usuario.nome || '-') + '</td>';
                html += '<td style="padding: 10px;">' + (usuario.email || '-') + '</td>';
                html += '<td style="padding: 10px; text-align: center;">' + (usuario.admin ? '‚úÖ' : '‚ùå') + '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(function(error) {
            container.innerHTML = '<div style="color: #c62828; padding: 20px;">Erro ao carregar usu√°rios.</div>';
        });
}
// ========== DIAS DE INTERNA√á√ÉO ==========

function atualizarDiasInternacao() {
    var divDias = document.getElementById('diasInternacao');
    if (!divDias) return;
    
    var dataAdm = document.getElementById('datahora_admissao');
    if (!dataAdm || !dataAdm.value) {
        divDias.textContent = '';
        return;
    }
    
    try {
        var admissao = new Date(dataAdm.value);
        var hoje = new Date();
        var diffTime = Math.abs(hoje - admissao);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
            divDias.textContent = 'üìÖ Admitido hoje';
        } else if (diffDays === 1) {
            divDias.textContent = 'üìÖ 1 dia de interna√ß√£o';
        } else {
            divDias.textContent = 'üìÖ ' + diffDays + ' dias de interna√ß√£o';
        }
    } catch(e) {
        divDias.textContent = '';
    }
}

// ========== EXPORTAR EXCEL ==========
function exportarAltasExcel() {
    window.db.collection('altas').orderBy('timestamp', 'desc').get() // Acessa db via window
        .then(function(snapshot) {
            if (snapshot.empty) {
                alert('N√£o h√° altas para exportar.');
                return;
            }
            
            var csv = 'Nome,CTI,Leito,Data Admiss√£o,Data Alta,Idade,Sexo\n';
            
            snapshot.forEach(function(doc) {
                var alta = doc.data();
                var nome = (alta.nome || '').replace(/"/g, '""');
                var cti = (alta.cti || '').replace('CTI', 'CTI ');
                var leito = alta.leito || '';
                var dataAdm = formatarData(alta.dataAdmissao);
                var dataAlta = alta.dataAlta || '';
                var idade = (alta.dados && alta.dados.idade) || '';
                var sexo = (alta.dados && alta.dados.sexo) || '';
                
                csv += '"' + nome + '","' + cti + '","' + leito + '","' + dataAdm + '","' + dataAlta + '","' + idade + '","' + sexo + '"\n';
            });
            
            var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'historico_altas_' + new Date().toISOString().slice(0,10) + '.csv';
            link.click();
        })
        .catch(function(error) {
            alert('Erro ao exportar: ' + error.message);
        });
}
// ========== NOVA EVOLU√á√ÉO ==========
function evoNovaEvolucao() {
    if (!confirm('Iniciar nova evolu√ß√£o?\n\nOs campos ser√£o limpos mantendo identifica√ß√£o e dados importantes.')) return;
    
    // Salvar antes
    salvarLeitoAtual();
    
    // Lista de campos para manter
    var manterCampos = [
        'nome', 'idade', 'sexo', 'peso', 'altura', 'imc', 'pbw', 'datahora_admissao',
        'evo_nome', 'evo_idade', 'evo_sexo', 'evo_peso', 'evo_altura', 'evo_imc', 'evo_pbw',
        'evo_comorbidades', 'evo_baseline', 'evo_alergias', 'evo_cirurgias',
        'evo_dx_principal', 'evo_motivo_uti', 'evo_problemas',
        'hma', 'hpp', 'alergias'
    ];
    
    var valoresManter = {};
    manterCampos.forEach(function(campo) {
        var el = document.querySelector('[name="' + campo + '"]') || document.getElementById(campo);
        if (el) valoresManter[campo] = el.value;
    });
    
    // Limpar campos (exceto os que devem manter)
    document.querySelectorAll("input, textarea, select").forEach(function(el) {
        if (el.id === 'seletorCTI' || el.id === 'seletorLeito') return;
        if (el.id === 'loginEmail' || el.id === 'loginPassword') return;
        
        var key = el.name || el.id;
        if (manterCampos.includes(key)) return;
        
        if (el.type === 'checkbox' || el.type === 'radio') {
            el.checked = false;
        } else {
            el.value = '';
        }
        if (el.tagName === 'SELECT') {
            el.selectedIndex = 0;
        }
    });
    
    // Restaurar valores mantidos
    for (var campo in valoresManter) {
        var el = document.querySelector('[name="' + campo + '"]') || document.getElementById(campo);
        if (el) el.value = valoresManter[campo];
    }
    
    // Atualizar data/hora da evolu√ß√£o
    var dataEvo = document.querySelector('[name="evo_data"]');
    if (dataEvo) {
        var now = new Date();
        dataEvo.value = now.getFullYear() + '-' + 
            String(now.getMonth()+1).padStart(2,'0') + '-' + 
            String(now.getDate()).padStart(2,'0') + 'T' + 
            String(now.getHours()).padStart(2,'0') + ':' + 
            String(now.getMinutes()).padStart(2,'0');
    }
    
    window.scrollTo(0, 0);
    alert('Nova evolu√ß√£o iniciada!');
}
// Permitir login com Enter
document.addEventListener('DOMContentLoaded', function() {
    var loginPassword = document.getElementById('loginPassword');
    if (loginPassword) {
        loginPassword.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                fazerLogin();
            }
        });
    }
    
    var loginEmail = document.getElementById('loginEmail');
    if (loginEmail) {
        loginEmail.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginPassword').focus();
            }
        });
    }
});
</script>
<!-- MODAL: Lista de Altas -->
<div id="modalAltas" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
<div style="background: white; width: 90%; max-width: 1000px; max-height: 85%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
<div style="background: #1565c0; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">üìã Hist√≥rico de Altas</h2>
    <button onclick="fecharModalAltas()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
</div>
<div style="padding: 15px 20px; border-bottom: 1px solid #ddd; background: #f5f5f5;">
    <input type="text" id="buscaAltas" placeholder="üîç Buscar por nome do paciente..." oninput="filtrarAltas()" style="width: 100%; padding: 12px 15px; font-size: 15px; border: 1px solid #ccc; border-radius: 8px;">
</div>
<div style="padding: 10px 20px; background: #e3f2fd; display: flex; gap: 10px; flex-wrap: wrap;">
    <button onclick="exportarAltasExcel()" style="background: #2e7d32; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">üìä Exportar Excel</button>
    <span style="color: #666; font-size: 13px; align-self: center;" id="totalAltas"></span>
</div>
<div id="listaAltas" style="padding: 20px; overflow-y: auto; flex: 1;"></div>
</div>
</div>
<!-- MODAL: Detalhes da Alta -->
<div id="modalDetalhesAlta" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
<div style="background: white; width: 90%; max-width: 700px; max-height: 80%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
<div style="background: #1976d2; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">üìÑ Detalhes da Alta</h2>
    <button onclick="fecharModalDetalhes()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
</div>
<div style="padding: 20px; overflow-y: auto; flex: 1;">
    <textarea id="textareaDetalhesAlta" style="width: 100%; height: 400px; font-family: monospace; font-size: 13px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;" readonly></textarea>
</div>
<div style="padding: 15px 20px; border-top: 1px solid #ddd; display: flex; justify-content: flex-end; gap: 10px;">
    <button onclick="copiarDetalhesAlta()" style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">üìã Copiar</button>
    <button onclick="fecharModalDetalhes()" style="background: #607d8b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Fechar</button>
</div>
</div>
</div>
<!-- MODAL: Resumo CTI -->
<div id="modalResumoCTI" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
<div style="background: white; width: 95%; max-width: 1200px; max-height: 90%; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
<div style="background: #26a69a; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
    <h2 style="margin: 0;">üìä Resumo do CTI - Quadro de Ocupa√ß√£o</h2>
    <button onclick="fecharModalResumoCTI()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
</div>
<div style="padding: 10px 20px; background: #e0f2f1; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
    <span id="resumoOcupacao" style="font-weight: bold;"></span>
    <button onclick="renderizarResumoCTI()" style="background: #00796b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">üîÑ Atualizar</button>
</div>
<div id="conteudoResumoCTI" style="padding: 20px; overflow-y: auto; flex: 1
