<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Sistema de Evolu√ß√£o e Admiss√£o CTI - Hospital Nossa Senhora da Sa√∫de / Intensivale">
<meta name="theme-color" content="#1565c0">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè•</text></svg>">
<title>Pass√¥metroUTI - Sistema de Evolu√ß√£o CTI</title>
<style>
    
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #fff;
      color: #111;
    }
    h1 { text-align: center; margin-bottom: 24px; }
    .section{
      border: 1px solid #ccc;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto 20px auto;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    .row{
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }
    .row.nowrap{ flex-wrap: nowrap; }
    label{
      display: flex;
      flex-direction: column;
      min-width: 140px;
    }
    input, select, textarea{
      padding: 6px;
      font-size: 14px;
      border: 1px solid #bbb;
      border-radius: 4px;
    }
    input[readonly]{ background: #eaeaea; }
    textarea{ width: 100%; resize: vertical; }
    .hidden{display:none !important;}
  
    .med-item{
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 220px;
      margin-right: 10px;
    }
    .dose-input{
      width: 110px;
      padding: 5px;
      font-size: 13px;
    }
button{
      padding: 10px 16px;
      font-size: 15px;
      border: 1px solid #777;
      border-radius: 6px;
      background: #f2f2f2;
      cursor: pointer;
    }
    button:hover{ filter: brightness(0.98); }
    
    .divider{
      margin-top: 22px;
      border-top: 3px solid #e5e7eb;
      padding-top: 14px;
    }
/* --- NOVOS ESTILOS PARA GERENCIAMENTO --- */
    #evoHistoryList .evo-item {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        margin: 5px 0;
        background: #f9f9f9;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #evoHistoryList h4 { margin: 10px 0 5px; }
/* --- ESTILO DE IMPRESS√ÉO (O SEGREDO M√ÅGICO) --- */
    @media print {
      /* Esconde bot√µes, √°reas de controle e t√≠tulos de se√ß√£o desnecess√°rios */
      button, .no-print, #evoHistoryList, .section h3, #status_save, #status_evo_save {
        display: none !important;
      }
      
      /* Remove bordas e fundos dos inputs para parecer texto corrido */
      input, textarea, select {
        border: none !important;
        background: transparent !important;
        resize: none;
        padding: 0;
        font-weight: bold;
        color: #000;
        appearance: none;
        -webkit-appearance: none;
        box-shadow: none !important;
      }
      
      /* For√ßa mostrar o valor selecionado no Select */
      select {
        -webkit-appearance: none;
        -moz-appearance: none;
        text-indent: 1px;
        text-overflow: '';
      }
/* Expande textareas para mostrar todo o texto sem barra de rolagem */
      textarea {
        height: auto;
        overflow: visible;
        display: block;
      }
/* Remove sombras e ajusta margens para o papel */
      .section {
        border: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 5px 0 !important;
        page-break-inside: avoid; /* Evita quebrar quadros no meio */
      }
      
      body {
        margin: 0;
        padding: 0;
        font-size: 11pt; /* Letra um pouco menor para caber mais */
      }
      
      /* Remove o fundo cinza da p√°gina */
      body, .section {
        background-color: white !important;
      }
    }
/* --- ESTILOS DO SISTEMA DE LOGIN --- */
    #loginOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1565c0, #0d47a1);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }
    
    #loginBox {
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }
    
    #loginBox h1 {
      color: #1565c0;
      margin-bottom: 10px;
    }
    
    #loginBox h3 {
      color: #666;
      font-weight: normal;
      margin-bottom: 30px;
    }
    
    #loginBox input {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    
    #loginBox input:focus {
      border-color: #1565c0;
      outline: none;
    }
    
    #loginBox button {
      width: 100%;
      padding: 15px;
      background: #1565c0;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    #loginBox button:hover {
      background: #0d47a1;
    }
    
    #loginError {
      color: #c62828;
      margin-top: 15px;
      font-size: 14px;
    }
    
    #userInfo {
      background: #e8f5e9;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #userInfo button {
      padding: 5px 12px;
      font-size: 12px;
      background: #ef5350;
      color: white;
      border: none;
    }
    
    .admin-only {
      display: none;
    }
    
    .sync-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      margin-left: 10px;
    }
    
    .sync-ok { background: #c8e6c9; color: #2e7d32; }
    .sync-error { background: #ffcdd2; color: #c62828; }
    .sync-pending { background: #fff9c4; color: #f57f17; }
</style>
<!-- Firebase SDKs (MODIFICADO) -->
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js"; // Adicionado para autentica√ß√£o
    import { getFirestore, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js"; // Adicionado para Firestore e serverTimestamp
// Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyB7Mt4NsiXOam36i5MgClhKa-IOimlQ4DE",
        authDomain: "gestaoutihnss.firebaseapp.com",
        projectId: "gestaoutihnss",
        storageBucket: "gestaoutihnss.firebasestorage.app",
        messagingSenderId: "664272211913",
        appId: "1:664272211913:web:66e30e6670126b3e51a218",
        measurementId: "G-K0ZB5KLRGY"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Expondo 'auth', 'db', 'serverTimestamp' e vari√°veis de estado para o escopo global
    // para que fun√ß√µes externas (que n√£o s√£o m√≥dulos) possam acess√°-los.
    window.auth = auth;
    window.db = db;
    window.serverTimestamp = serverTimestamp;
    window.currentUser = null;
    window.isAdmin = false;
// Listener de mudan√ßa de autentica√ß√£o (MOVIDO PARA DENTRO DO M√ìDULO E ADAPTADO)
    auth.onAuthStateChanged(function(user) {
        if (user) {
            // MOVER AQUI para garantir que a tela de login suma imediatamente
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            window.currentUser = user; // Atualiza a vari√°vel global
            
            db.collection('usuarios').doc(user.uid).get()
                .then(function(doc) {
                    let userName = user.email; // Default to email
                    if (doc.exists) {
                        window.isAdmin = doc.data().admin === true; // Atualiza a vari√°vel global
                        userName = doc.data().nome || user.email;
                    } else {
                        // Criar registro de usu√°rio se n√£o existir
                        db.collection('usuarios').doc(user.uid).set({
                            email: user.email,
                            nome: user.email.split('@')[0],
                            admin: false,
                            criadoEm: serverTimestamp() // Usa a fun√ß√£o serverTimestamp importada
                        });
                        window.isAdmin = false; // Atualiza a vari√°vel global
                    }
                    mostrarSistema(userName); // Passa o nome de usu√°rio determinado para a fun√ß√£o
                })
                .catch(function(error) {
                    console.error('Erro ao buscar ou criar usu√°rio Firestore:', error);
                    // Mesmo com erro no Firestore, o sistema principal deve carregar para um usu√°rio autenticado.
                    window.isAdmin = false; // Garante que isAdmin seja false em caso de erro
                    mostrarSistema(user.email); // Usa email se o nome n√£o puder ser obtido
                });
        } else {
            window.currentUser = null;
            window.isAdmin = false;
            document.getElementById('loginOverlay').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    });
</script>
</head>
<body>
<!-- TELA DE LOGIN -->
<div id="loginOverlay">
  <div id="loginBox">
    <div style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 20px;">
      <img src="img/HNSS.jpg" alt="Hospital Nossa Senhora da Sa√∫de" style="height: 80px;">
      <img src="img/intensivale.jpeg" alt="Intensivale" style="height: 70px;">
    </div>
    <h1>üè• Pass√¥metroUTI</h1>
    <h3>Sistema de Evolu√ß√£o CTI</h3>
    <input type="email" id="loginEmail" placeholder="E-mail" autocomplete="email">
    <input type="password" id="loginPassword" placeholder="Senha" autocomplete="current-password">
    <button onclick="fazerLogin()">Entrar</button>
    <div id="loginError"></div>
    <p style="margin-top: 20px; font-size: 12px; color: #999;">
      Acesso restrito a usu√°rios autorizados
    </p>
  </div>
</div>
<!-- CONTE√öDO PRINCIPAL (inicialmente oculto) -->
<div id="mainContent" style="display: none;">
<!-- SELETOR DE CTI E LEITO -->
<div class="section no-print" id="seletorLeitoSection" style="background: linear-gradient(135deg, #1565c0, #0d47a1); border: none; padding: 20px; margin-bottom: 30px;">
<div class="row nowrap" style="justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap;">
<div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <div style="color: white; font-size: 18px; font-weight: bold;">üè•</div>
    <!-- CTI selector removed -->
    <label style="min-width: auto;">
        <span style="color: white; font-weight: bold;">Leito:</span>
        <select id="seletorLeito" onchange="trocarLeito()" style="font-size: 16px; padding: 10px 15px; font-weight: bold; min-width: 100px;">
            <!-- Options will be generated by JS -->
        </select>
    </label>
    <div id="statusLeito" style="color: #a5d6a7; font-size: 14px;"></div>
    <div id="diasInternacao" style="color: #ffeb3b; font-size: 14px; font-weight: bold;"></div>
    <span id="syncStatus" class="sync-status sync-ok">‚úì Sincronizado</span>
</div>
<div id="userInfoDisplay" style="color: white; font-size: 13px; display: flex; align-items: center; gap: 10px;">
</div>
</div>
<div class="row nowrap" style="justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
<button onclick="verResumoCTI()" type="button" style="background: #26a69a; color: white; font-weight: bold; padding: 10px 20px;">
    üìä Resumo CTI
</button>
<button onclick="darAlta()" type="button" style="background: #ff5722; color: white; font-weight: bold; padding: 10px 20px;">
    üè† Dar Alta
</button>
<button onclick="verAltas()" type="button" style="background: #78909c; color: white; padding: 10px 20px;">
    üìã Ver Altas
</button>
<button onclick="verUsuarios()" type="button" class="admin-only" style="background: #7b1fa2; color: white; padding: 10px 20px;">
    üë• Usu√°rios
</button>
</div>
</div>
<!-- Cabe√ßalho com Logos (MODIFICADO) -->
<div class="no-print" style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto 20px auto; padding: 10px 20px;">
  <img src="img/HNSS.jpg" alt="Hospital Nossa Senhora da Sa√∫de" style="height: 60px;">
  <h1 id="tituloLeito" style="margin: 0; flex: 1; text-align: center;">Admiss√£o CTI Adulto</h1>
  <img src="img/intensivale.jpeg" alt="Intensivale" style="height: 60px;">
</div>
<!-- SE√á√ÉO DE ADMISS√ÉO (colaps√°vel) -->
<div id="admissaoWrapper">
<!-- Barra de controle da admiss√£o -->
<div id="admissaoHeader" class="section no-print" style="background: #e3f2fd; border: 2px solid #1565c0; margin-bottom: 0; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; padding: 12px 20px;">
<div style="display: flex; align-items: center; gap: 15px;">
    <h3 style="margin: 0; color: #1565c0;">üìã Dados de Admiss√£o</h3>
    <span id="admissaoResumo" style="color: #666; font-size: 14px;"></span>
</div>
<div style="display: flex; gap: 10px;">
    <button type="button" onclick="salvarAdmissao()" style="background: #4caf50; color: white; font-weight: bold;">üíæ Salvar Admiss√£o</button>
    <button type="button" onclick="novaEvolucaoRapida()" style="background: #ff9800; color: white; font-weight: bold;">üìù Nova Evolu√ß√£o</button>
<button type="button" id="btnToggleAdmissao" onclick="toggleAdmissao()" style="background: #1565c0; color: white;">üîΩ Recolher</button>
</div>
</div>
<!-- Conte√∫do da admiss√£o -->
<div id="admissaoConteudo">
<!-- Identifica√ß√£o -->
<div class="section" style="margin-top: 0; border-radius: 0;">
<h3>Identifica√ß√£o do Paciente</h3>
<div class="row nowrap">
<label style="flex: 3; min-width: 420px;">Nome:
      <input name="nome" style="width: 100%;" type="text"/>
</label>
<label style="width: 70px; min-width: 70px;">Idade:
      <input id="idade" name="idade" style="width: 100%;" type="number"/>
</label>
<label style="width: 110px; min-width: 110px;">Sexo:
      <select id="sexo" name="sexo" onchange="calcularPBW()" style="width: 100%;">
<option value="">Selecione</option>
<option value="M">Masculino</option>
<option value="F">Feminino</option>
</select>
</label>
<label style="min-width: 260px;">Data/hora admiss√£o:
      <input id="datahora_admissao" name="datahora_admissao" type="datetime-local"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 170px;">Peso (kg):
      <input id="peso" name="peso" oninput="calcularIMC(); calcularPBW();" type="number"/>
</label>
<label style="min-width: 170px;">Altura (cm):
      <input id="altura" name="altura" oninput="calcularIMC(); calcularPBW();" type="number"/>
</label>
<label style="min-width: 170px;">IMC:
      <input id="imc" name="imc" readonly="" type="text"/>
</label>
<label style="min-width: 220px;">Peso Predito (PBW):
      <input id="pbw" name="peso_predito" readonly="" type="text"/>
</label>
</div>
</div>
<!-- Hist√≥ria cl√≠nica -->
<div class="section">
<h3>Hist√≥ria Cl√≠nica</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">HMA (Hist√≥ria da Mol√©stia Atual):
      <textarea name="hma" rows="6"></textarea>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">HPP (Hist√≥ria Patol√≥gica Pregressa):
      <textarea name="hpp" rows="6"></textarea>
</label>
</div>
<!-- Cirurgias pr√©vias fica abaixo do HPP -->
<div class="row">
<label style="flex: 1; min-width: 100%;">Cirurgias pr√©vias:
      <textarea name="cirurgias" rows="4"></textarea>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Medica√ß√µes de uso domiciliar:
      <textarea name="med_dom" rows="4"></textarea>
</label>
</div>
<!-- Alergias: tudo na mesma linha; textarea aparece s√≥ se Sim -->
<div class="row nowrap" style="align-items: flex-start;">
<div style="min-width: 90px;">Alergias:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="alergias_check" onclick="toggleAlergiaCampo(true)" type="radio" value="sim"/> Sim
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="alergias_check" onclick="toggleAlergiaCampo(false)" type="radio" value="nao"/> N√£o
    </label>
<div class="hidden" id="campoAlergia" style="flex: 1;">
<textarea name="alergias" rows="2" style="width: 100%;"></textarea>
</div>
</div>
</div>
<!-- Exames de imagem: deve vir abaixo do campo alergias (quadro separado) -->
<div class="section">
<h3>Exames de Imagem (Admiss√£o)</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">ECG admiss√£o:
      <textarea name="ecg_admissao" rows="3"></textarea>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Rx t√≥rax admiss√£o:
      <textarea name="rx_torax_admissao" rows="3"></textarea>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">POCUS admiss√£o:
      <textarea name="pocus_admissao" rows="3"></textarea>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Outros relevantes:
      <textarea name="img_outros" rows="3"></textarea>
</label>
</div>
</div>
<!-- Laborat√≥rio -->
<div class="section">
<h3>Laborat√≥rio (Admiss√£o)</h3>
<div class="row nowrap">
<label style="min-width: 180px;">Hemoglobina:
      <input name="hb" type="text"/>
</label>
<label style="min-width: 180px;">Leuc√≥citos:
      <input name="leuco" type="text"/>
</label>
<label style="min-width: 180px;">Plaquetas:
      <input name="plaquetas" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 180px;">Ureia:
      <input name="ureia" type="text"/>
</label>
<label style="min-width: 180px;">Creatinina:
      <input name="creatinina" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 160px;">Na+:
      <input name="na" type="text"/>
</label>
<label style="min-width: 160px;">K+:
      <input name="k" type="text"/>
</label>
<label style="min-width: 160px;">Mg++:
      <input name="mg" type="text"/>
</label>
<label style="min-width: 160px;">Ca++:
      <input name="ca" type="text"/>
</label>
<label style="min-width: 160px;">F√≥sforo:
      <input name="fosforo" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 180px;">INR:
      <input name="inr" type="text"/>
</label>
<label style="min-width: 180px;">PTT:
      <input name="ptt" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 180px;">BT:
      <input name="bt" type="text"/>
</label>
<label style="min-width: 180px;">BD:
      <input name="bd" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 180px;">TGO:
      <input name="tgo" type="text"/>
</label>
<label style="min-width: 180px;">TGP:
      <input name="tgp" type="text"/>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Outros relevantes:
      <textarea name="lab_outros" rows="4"></textarea>
</label>
</div>
</div>
<!-- Exames pr√©vios relevantes -->
<div class="section">
<h3>Exames Pr√©vios Relevantes</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Exames pr√©vios relevantes:
      <textarea name="exames_previos_relevantes" rows="4"></textarea>
</label>
</div>
</div>
<!-- Exame f√≠sico -->
<div class="section">
<h3>Exame F√≠sico</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Exame f√≠sico:
      <textarea name="exame_fisico" rows="8"></textarea>
</label>
</div>
</div>
<!-- Respirat√≥rio -->
<div class="section">
<h3>Respirat√≥rio</h3>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 90px;">Suporte:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="resp_suporte" onclick="toggleResp('Ar ambiente')" type="radio" value="Ar ambiente"/> Ar ambiente
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="resp_suporte" onclick="toggleResp('VM')" type="radio" value="VM"/> VM
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="resp_suporte" onclick="toggleResp('Venturi')" type="radio" value="Venturi"/> Venturi
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="resp_suporte" onclick="toggleResp('CN')" type="radio" value="CN"/> CN
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="resp_suporte" onclick="toggleResp('MR')" type="radio" value="MR"/> MR
    </label>
<!-- Campos espec√≠ficos aparecem √† direita conforme sele√ß√£o -->
<div class="hidden" id="resp_venturi" style="flex: 1;">
<div class="row nowrap" style="margin: 0;">
<label style="min-width: 220px;">FiO2 (Venturi):
          <input name="venturi_fio2" type="text"/>
</label>
</div>
</div>
<div class="hidden" id="resp_cn" style="flex: 1;">
<div class="row nowrap" style="margin: 0;">
<label style="min-width: 220px;">Litros (CN):
          <input name="cn_litros" type="text"/>
</label>
</div>
</div>
<div class="hidden" id="resp_mr" style="flex: 1;">
<div class="row nowrap" style="margin: 0;">
<label style="min-width: 220px;">Litros (MR):
          <input name="mr_litros" type="text"/>
</label>
</div>
</div>
</div>
<!-- VM: campos detalhados -->
<div class="hidden" id="resp_vm">
<div class="row nowrap">
<label style="min-width: 240px;">Modo ventilat√≥rio:
        <input name="vm_modo" type="text"/>
</label>
<label style="min-width: 180px;">Pinsp/PS:
        <input name="vm_pinsp_ps" type="text"/>
</label>
<label style="min-width: 160px;">VC:
        <input name="vm_vc" type="text"/>
</label>
<label style="min-width: 160px;">FR:
        <input name="vm_fr" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 160px;">PEEP:
        <input name="vm_peep" type="text"/>
</label>
<label style="min-width: 160px;">FiO2:
        <input name="vm_fio2" type="text"/>
</label>
<label style="min-width: 160px;">Ppico:
        <input name="vm_ppico" type="text"/>
</label>
<label style="min-width: 160px;">Pplat√¥:
        <input name="vm_pplato" type="text"/>
</label>
<label style="min-width: 200px;">Drive Pressure:
        <input name="vm_drive" type="text"/>
</label>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<label style="flex-direction: row; align-items: center; gap: 10px; min-width: 360px;">
<input id="chk_gaso" onclick="toggleGasometria()" type="checkbox"/> √öltima gasometria relevante (preencher)
    </label>
</div>
<div class="hidden" id="gaso_fields">
<div class="row nowrap">
<label style="min-width: 120px;">pH:
        <input name="gas_ph" type="text"/>
</label>
<label style="min-width: 120px;">pO2:
        <input name="gas_po2" type="text"/>
</label>
<label style="min-width: 120px;">pCO2:
        <input name="gas_pco2" type="text"/>
</label>
<label style="min-width: 140px;">HCO3:
        <input name="gas_hco3" type="text"/>
</label>
<label style="min-width: 120px;">BE:
        <input name="gas_be" type="text"/>
</label>
<label style="min-width: 120px;">sO2:
        <input name="gas_so2" type="text"/>
</label>
</div>
</div>
</div>
<!-- Hemodin√¢mica -->
<div class="section">
<h3>Hemodin√¢mica</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Ritmo no monitor:
      <input name="hemo_ritmo" style="width: 100%;" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 180px;">PA:
      <input name="hemo_pa" type="text"/>
</label>
<label style="min-width: 180px;">FC:
      <input name="hemo_fc" type="text"/>
</label>
<label style="min-width: 180px;">SpO2:
      <input name="hemo_spo2" type="text"/>
</label>
</div>
<div class="row" style="align-items: center;">
<div style="min-width: 260px;">Vasoativos / Inotr√≥picos:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 160px;">
<input id="chk_dobutamina" onclick="toggleHemoDrug('dobutamina')" type="checkbox"/> Dobutamina
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 160px;">
<input id="chk_milrinona" onclick="toggleHemoDrug('milrinona')" type="checkbox"/> Milrinona
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 190px;">
<input id="chk_noradrenalina" onclick="toggleHemoDrug('noradrenalina')" type="checkbox"/> Noradrenalina
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 170px;">
<input id="chk_vasopressina" onclick="toggleHemoDrug('vasopressina')" type="checkbox"/> Vasopressina
    </label>
</div>
<div class="row hidden" id="drug_dobutamina">
<label style="flex: 1; min-width: 100%;">Dobutamina (dose / observa√ß√µes):
      <input name="dobutamina_dose" style="width: 100%;" type="text"/>
</label>
</div>
<div class="row hidden" id="drug_milrinona">
<label style="flex: 1; min-width: 100%;">Milrinona (dose / observa√ß√µes):
      <input name="milrinona_dose" style="width: 100%;" type="text"/>
</label>
</div>
<div class="row hidden" id="drug_noradrenalina">
<label style="flex: 1; min-width: 100%;">Noradrenalina (dose / observa√ß√µes):
      <input name="noradrenalina_dose" style="width: 100%;" type="text"/>
</label>
</div>
<div class="row hidden" id="drug_vasopressina">
<label style="flex: 1; min-width: 100%;">Vasopressina (dose / observa√ß√µes):
      <input name="vasopressina_dose" style="width: 100%;" type="text"/>
</label>
</div>
<div class="row" style="align-items: center;">
<div style="min-width: 120px;">Perfus√£o:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 150px;">
<input id="chk_perf" onclick="togglePerfusao()" type="checkbox"/> Preencher
    </label>
<div class="hidden" id="perf_fields" style="flex: 1;">
<div class="row nowrap" style="margin: 0;">
<label style="min-width: 180px;">Lactato:
          <input name="perf_lactato" type="text"/>
</label>
<label style="min-width: 180px;">SvcO2:
          <input name="perf_svco2" type="text"/>
</label>
<label style="min-width: 180px;">GapCO2:
          <input name="perf_gapco2" type="text"/>
</label>
</div>
</div>
</div>
</div>
<!-- Infec√ß√£o -->
<div class="section">
<h3>Infec√ß√£o</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Foco prov√°vel/confirmado:
      <input name="inf_foco" style="width: 100%;" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: flex-end;">
<label style="flex: 2; min-width: 380px;">Antimicrobiano 1:
      <input name="inf_atb1" placeholder="Ex: Piperacilina-tazobactam" style="width: 100%;" type="text"/>
</label>
<label style="min-width: 140px;">D:
      <input name="inf_dia_atb1" placeholder="ex: 3" type="number"/>
</label>
<div style="min-width: 50px; padding-bottom: 8px;">de</div>
<label style="min-width: 140px;">:
      <input name="inf_total_atb1" placeholder="ex: 7" type="number"/>
</label>
</div>
<div class="row nowrap" style="align-items: flex-end;">
<label style="flex: 2; min-width: 380px;">Antimicrobiano 2:
      <input name="inf_atb2" placeholder="(opcional)" style="width: 100%;" type="text"/>
</label>
<label style="min-width: 140px;">D:
      <input name="inf_dia_atb2" type="number"/>
</label>
<div style="min-width: 50px; padding-bottom: 8px;">de</div>
<label style="min-width: 140px;">:
      <input name="inf_total_atb2" type="number"/>
</label>
</div>
<div class="row nowrap" style="align-items: flex-end;">
<label style="flex: 2; min-width: 380px;">Antimicrobiano 3:
      <input name="inf_atb3" placeholder="(opcional)" style="width: 100%;" type="text"/>
</label>
<label style="min-width: 140px;">D:
      <input name="inf_dia_atb3" type="number"/>
</label>
<div style="min-width: 50px; padding-bottom: 8px;">de</div>
<label style="min-width: 140px;">:
      <input name="inf_total_atb3" type="number"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 170px;">Culturas coletadas?</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="inf_culturas" onclick="toggleCulturas(true)" type="radio" value="sim"/> Sim
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="inf_culturas" onclick="toggleCulturas(false)" type="radio" value="nao"/> N√£o
    </label>
<div class="hidden" id="culturas_sim" style="flex: 1;">
<div class="row nowrap" style="margin: 0; gap: 14px;">
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 140px;">
<input name="cult_urina" type="checkbox"/> Urina
        </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 160px;">
<input name="cult_hemo" type="checkbox"/> Hemocultura
        </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 220px;">
<input name="cult_traqueal" type="checkbox"/> Secre√ß√£o traqueal
        </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: 120px;">
<input id="cult_outros_chk" name="cult_outros_chk" onclick="toggleCultOutros()" type="checkbox"/> Outros
        </label>
<div class="hidden" id="cult_outros_txt_wrap" style="flex: 1;">
<input name="cult_outros_txt" placeholder="Quais?" style="width: 100%;" type="text"/>
</div>
</div>
</div>
<div class="hidden" id="culturas_nao" style="flex: 1;">
<input name="culturas_motivo" placeholder="Motivo de n√£o ter sido coletado" style="width: 100%;" type="text"/>
</div>
</div>
</div>
<!-- Neuro / Dor / Seda√ß√£o / Delirium -->
<div class="section">
<h3>Neuro / Dor / Seda√ß√£o / Delirium</h3>
<div class="row nowrap" style="align-items: flex-end;">
<div style="min-width: 210px; padding-bottom: 8px;">Escala de Glasgow:</div>
<label style="min-width: 90px;">AO
      <input id="glasgow_ao" min="0" name="glasgow_ao" oninput="calcGlasgow()" type="number"/>
</label>
<label style="min-width: 90px;">RV
      <input id="glasgow_rv" min="0" name="glasgow_rv" oninput="calcGlasgow()" type="number"/>
</label>
<label style="min-width: 90px;">RM
      <input id="glasgow_rm" min="0" name="glasgow_rm" oninput="calcGlasgow()" type="number"/>
</label>
<label style="min-width: 140px;">Total
      <input id="glasgow_total" name="glasgow_total" readonly="" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 200px;">RASS atual:
      <input name="rass_atual" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 120px;">Delirium:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="delirium" onclick="toggleDelirium(true)" type="radio" value="sim"/> Sim
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="delirium" onclick="toggleDelirium(false)" type="radio" value="nao"/> N√£o
    </label>
<div class="hidden" id="delirium_tipos" style="display: flex; align-items: center; gap: 16px; margin-left: 10px;">
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="del_hiper" name="del_hiper" type="checkbox"/> Hiperativo
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="del_hipo" name="del_hipo" type="checkbox"/> Hipoativo
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="del_misto" name="del_misto" type="checkbox"/> Misto
      </label>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 260px;">Analgesia / seda√ß√£o em uso:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="analg_sed" onclick="toggleAnalgesia(true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="analg_sed" onclick="toggleAnalgesia(false)" type="radio" value="nao"/> N√£o
      </label>
<div class="hidden" id="analgesia_lista" style="flex: 1;">
<div class="row" style="margin: 0; gap: 14px; flex-wrap: wrap;">
<div class="med-item">
<input id="med_dipirona" name="med_dipirona" onclick="toggleDose('med_dipirona','dose_med_dipirona')" type="checkbox"/>
<span>Dipirona</span>
<input class="dose-input hidden" id="dose_med_dipirona" name="dose_med_dipirona" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_tramadol" name="med_tramadol" onclick="toggleDose('med_tramadol','dose_med_tramadol')" type="checkbox"/>
<span>Tramadol</span>
<input class="dose-input hidden" id="dose_med_tramadol" name="dose_med_tramadol" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_tylex" name="med_tylex" onclick="toggleDose('med_tylex','dose_med_tylex')" type="checkbox"/>
<span>Tylex</span>
<input class="dose-input hidden" id="dose_med_tylex" name="dose_med_tylex" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_metadona" name="med_metadona" onclick="toggleDose('med_metadona','dose_med_metadona')" type="checkbox"/>
<span>Metadona</span>
<input class="dose-input hidden" id="dose_med_metadona" name="dose_med_metadona" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_diazepam" name="med_diazepam" onclick="toggleDose('med_diazepam','dose_med_diazepam')" type="checkbox"/>
<span>Diazepam</span>
<input class="dose-input hidden" id="dose_med_diazepam" name="dose_med_diazepam" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_clonazepam" name="med_clonazepam" onclick="toggleDose('med_clonazepam','dose_med_clonazepam')" type="checkbox"/>
<span>Clonazepam</span>
<input class="dose-input hidden" id="dose_med_clonazepam" name="dose_med_clonazepam" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_quetiapina" name="med_quetiapina" onclick="toggleDose('med_quetiapina','dose_med_quetiapina')" type="checkbox"/>
<span>Quetiapina</span>
<input class="dose-input hidden" id="dose_med_quetiapina" name="dose_med_quetiapina" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_risperidona" name="med_risperidona" onclick="toggleDose('med_risperidona','dose_med_risperidona')" type="checkbox"/>
<span>Risperidona</span>
<input class="dose-input hidden" id="dose_med_risperidona" name="dose_med_risperidona" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_ketamina" name="med_ketamina" onclick="toggleDose('med_ketamina','dose_med_ketamina')" type="checkbox"/>
<span>Ketamina</span>
<input class="dose-input hidden" id="dose_med_ketamina" name="dose_med_ketamina" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_midazolam" name="med_midazolam" onclick="toggleDose('med_midazolam','dose_med_midazolam')" type="checkbox"/>
<span>Midazolam</span>
<input class="dose-input hidden" id="dose_med_midazolam" name="dose_med_midazolam" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_fentanil" name="med_fentanil" onclick="toggleDose('med_fentanil','dose_med_fentanil')" type="checkbox"/>
<span>Fentanil</span>
<input class="dose-input hidden" id="dose_med_fentanil" name="dose_med_fentanil" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_remifentanil" name="med_remifentanil" onclick="toggleDose('med_remifentanil','dose_med_remifentanil')" type="checkbox"/>
<span>Remifentanil</span>
<input class="dose-input hidden" id="dose_med_remifentanil" name="dose_med_remifentanil" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_precedex" name="med_precedex" onclick="toggleDose('med_precedex','dose_med_precedex')" type="checkbox"/>
<span>Precedex</span>
<input class="dose-input hidden" id="dose_med_precedex" name="dose_med_precedex" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_propofol" name="med_propofol" onclick="toggleDose('med_propofol','dose_med_propofol')" type="checkbox"/>
<span>Propofol</span>
<input class="dose-input hidden" id="dose_med_propofol" name="dose_med_propofol" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_rocuronio" name="med_rocuronio" onclick="toggleDose('med_rocuronio','dose_med_rocuronio')" type="checkbox"/>
<span>Rocur√¥nio</span>
<input class="dose-input hidden" id="dose_med_rocuronio" name="dose_med_rocuronio" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="med_cisatracurio" name="med_cisatracurio" onclick="toggleDose('med_cisatracurio','dose_med_cisatracurio')" type="checkbox"/>
<span>Cisatrac√∫rio</span>
<input class="dose-input hidden" id="dose_med_cisatracurio" name="dose_med_cisatracurio" placeholder="dose" type="text"/>
</div>
</div>
</div>
</div>
<!-- Invasivos / Dispositivos -->
<div class="section">
<h3>Invasivos / Dispositivos</h3>
<div class="row nowrap">
<label style="min-width: 260px;">CVC (local):
      <input name="cvc_local" type="text"/>
</label>
<label style="min-width: 140px;">Dia:
      <input name="cvc_dia" placeholder="ex: D2 / 12/01" type="text"/>
</label>
<label style="min-width: 260px;">Cateter arterial (local):
      <input name="art_local" type="text"/>
</label>
<label style="min-width: 140px;">Dia:
      <input name="art_dia" placeholder="ex: D1 / 12/01" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 260px;">Cateter de HD (local):
      <input name="hd_local" type="text"/>
</label>
<label style="min-width: 140px;">Dia:
      <input name="hd_dia" placeholder="ex: D1 / 12/01" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 220px;">SVD (dia):
      <input name="svd_dia" placeholder="ex: D3 / 12/01" type="text"/>
</label>
<label style="min-width: 220px;">TOT/TQT (dia):
      <input name="tot_tqt_dia" placeholder="ex: D5 / 12/01" type="text"/>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Drenos / outros:
      <textarea name="drenos_outros" rows="3"></textarea>
</label>
</div>
</div>
<!-- Plano / Metas -->
<div class="section">
<h3>Plano / Metas</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Diagn√≥stico(s) de interna√ß√£o:
      <textarea name="diagnostico_internacao" rows="3"></textarea>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Plano / metas:
      <textarea name="plano_metas" rows="6"></textarea>
</label>
</div>
</div>
<!-- A√ß√µes -->
<div class="section">
<h3>A√ß√µes</h3>
<div class="row nowrap" style="justify-content: flex-start; gap: 14px;">
<button onclick="gerarTexto()" type="button">Transformar em texto</button>
<span id="status_save" style="margin-left: 10px; color: #0b6;"> </span>
</div>
<!-- Painel: Texto para copiar (n√£o bloqueia a p√°gina) -->
<div class="section hidden" id="painelTexto">
<h3 style="margin-top: 0;">Texto para copiar</h3>
<div class="row">
<textarea id="textoGerado" rows="16" style="width: 100%;"></textarea>
</div>
<div class="row nowrap" style="justify-content: flex-end; gap: 10px;">
<button onclick="copiarTexto()" type="button">Copiar</button>
<button onclick="fecharPainelTexto()" type="button">Fechar</button>
</div>
</div>
</div><!-- Fecha se√ß√£o A√ß√µes -->
</div><!-- Fecha admissaoConteudo -->
</div><!-- Fecha admissaoWrapper -->
<!-- ===== Evolu√ß√£o di√°ria (Diurna/Noturna) ===== -->
<div class="section divider" id="divisor-adm-evo"><h3>Evolu√ß√£o di√°ria</h3></div>
<div class="section hidden" id="evolucaoArea">
<h3 style="margin-top: 0;">Evolu√ß√£o di√°ria</h3>
<div class="row nowrap" style="align-items: center; gap: 14px;">
<div style="min-width: 80px;">Turno:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_turno" type="radio" value="Diurna"/> Diurna
    </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_turno" type="radio" value="Noturna"/> Noturna
    </label>
<label style="margin-left: 18px; flex-direction: row; align-items: center; gap: 8px; min-width: 220px;">
      Data/hora: <input name="evo_data" type="datetime-local"/>
</label>
<div style="flex: 1;"></div>
<button onclick="fecharEvolucao()" type="button">Fechar</button>
</div>
<div class="row nowrap" style="gap: 10px;">
<span id="status_evo_save" style="margin-left: 10px; color: #0b6;"></span>
</div>
<!-- Cabe√ßalho -->
<div class="row nowrap">
<label style="flex: 1; min-width: 420px;">Nome:
      <input name="evo_nome" readonly="" type="text"/>
</label>
<label style="min-width: 140px;">Idade:
      <input name="evo_idade" readonly="" type="text"/>
</label>
<label style="min-width: 140px;">Sexo:
      <input name="evo_sexo" readonly="" type="text"/>
</label>
<label style="min-width: 150px;">Dia de UTI:
      <input name="evo_dia_uti" readonly="" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 200px;">Peso (kg):
      <input name="evo_peso" readonly="" type="text"/>
</label>
<label style="min-width: 220px;">Altura (cm):
      <input name="evo_altura" readonly="" type="text"/>
</label>
<label style="min-width: 200px;">IMC:
      <input name="evo_imc" readonly="" type="text"/>
</label>
<label style="min-width: 240px;">Peso ideal (PBW, kg):
      <input name="evo_pbw" readonly="" type="text"/>
</label>
</div>
<div class="section">
<h3>Motivo da interna√ß√£o na UTI</h3>
<div class="row">
<textarea name="evo_motivo_uti" rows="3" style="width: 100%;"></textarea>
</div>
</div>
<!-- Problemas ativos -->
<div class="section">
<h3>Problemas atuais</h3>
<div class="row nowrap" style="justify-content: flex-end;">
</div>
<div class="row">
<textarea name="evo_problemas" rows="5" style="width: 100%;"></textarea>
</div>
</div>
<!-- HPP -->
<div class="section">
<h3>HPP (Hist√≥ria Patol√≥gica Pregressa)</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Comorbidades relevantes:
        <textarea name="evo_comorbidades" rows="3"></textarea>
</label>
</div>
<div class="row">
<h3>Medica√ß√µes em uso</h3>
<textarea name="evo_meds" style="width:100%; height:130px;"></textarea>
</div>
<div class="row" style="margin-top: 14px;">
<label style="flex: 1; min-width: 100%;">Alergias:
        <textarea name="evo_alergias" rows="2"></textarea>
</label>
</div>
</div>
<!-- Ectoscopia -->
<div class="section">
<h3>Ectoscopia</h3>
<div class="row">
<textarea name="evo_ectoscopia" rows="3" style="width: 100%;"></textarea>
</label>
</div>
</div>
<!-- Respirat√≥rio -->
<div class="section">
<h3>Respirat√≥rio</h3>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 90px;">Suporte:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_resp_suporte" onclick="evoToggleRespSuporte('Ar ambiente')" type="radio" value="Ar ambiente"/> Ar ambiente
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_resp_suporte" onclick="evoToggleRespSuporte('VM')" type="radio" value="VM"/> VM
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_resp_suporte" onclick="evoToggleRespSuporte('Venturi')" type="radio" value="Venturi"/> Venturi
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_resp_suporte" onclick="evoToggleRespSuporte('CN')" type="radio" value="CN"/> CN
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_resp_suporte" onclick="evoToggleRespSuporte('MR')" type="radio" value="MR"/> MR
      </label>
<div style="flex: 1;"></div>
</div>
<div class="hidden" id="evo_resp_vm">
<div class="row nowrap">
<label style="min-width: 240px;">Modo ventilat√≥rio:
          <input name="evo_vm_modo" type="text"/>
</label>
<label style="min-width: 180px;">Pinsp/PS:
          <input name="evo_vm_pinsp_ps" type="text"/>
</label>
<label style="min-width: 160px;">VC:
          <input name="evo_vm_vc" type="text"/>
</label>
<label style="min-width: 160px;">FR:
          <input name="evo_vm_fr" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 160px;">PEEP:
          <input name="evo_vm_peep" type="text"/>
</label>
<label style="min-width: 160px;">FiO2:
          <input name="evo_vm_fio2" type="text"/>
</label>
<label style="min-width: 160px;">Ppico:
          <input name="evo_vm_ppico" type="text"/>
</label>
<label style="min-width: 160px;">Pplat√¥:
          <input name="evo_vm_pplato" type="text"/>
</label>
<label style="min-width: 200px;">Drive Pressure:
          <input name="evo_vm_drive" type="text"/>
</label>
</div>
</div>
<div class="hidden" id="evo_resp_venturi">
<div class="row nowrap">
<label style="min-width: 220px;">FiO2 (Venturi):
          <input name="evo_venturi_fio2" type="text"/>
</label>
</div>
</div>
<div class="hidden" id="evo_resp_cn">
<div class="row nowrap">
<label style="min-width: 220px;">Litros (CN):
          <input name="evo_cn_litros" type="text"/>
</label>
</div>
</div>
<div class="hidden" id="evo_resp_mr">
<div class="row nowrap">
<label style="min-width: 220px;">Litros (MR):
          <input name="evo_mr_litros" type="text"/>
</label>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<label style="flex-direction: row; align-items: center; gap: 10px; min-width: 360px;">
<input id="evo_gaso_check" onclick="evoToggleBox('evo_gaso_fields', this.checked)" type="checkbox"/> √öltima gasometria relevante (preencher)
      </label>
</div>
<div class="hidden" id="evo_gaso_fields">
<div class="row nowrap">
<label style="min-width: 120px;">pH:
          <input name="evo_gas_ph" type="text"/>
</label>
<label style="min-width: 120px;">pO2:
          <input name="evo_gas_po2" type="text"/>
</label>
<label style="min-width: 120px;">pCO2:
          <input name="evo_gas_pco2" type="text"/>
</label>
<label style="min-width: 140px;">HCO3:
          <input name="evo_gas_hco3" type="text"/>
</label>
<label style="min-width: 120px;">BE:
          <input name="evo_gas_be" type="text"/>
</label>
<label style="min-width: 120px;">sO2:
          <input name="evo_gas_so2" type="text"/>
</label>
</div>
</div>
<div class="row">
<label style="width: 100%;">Ausculta pulmonar:
        <input name="evo_ausculta_pulm" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 220px;">POCUS pulmonar do dia:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_pocus_pulm" onclick="evoToggleBox('evo_pocus_pulm_desc', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_pocus_pulm" onclick="evoToggleBox('evo_pocus_pulm_desc', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_pocus_pulm_desc" style="margin-top: 6px;">
<textarea name="evo_pocus_pulm_texto" placeholder="Descri√ß√£o do POCUS pulmonar" rows="2" style="width: 100%;"></textarea>
</div>
<div class="row nowrap" style="align-items: center; margin-top: 10px;">
<div style="min-width: 220px;">Rx t√≥rax do dia:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_rx_torax" onclick="evoToggleBox('evo_rx_torax_desc', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_rx_torax" onclick="evoToggleBox('evo_rx_torax_desc', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_rx_torax_desc" style="margin-top: 6px;">
<textarea name="evo_rx_torax_texto" placeholder="Descri√ß√£o do Rx de t√≥rax" rows="2" style="width: 100%;"></textarea>
</div>
</div>
<!-- Hemodin√¢mica -->
<div class="section">
<h3>Hemodin√¢mica</h3>
<div class="row nowrap">
<label style="min-width: 260px;">Ritmo no monitor:
        <input name="evo_hemo_ritmo" type="text"/>
</label>
<label style="min-width: 180px;">PA:
        <input name="evo_hemo_pa" type="text"/>
</label>
<label style="min-width: 140px;">FC:
        <input name="evo_hemo_fc" type="text"/>
</label>
<label style="min-width: 160px;">SpO2:
        <input name="evo_hemo_spo2" type="text"/>
</label>
</div>
<div class="row" style="align-items: center; gap: 10px;">
<div style="min-width: 260px;">Vasoativos/Inotr√≥picos:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="evo_chk_dobutamina" onclick="evoToggleHemoDrug('dobutamina')" type="checkbox"/> Dobutamina
      </label>
<div class="hidden" id="evo_drug_dobutamina" style="min-width: 220px;">
<input name="evo_dobutamina_dose" placeholder="dose" type="text"/>
</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="evo_chk_milrinona" onclick="evoToggleHemoDrug('milrinona')" type="checkbox"/> Milrinona
      </label>
<div class="hidden" id="evo_drug_milrinona" style="min-width: 220px;">
<input name="evo_milrinona_dose" placeholder="dose" type="text"/>
</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="evo_chk_noradrenalina" onclick="evoToggleHemoDrug('noradrenalina')" type="checkbox"/> Noradrenalina
      </label>
<div class="hidden" id="evo_drug_noradrenalina" style="min-width: 220px;">
<input name="evo_noradrenalina_dose" placeholder="dose" type="text"/>
</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input id="evo_chk_vasopressina" onclick="evoToggleHemoDrug('vasopressina')" type="checkbox"/> Vasopressina
      </label>
<div class="hidden" id="evo_drug_vasopressina" style="min-width: 220px;">
<input name="evo_vasopressina_dose" placeholder="dose" type="text"/>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<label style="flex-direction: row; align-items: center; gap: 10px; min-width: 240px;">
<input id="evo_chk_perf" onclick="evoTogglePerfusao()" type="checkbox"/> Perfus√£o (preencher)
      </label>
</div>
<div class="hidden" id="evo_perf_fields">
<div class="row nowrap">
<label style="min-width: 170px;">Lactato:
          <input name="evo_perf_lactato" type="text"/>
</label>
<label style="min-width: 170px;">SvcO2:
          <input name="evo_perf_svco2" type="text"/>
</label>
<label style="min-width: 170px;">GapCO2:
          <input name="evo_perf_gapco2" type="text"/>
</label>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 140px;">ECG do dia:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_ecg_dia" onclick="evoToggleBox('evo_ecg_txt_wrap', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_ecg_dia" onclick="evoToggleBox('evo_ecg_txt_wrap', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_ecg_txt_wrap" style="flex: 1;">
<textarea name="evo_ecg_txt" placeholder="Descrever ECG do dia" rows="2" style="width: 100%;"></textarea>
</div>
<div class="row nowrap" style="align-items: center; margin-top: 10px;">
<div style="min-width: 220px;">POCUS card√≠aco do dia:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_pocus_card" onclick="evoToggleBox('evo_pocus_card_desc', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_pocus_card" onclick="evoToggleBox('evo_pocus_card_desc', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_pocus_card_desc" style="margin-top: 6px;">
<textarea name="evo_pocus_card_texto" placeholder="Descri√ß√£o do POCUS card√≠aco" rows="2" style="width: 100%;"></textarea>
</div>
<div class="row nowrap" style="align-items: center; margin-top: 10px;">
<div style="min-width: 220px;">VExUS do dia:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_vexus" onclick="evoToggleBox('evo_vexus_desc', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_vexus" onclick="evoToggleBox('evo_vexus_desc', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_vexus_desc" style="margin-top: 6px;">
<textarea name="evo_vexus_texto" placeholder="Descri√ß√£o do VExUS" rows="2" style="width: 100%;"></textarea>
</div>
<!-- Marcapasso (kept as requested) -->
<div class="row nowrap" style="align-items: center; margin-top: 10px;">
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_marcapasso_check" type="checkbox" onclick="toggleHemoExtra('marcapasso')"/> Marcapasso
</label>
</div>
<div class="hidden" id="evo_marcapasso_wrap" style="margin-top: 6px;">
<div class="row nowrap" style="flex-wrap: wrap; gap: 10px;">
<label style="min-width: 140px;">Undersense:
      <input name="evo_mp_undersense" type="text" placeholder="sim/n√£o"/>
</label>
<label style="min-width: 180px;">Falha de captura:
      <input name="evo_mp_falha_captura" type="text" placeholder="sim/n√£o"/>
</label>
<label style="min-width: 140px;">Output:
      <input name="evo_mp_output" type="text" placeholder="mA"/>
</label>
<label style="min-width: 140px;">Sense:
      <input name="evo_mp_sense" type="text" placeholder="mV"/>
</label>
</div>
</div>
<!-- esCCO (kept as is) -->
<div class="row nowrap" style="align-items: center; margin-top: 10px;">
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_escco_check" type="checkbox" onclick="toggleHemoExtra('escco')"/> esCCO
</label>
</div>
<div class="hidden" id="evo_escco_wrap" style="margin-top: 6px;">
<div class="row nowrap" style="flex-wrap: wrap; gap: 10px;">
<label style="min-width: 140px;">esCCI:
      <input name="evo_escco_escci" type="text" placeholder="L/min/m¬≤"/>
</label>
<label style="min-width: 140px;">IRVS:
      <input name="evo_escco_irvs" type="text" placeholder="dyn¬∑s/cm‚Åµ/m¬≤"/>
</label>
</div>
</div>
</div>
<!-- Renal / Metab√≥lico -->
<div class="section">
<h3>Renal / Metab√≥lico</h3>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div style="min-width: 260px; font-weight: 700;">Per√≠odo (BH/Diurese):</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_renal_periodo" onclick="evoSetRenalPeriodo(12)" type="radio" value="12"/> 12h
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_renal_periodo" onclick="evoSetRenalPeriodo(24)" type="radio" value="24"/> 24h
      </label>
</div>
<div class="row nowrap">
<label style="min-width: 240px;"><span id="evo_bh_label">BH 24h</span> (mL):
        <input name="evo_bh_ml" type="text"/>
</label>
<label style="min-width: 240px;"><span id="evo_diurese_label">Diurese 24h</span> (mL):
        <input name="evo_diurese_ml" type="text"/>
</label>
<label style="min-width: 220px;">Ureia:
        <input name="evo_ureia" type="text"/>
</label>
<label style="min-width: 220px;">Creatinina:
        <input name="evo_creatinina" oninput="evoCalcularTFGeClCr()" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 260px;">TFG CKD-EPI (mL/min/1,73m¬≤):
            <input name="evo_tfg_ckd_epi" readonly="" type="text"/>
</label>
<label style="min-width: 260px;">ClCr Cockcroft-Gault (mL/min):
            <input name="evo_clcr_cg" readonly="" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 260px;">Terapia renal substitutiva:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_trs" onclick="evoToggleBox('evo_trs_tipo_wrap', false)" type="radio" value="nao"/> N√£o
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_trs" onclick="evoToggleBox('evo_trs_tipo_wrap', true)" type="radio" value="sim"/> Sim
      </label>
<div class="hidden" id="evo_trs_tipo_wrap" style="flex: 1;">
<input name="evo_trs_tipo" placeholder="tipo de TRS" type="text"/>
</div>
</div>
<div class="row nowrap">
<label style="min-width: 160px;">Na:
        <input name="evo_na" type="text"/>
</label>
<label style="min-width: 160px;">K:
        <input name="evo_k" type="text"/>
</label>
<label style="min-width: 160px;">Ca++:
        <input name="evo_ca" type="text"/>
</label>
<label style="min-width: 160px;">Mg++:
        <input name="evo_mg" type="text"/>
</label>
<label style="min-width: 160px;">F√≥sforo:
        <input name="evo_fosforo" type="text"/>
</label>
</div>
</div>
<!-- Infec√ß√£o -->
<div class="section">
<h3>Infec√ß√£o</h3>
<div class="row">
<label style="flex: 1; min-width: 100%;">Foco prov√°vel/confirmado:
        <input name="evo_inf_foco" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="flex: 1;">Antimicrobiano 1:
        <input name="evo_inf_atb1" type="text"/>
</label>
<label style="min-width: 150px;">D:
        <input name="evo_inf_dia_atb1" type="text"/>
</label>
<label style="min-width: 190px;">de:
        <input name="evo_inf_total_atb1" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="flex: 1;">Antimicrobiano 2:
        <input name="evo_inf_atb2" type="text"/>
</label>
<label style="min-width: 150px;">D:
        <input name="evo_inf_dia_atb2" type="text"/>
</label>
<label style="min-width: 190px;">de:
        <input name="evo_inf_total_atb2" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="flex: 1;">Antimicrobiano 3:
        <input name="evo_inf_atb3" type="text"/>
</label>
<label style="min-width: 150px;">D:
        <input name="evo_inf_dia_atb3" type="text"/>
</label>
<label style="min-width: 190px;">de:
        <input name="evo_inf_total_atb3" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 120px;">Culturas:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_culturas" onclick="evoToggleCulturas('pendentes')" type="radio" value="pendentes"/> Pendentes
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_culturas" onclick="evoToggleCulturas('negativas')" type="radio" value="negativas"/> Negativas
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_culturas" onclick="evoToggleCulturas('positivas')" type="radio" value="positivas"/> Positivas
</label>
<div class="hidden" id="evo_cult_pend_wrap" style="flex: 1;"><input name="evo_cult_pend_data" placeholder="data/hora da coleta (pendentes)" type="text" style="width: 100%;"/></div>
<div class="hidden" id="evo_cult_pos_wrap" style="flex: 1;">
<input name="evo_cult_pos_txt" placeholder="descrever culturas positivas" type="text"/>
</div>
</div>
<div class="row nowrap">
<label style="min-width: 220px;">Leuc√≥citos:
        <input name="evo_leuco" type="text"/>
</label>
<label style="min-width: 220px;">PCR:
        <input name="evo_pcr" type="text"/>
</label>
<label style="min-width: 240px;">Procalcitonina:
        <input name="evo_pct" type="text"/>
</label>
<label style="min-width: 220px;">Data:
        <input name="evo_pct_data" type="text"/>
</label>
</div>
</div>
<!-- Neuro / Seda√ß√£o -->
<div class="section">
<h3>Neuro / Dor / Seda√ß√£o / Delirium</h3>
<div class="row nowrap" style="align-items: flex-end;">
<div style="min-width: 210px; padding-bottom: 8px;">Escala de Glasgow:</div>
<label style="min-width: 90px;">AO
        <input id="evo_glasgow_ao" min="0" name="evo_glasgow_ao" oninput="evoCalcGlasgow()" type="number"/>
</label>
<label style="min-width: 90px;">RV
        <input id="evo_glasgow_rv" min="0" name="evo_glasgow_rv" oninput="evoCalcGlasgow()" type="number"/>
</label>
<label style="min-width: 90px;">RM
        <input id="evo_glasgow_rm" min="0" name="evo_glasgow_rm" oninput="evoCalcGlasgow()" type="number"/>
</label>
<label style="min-width: 140px;">Total
        <input id="evo_glasgow_total" name="evo_glasgow_total" readonly="" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 200px;">RASS atual:
        <input name="evo_rass_atual" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 120px;">Delirium:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_delirium" onclick="evoToggleBox('evo_delirium_tipos', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_delirium" onclick="evoToggleBox('evo_delirium_tipos', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_delirium_tipos" style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 16px;">
<label style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 16px;">
<input id="evo_del_hiper" name="evo_del_hiper" type="checkbox"/> Hiperativo
        </label>
<label style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 16px;">
<input id="evo_del_hipo" name="evo_del_hipo" type="checkbox"/> Hipoativo
        </label>
<label style="margin-top: 6px; display: flex; flex-wrap: wrap; gap: 16px;">
<input id="evo_del_misto" name="evo_del_misto" type="checkbox"/> Misto
        </label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 260px;">Analgesia / seda√ß√£o em uso:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_analg_sed" onclick="evoToggleBox('evo_analgesia_lista', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_analg_sed" onclick="evoToggleBox('evo_analgesia_lista', false)" type="radio" value="nao"/> N√£o
      </label>
</div>
<div class="hidden" id="evo_analgesia_lista" style="margin-top: 8px;">
<div class="row" style="margin: 0; gap: 14px; flex-wrap: wrap;">
<div class="med-item">
<input id="evo_med_dipirona" name="evo_med_dipirona" onclick="toggleDose('evo_med_dipirona','dose_evo_med_dipirona')" type="checkbox"/>
<span>Dipirona</span>
<input class="dose-input hidden" id="dose_evo_med_dipirona" name="dose_evo_med_dipirona" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_tramadol" name="evo_med_tramadol" onclick="toggleDose('evo_med_tramadol','dose_evo_med_tramadol')" type="checkbox"/>
<span>Tramadol</span>
<input class="dose-input hidden" id="dose_evo_med_tramadol" name="dose_evo_med_tramadol" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_tylex" name="evo_med_tylex" onclick="toggleDose('evo_med_tylex','dose_evo_med_tylex')" type="checkbox"/>
<span>Tylex</span>
<input class="dose-input hidden" id="dose_evo_med_tylex" name="dose_evo_med_tylex" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_metadona" name="evo_med_metadona" onclick="toggleDose('evo_med_metadona','dose_evo_med_metadona')" type="checkbox"/>
<span>Metadona</span>
<input class="dose-input hidden" id="dose_evo_med_metadona" name="dose_evo_med_metadona" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_diazepam" name="evo_med_diazepam" onclick="toggleDose('evo_med_diazepam','dose_evo_med_diazepam')" type="checkbox"/>
<span>Diazepam</span>
<input class="dose-input hidden" id="dose_evo_med_diazepam" name="dose_evo_med_diazepam" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_clonazepam" name="evo_med_clonazepam" onclick="toggleDose('evo_med_clonazepam','dose_evo_med_clonazepam')" type="checkbox"/>
<span>Clonazepam</span>
<input class="dose-input hidden" id="dose_evo_med_clonazepam" name="dose_evo_med_clonazepam" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_quetiapina" name="evo_med_quetiapina" onclick="toggleDose('evo_med_quetiapina','dose_evo_med_quetiapina')" type="checkbox"/>
<span>Quetiapina</span>
<input class="dose-input hidden" id="dose_evo_med_quetiapina" name="dose_evo_med_quetiapina" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_risperidona" name="evo_med_risperidona" onclick="toggleDose('evo_med_risperidona','dose_evo_med_risperidona')" type="checkbox"/>
<span>Risperidona</span>
<input class="dose-input hidden" id="dose_evo_med_risperidona" name="dose_evo_med_risperidona" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_ketamina" name="evo_med_ketamina" onclick="toggleDose('evo_med_ketamina','dose_evo_med_ketamina')" type="checkbox"/>
<span>Ketamina</span>
<input class="dose-input hidden" id="dose_evo_med_ketamina" name="dose_evo_med_ketamina" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_midazolam" name="evo_med_midazolam" onclick="toggleDose('evo_med_midazolam','dose_evo_med_midazolam')" type="checkbox"/>
<span>Midazolam</span>
<input class="dose-input hidden" id="dose_evo_med_midazolam" name="dose_med_midazolam" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_fentanil" name="evo_med_fentanil" onclick="toggleDose('evo_med_fentanil','dose_evo_med_fentanil')" type="checkbox"/>
<span>Fentanil</span>
<input class="dose-input hidden" id="dose_evo_med_fentanil" name="dose_evo_med_fentanil" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_remifentanil" name="evo_med_remifentanil" onclick="toggleDose('evo_med_remifentanil','dose_evo_med_remifentanil')" type="checkbox"/>
<span>Remifentanil</span>
<input class="dose-input hidden" id="dose_evo_med_remifentanil" name="dose_evo_med_remifentanil" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_precedex" name="evo_med_precedex" onclick="toggleDose('evo_med_precedex','dose_evo_med_precedex')" type="checkbox"/>
<span>Precedex</span>
<input class="dose-input hidden" id="dose_evo_med_precedex" name="dose_evo_med_precedex" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_propofol" name="evo_propofol" onclick="toggleDose('evo_med_propofol','dose_evo_med_propofol')" type="checkbox"/>
<span>Propofol</span>
<input class="dose-input hidden" id="dose_evo_med_propofol" name="dose_evo_med_propofol" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_rocuronio" name="evo_med_rocuronio" onclick="toggleDose('evo_med_rocuronio','dose_evo_med_rocuronio')" type="checkbox"/>
<span>Rocur√¥nio</span>
<input class="dose-input hidden" id="dose_evo_med_rocuronio" name="dose_evo_med_rocuronio" placeholder="dose" type="text"/>
</div>
<div class="med-item">
<input id="evo_med_cisatracurio" name="evo_cisatracurio" onclick="toggleDose('evo_med_cisatracurio','dose_evo_med_cisatracurio')" type="checkbox"/>
<span>Cisatrac√∫rio</span>
<input class="dose-input hidden" id="dose_evo_med_cisatracurio" name="dose_evo_med_cisatracurio" placeholder="dose" type="text"/>
</div>
</div>
</div>
<!-- Exame Neurol√≥gico -->
<div class="row" style="margin-top: 15px;">
<label style="flex: 1; min-width: 100%;">Exame Neurol√≥gico:
      <textarea name="evo_exame_neuro" rows="3" placeholder="Pupilas, for√ßa muscular, reflexos, sensibilidade..."></textarea>
</label>
</div>
<!-- Doppler cerebral -->
<div class="row nowrap" style="align-items: center; margin-top: 10px;">
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_doppler_check" type="checkbox" onclick="toggleNeuroExtra('doppler')"/> Doppler cerebral
</label>
</div>
<div class="hidden" id="evo_doppler_wrap" style="margin-top: 6px;">
<label style="flex: 1; min-width: 100%;">
      <textarea name="evo_doppler_desc" rows="2" placeholder="Descreva os achados do Doppler cerebral..."></textarea>
</label>
</div>
</div>
<!-- Hematol√≥gico / Trombose -->
<div class="section">
<h3>Hematol√≥gico / Trombose</h3>
<div class="row nowrap">
<label style="min-width: 220px;">Hb:
        <input name="evo_hb" type="text"/>
</label>
<label style="min-width: 220px;">Plaquetas:
        <input name="evo_plaquetas" type="text"/>
</label>
<label style="min-width: 220px;">INR:
        <input name="evo_inr" type="text"/>
</label>
<label style="min-width: 220px;">PTT:
        <input name="evo_ptt" type="text"/>
</label>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 140px;">Profilaxia TEV:</div>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_tev" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px; min-width: unset;">
<input name="evo_tev" type="radio" value="nao"/> N√£o
      </label>
<div class="hidden" id="evo_tev_just_wrap" style="flex: 1;">
<input name="evo_tev_just" placeholder="justificativa se n√£o" type="text"/>
</div>
</div>
<!-- Transfus√µes -->
<div class="row nowrap" style="align-items: flex-start; margin-top: 10px;">
<div style="min-width: 100px; margin-top: 6px;">Transfus√µes:</div>
<div style="display: flex; flex-wrap: wrap; gap: 15px;">
<label style="flex-direction: row; align-items: center; gap: 5px; min-width: unset;">
<input name="evo_transf_ch" type="checkbox" onclick="toggleTransfusao('ch')"/> CH
<input id="evo_transf_ch_qtd" name="evo_transf_ch_qtd" type="text" placeholder="qtd" style="width: 60px; display: none;"/>
</label>
<label style="flex-direction: row; align-items: center; gap: 5px; min-width: unset;">
<input name="evo_transf_plaq" type="checkbox" onclick="toggleTransfusao('plaq')"/> Plaquetas
<input id="evo_transf_plaq_qtd" name="evo_transf_plaq_qtd" type="text" placeholder="qtd" style="width: 60px; display: none;"/>
</label>
<label style="flex-direction: row; align-items: center; gap: 5px; min-width: unset;">
<input name="evo_transf_plasma" type="checkbox" onclick="toggleTransfusao('plasma')"/> Plasma
<input id="evo_transf_plasma_qtd" name="evo_transf_plasma_qtd" type="text" placeholder="qtd" style="width: 60px; display: none;"/>
</label>
<label style="flex-direction: row; align-items: center; gap: 5px; min-width: unset;">
<input name="evo_transf_crio" type="checkbox" onclick="toggleTransfusao('crio')"/> Crioprecipitado
<input id="evo_transf_crio_qtd" name="evo_transf_crio_qtd" type="text" placeholder="qtd" style="width: 60px; display: none;"/>
</label>
</div>
</div>
</div>
<!-- Invasivos / Dispositivos -->
<div class="section">
<h3>Invasivos / Dispositivos</h3>
<div class="row nowrap">
<label style="min-width: 260px;">CVC (local):
        <input name="evo_cvc_local" type="text"/>
</label>
<label style="min-width: 140px;">Dia:
        <input name="evo_cvc_dia" type="text"/>
</label>
<label style="min-width: 260px;">Cateter arterial (local):
        <input name="evo_art_local" type="text"/>
</label>
<label style="min-width: 140px;">Dia:
        <input name="evo_art_dia" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 260px;">Cateter de HD (local):
        <input name="evo_hd_local" type="text"/>
</label>
<label style="min-width: 140px;">Dia:
        <input name="evo_hd_dia" type="text"/>
</label>
<label style="min-width: 180px;">SVD (dia):
        <input name="evo_svd_dia" type="text"/>
</label>
<label style="min-width: 180px;">TOT/TQT (dia):
        <input name="evo_tot_tqt_dia" type="text"/>
</label>
</div>
<div class="row nowrap">
<label style="min-width: 320px;">Marcapasso transvenoso:
        <input name="evo_mp_transv" placeholder="VVI/DDD etc." type="text"/>
</label>
<label style="min-width: 140px;">Dia:
        <input name="evo_mp_transv_dia" placeholder="dd/mm ou D+?" type="text"/>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Drenos/outros:
        <input name="evo_drenos_outros" type="text"/>
</label>
</div>
<div class="row">
<label style="flex: 1; min-width: 100%;">Retirados recentemente (data/hora | motivo):
        <textarea name="evo_retirados" rows="3"></textarea>
</label>
</div>
</div>
<!-- Nutri√ß√£o -->
<div class="section" id="evo_nutricao_gi">
<h3>Nutri√ß√£o / Gastrointestinal</h3>
<div class="row grid-2">
<label>VET pleno (kcal/dia):
      <input name="evo_vet_kcal" placeholder="kcal/dia" step="1" type="number"/>
</label>
<label>Prote√≠na (g/dia):
      <input name="evo_vet_prot" placeholder="g/dia" step="1" type="number"/>
</label>
</div>
<div class="row grid-2">
<label>Dieta enteral:
      <select id="evo_dieta_select" name="evo_dieta_select"></select>
</label>
<div class="hidden" id="evo_dieta_custom_wrap">
<div class="row grid-2" style="margin-top: 8px;">
<label>kcal/mL:
          <input name="evo_dieta_kcal_ml" placeholder="ex: 1.0" step="0.001" type="number"/>
</label>
<label>prot g/mL:
          <input name="evo_dieta_prot_ml" placeholder="ex: 0.04" step="0.001" type="number"/>
</label>
</div>
</div>
</div>
<div class="row grid-2">
<label>Infus√£o (mL/h):
      <input name="evo_dieta_mlh" placeholder="mL/h" step="0.1" type="number"/>
</label>
<label>Volume em 24h (mL) (auto):
      <input name="evo_dieta_ml20" readonly="" step="1" type="number"/>
</label>
</div>
<div class="row grid-2">
<label>Kcal 24h (auto):
      <input name="evo_kcal_admin" readonly="" step="1" type="number"/>
</label>
<label>Prote√≠na 24h (auto, com whey):
      <input name="evo_prot_admin" readonly="" step="1" type="number"/>
</label>
</div>
<div class="row grid-2">
<label>Whey (g de prote√≠na):
      <input name="evo_whey_prot_g" placeholder="0" step="1" type="number"/>
</label>
<div></div>
</div>
<div class="row grid-2">
<label>% VET pleno atingido (24h) ‚Äì Calorias (auto):
      <input name="evo_pct_kcal" readonly="" step="0.1" type="number"/>
</label>
<label>% VET pleno atingido (24h) ‚Äì Prote√≠na (auto):
      <input name="evo_pct_prot" readonly="" step="0.1" type="number"/>
</label>
</div>
<hr style="border:0;border-top:1px solid #e5e7eb;margin:12px 0;"/>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div style="min-width: 180px;">V√¥mitos:</div>
<label><input name="evo_vomitos" type="radio" value="sim"/> Sim</label>
<label><input name="evo_vomitos" type="radio" value="nao"/> N√£o</label>
</div>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div style="min-width: 180px;">Distens√£o abdominal:</div>
<label><input name="evo_distensao" type="radio" value="sim"/> Sim</label>
<label><input name="evo_distensao" type="radio" value="nao"/> N√£o</label>
</div>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div style="min-width: 180px;">Estase g√°strica:</div>
<label><input name="evo_estase" onclick="evoToggleBox('evo_estase_wrap', true)" type="radio" value="sim"/> Sim</label>
<label><input name="evo_estase" onclick="evoToggleBox('evo_estase_wrap', false)" type="radio" value="nao"/> N√£o</label>
<div class="hidden" id="evo_estase_wrap" style="flex:1; min-width:260px;">
<input name="evo_estase_residuo" placeholder="Quantidade de res√≠duo g√°strico (mL)" type="text" style="width:100%;"/>
</div>
</div>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div>Hipoglicemias em 12/24h:</div>
<label><input name="evo_hipo" onclick="evoToggleBox('evo_hipo_wrap', true)" type="radio" value="sim"/> Sim</label>
<label><input name="evo_hipo" onclick="evoToggleBox('evo_hipo_wrap', false)" type="radio" value="nao"/> N√£o</label>
<div class="hidden" id="evo_hipo_wrap" style="flex:1; min-width:260px;">
<input name="evo_hipo_glicose" placeholder="Quantidade de glicose feita" type="text" style="width:100%;"/>
</div>
</div>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div>Hiperglicemias em 12/24h:</div>
<label><input name="evo_hiper" onclick="evoToggleBox('evo_hiper_wrap', true)" type="radio" value="sim"/> Sim</label>
<label><input name="evo_hiper" onclick="evoToggleBox('evo_hiper_wrap', false)" type="radio" value="nao"/> N√£o</label>
<div class="hidden" id="evo_hiper_wrap" style="flex:1; min-width:260px;">
<input name="evo_hiper_insulina" placeholder="Quantidade de insulina regular feita" type="text" style="width:100%;"/>
</div>
</div>
<div class="row nowrap" style="align-items:center; gap:14px; flex-wrap:wrap;">
<div style="min-width: 220px;">Profilaxia √∫lcera de estresse:</div>
<label><input name="evo_profilaxia_ulcera" type="radio" value="sim"/> Sim</label>
<label><input name="evo_profilaxia_ulcera" type="radio" value="nao"/> N√£o</label>
</div>
</div>
<!-- Outros exames relevantes -->
<div class="section">
<h3>Outros exames relevantes</h3>
<div class="row">
<textarea name="evo_outros_labs" rows="4" style="width: 100%;"></textarea>
</div>
</div>
<!-- Interconsultas -->
<div class="section">
<h3>Interconsultas</h3>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 120px;">Nefrologia:</div>
<label style="flex-direction: row; align-items: center; gap: 8px;">
<input name="evo_nefro" onclick="evoToggleBox('evo_nefro_txt_wrap', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px;">
<input name="evo_nefro" onclick="evoToggleBox('evo_nefro_txt_wrap', false)" type="radio" value="nao"/> N√£o
      </label>
<div class="hidden" id="evo_nefro_txt_wrap" style="flex: 1;">
<textarea name="evo_nefro_txt" placeholder="Descrever" rows="3" style="width: 100%;"></textarea>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 120px;">CG:</div>
<label style="flex-direction: row; align-items: center; gap: 8px;">
<input name="evo_cg" onclick="evoToggleBox('evo_cg_txt_wrap', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px;">
<input name="evo_cg" onclick="evoToggleBox('evo_cg_txt_wrap', false)" type="radio" value="nao"/> N√£o
      </label>
<div class="hidden" id="evo_cg_txt_wrap" style="flex: 1;">
<textarea name="evo_cg_txt" placeholder="Descrever" rows="3" style="width: 100%;"></textarea>
</div>
</div>
<div class="row nowrap" style="align-items: center;">
<div style="min-width: 120px;">Vascular:</div>
<label style="flex-direction: row; align-items: center; gap: 8px;">
<input name="evo_vasc" onclick="evoToggleBox('evo_vasc_txt_wrap', true)" type="radio" value="sim"/> Sim
      </label>
<label style="flex-direction: row; align-items: center; gap: 8px;">
<input name="evo_vasc" onclick="evoToggleBox('evo_vasc_txt_wrap', false)" type="radio" value="nao"/> N√£o
      </label>
<div class="hidden" id="evo_vasc_txt_wrap" style="flex: 1;">
<textarea name="evo_vasc_txt" placeholder="Descrever" rows="3" style="width: 100%;"></textarea>
</div>
</div>
</div>
<!-- Impress√£o / Plano -->
<div class="section">
<h3>Impress√£o cl√≠nica</h3>
<div class="row">
<textarea name="evo_impressao" rows="4" style="width: 100%;"></textarea>
</div>
</div>
<div class="section">
<h3>Plano / Metas das pr√≥ximas 24h</h3>
<div class="row">
<textarea name="evo_plano_24h" rows="5" style="width: 100%;"></textarea>
</div>
</div>
<div class="section no-print" style="background: #e8f5e9; border: 2px solid #4caf50; padding: 15px;">
<div class="row nowrap" style="justify-content: center; gap: 12px; flex-wrap: wrap;">
<button onclick="evoSalvarEvolucaoAtual()" type="button" style="background: #4caf50; color: white; font-weight: bold; padding: 10px 20px;">
    üíæ Salvar
</button>
<button onclick="evoGerarTexto()" type="button" style="background: #1976d2; color: white; padding: 10px 20px;">
    üìù Gerar Texto
</button>
<button onclick="window.print()" type="button" style="background: #607d8b; color: white; padding: 10px 20px;">
    üñ®Ô∏è Imprimir
</button>
<button onclick="exportarPDF()" type="button" style="background: #ff9800; color: white; font-weight: bold; padding: 10px 20px;">
    üìÑ PDF
</button>
<button onclick="evoNovaEvolucao()" type="button" style="background: #9c27b0; color: white; padding: 10px 20px;">
    üîÑ Nova Evolu√ß√£o
</button>
</div>
<div id="lista_evolucoes" style="margin-top: 15px; border-top: 1px solid #a5d6a7; padding-top: 10px;"></div>
</div>
<!-- Painel: Texto para copiar (Evolu√ß√£o) -->
<div class="section hidden" id="painelTextoEvo">
<h3 style="margin-top: 0;">Texto (Evolu√ß√£o) para copiar</h3>
<div class="row">
<textarea id="textoGeradoEvo" rows="18" style="width: 100%;"></textarea>
</div>
<div class="row nowrap" style="justify-content: flex-end; gap: 10px;">
<button onclick="evoCopiarTexto()" type="button">Copiar</button>
<button onclick="evoFecharPainelTexto()" type="button">Fechar</button>
</div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ===== Global State =====
var currentBed = 1; // Global variable to track the currently selected bed

// ===== Helpers (ES5) =====
  function byId(id){ return document.getElementById(id); }
  function qs(sel){ return document.querySelector(sel); }
  function qsa(sel){ return document.querySelectorAll(sel); }
function pad2(n){ return (n<10 ? '0' : '') + n; }
function nowLocalDatetimeValue(){
    var d = new Date();
    return d.getFullYear() + '-' + pad2(d.getMonth()+1) + '-' + pad2(d.getDate()) +
           'T' + pad2(d.getHours()) + ':' + pad2(d.getMinutes());
  }

  function clearContainer(el) {
    if (!el) return;
    var inputs = el.querySelectorAll('input, textarea, select');
    for (var i=0;i<inputs.length;i++){
      var inp = inputs[i];
      if (inp.type === 'radio' || inp.type === 'checkbox') inp.checked = false;
      else inp.value = '';
    }
  }


  function setNowIfEmptyInput(el){
    if (el && !el.value) el.value = nowLocalDatetimeValue();
  }
function setNowIfEmpty(idOrName, within){
    var el = null;
    if (within) el = within.querySelector('[name="'+idOrName+'"]') || within.querySelector('#'+idOrName);
    if (!el) el = byId(idOrName) || qs('[name="'+idOrName+'"]');
    setNowIfEmptyInput(el);
  }
function parseLocalDateTime(s){
    if (!s) return null;
    var parts = s.split('T');
    var datePart = parts[0];
    if (!datePart || datePart.length < 10) return null;

    var y = parseInt(datePart.substr(0,4),10);
    var m = parseInt(datePart.substr(5,2),10)-1;
    var d = parseInt(datePart.substr(8,2),10);

    var hh = 0, mm = 0;
    if (parts.length > 1 && parts[1].length >= 5) {
      hh = parseInt(parts[1].substr(0,2),10) || 0;
      mm = parseInt(parts[1].substr(3,2),10) || 0;
    }
    return new Date(y,m,d,hh,mm,0,0);
  }
  // ===== C√°lculos =====
  function calcularIMC() {
    var pesoEl = byId('peso');
    var alturaEl = byId('altura');
    var imcEl = byId('imc');
    if (!imcEl) return;
    var peso = pesoEl ? parseFloat(pesoEl.value) : NaN;
    var alturaCm = alturaEl ? parseFloat(alturaEl.value) : NaN;
    if (peso > 0 && alturaCm > 0) {
      var alturaM = alturaCm / 100;
      var imc = peso / (alturaM * alturaM);
      imcEl.value = (Math.round(imc * 100) / 100).toFixed(2);
    } else {
      imcEl.value = '';
    }
  }

  function calcularPBW() {
    var alturaEl = byId('altura');
    var sexoEl = byId('sexo');
    var pbwEl = byId('pbw');
    if (!pbwEl) return;

    var altura = alturaEl ? parseFloat(alturaEl.value) : NaN;
    var sexo = sexoEl ? sexoEl.value : '';

    if (!(altura > 0) || !sexo) { pbwEl.value = ''; return; }

    var base = altura - 152.4;
    var pbw = 0;
    if (sexo === 'M') pbw = 50 + 0.91 * base;
    else if (sexo === 'F') pbw = 45.5 + 0.91 * base;
    else { pbwEl.value = ''; return; }

    pbwEl.value = (Math.round(pbw * 100) / 100).toFixed(2);
  }
// ===== UI: Leitos =====
    function initLeitos() {
        var seletorLeito = byId('seletorLeito');
        seletorLeito.innerHTML = '';
        for (var i = 1; i <= 10; i++) { // Always 10 beds
            var option = document.createElement('option');
            option.value = String(i); // Store as '1', '2', etc.
            option.textContent = 'Leito ' + i;
            seletorLeito.appendChild(option);
        }
        seletorLeito.value = String(currentBed); // Select the current bed
        // No need to call trocarLeito() here, carregarLeitoAtual() will be called on DOMContentLoaded
    }

    function trocarLeito() {
        // Save current patient's data before switching
        salvarLeitoAtual(); // Save the data of the *current* bed before moving to another

        var seletorLeito = byId('seletorLeito');
        currentBed = seletorLeito.value; // Update the global currentBed variable

        // Load data for the newly selected bed
        carregarLeitoAtual();
    }


// ===== UI: Alergias =====
  function toggleAlergiaCampo(mostrar) {
    var campo = byId('campoAlergia');
    if (!campo) return;
    if (mostrar) {
      campo.classList.remove('hidden');
    } else {
      var ta = campo.querySelector('textarea');
      if (ta) ta.value = '';
      campo.classList.add('hidden');
    }
  }
// ===== UI: Toggle Admiss√£o (colapsar/expandir) =====
  var admissaoColapsada = false;
  
  function toggleAdmissao() {
    var conteudo = byId('admissaoConteudo');
    var btn = byId('btnToggleAdmissao');
    var resumo = byId('admissaoResumo');
    
    if (!conteudo || !btn) return;
    
    if (admissaoColapsada) {
      // Expandir
      conteudo.style.display = 'block';
      btn.innerHTML = 'üîΩ Recolher';
      resumo.textContent = '';
      admissaoColapsada = false;
    } else {
      // Colapsar
      var nome = document.getElementsByName('nome')[0];
      var idade = byId('idade');
      var dataAdm = byId('datahora_admissao');
      
      var resumoTexto = '';
      if (nome && nome.value) {
        resumoTexto = nome.value;
        if (idade && idade.value) resumoTexto += ', ' + idade.value + ' anos';
        if (dataAdm && dataAdm.value) {
          var d = new Date(dataAdm.value);
          resumoTexto += ' - Adm: ' + d.toLocaleDateString('pt-BR');
        }
      }
      
      conteudo.style.display = 'none';
      btn.innerHTML = 'üîº Expandir';
      resumo.textContent = resumoTexto || '(sem dados)';
      admissaoColapsada = true;
    }
  }
  
  function salvarAdmissao() {
    salvarLeitoAtual(); // This will save admission and current evolution for the current bed
    // Colapsa automaticamente ap√≥s salvar
    if (!admissaoColapsada) {
      toggleAdmissao();
    }
    alert('‚úÖ Admiss√£o salva com sucesso!');
  }
// ===== UI: Toggle Transfus√µes =====
  function toggleTransfusao(tipo) {
    var checkbox = document.getElementsByName('evo_transf_' + tipo)[0];
    var qtdInput = byId('evo_transf_' + tipo + '_qtd');
    
    if (!checkbox || !qtdInput) return;
    
    if (checkbox.checked) {
      qtdInput.style.display = 'inline-block';
      qtdInput.focus();
    } else {
      qtdInput.style.display = 'none';
      qtdInput.value = '';
    }
  }
// ===== UI: Toggle Neurol√≥gico (Doppler, Brain4care) =====
  function toggleNeuroExtra(tipo) {
    var checkbox = document.getElementsByName('evo_' + tipo + '_check')[0];
    var wrap = byId('evo_' + tipo + '_wrap');
    
    if (!checkbox || !wrap) return;
    
    if (checkbox.checked) {
      wrap.classList.remove('hidden');
    } else {
      wrap.classList.add('hidden');
      var textarea = wrap.querySelector('textarea');
      if (textarea) textarea.value = '';
    }
  }
// ===== UI: Toggle Hemodin√¢mico (Swan Ganz, Marcapasso, esCCO) =====
  function toggleHemoExtra(tipo) {
    var checkbox = document.getElementsByName('evo_' + tipo + '_check')[0];
    var wrap = byId('evo_' + tipo + '_wrap');
    
    if (!checkbox || !wrap) return;
    
    if (checkbox.checked) {
      wrap.classList.remove('hidden');
    } else {
      wrap.classList.add('hidden');
      // Limpar campos
      var inputs = wrap.querySelectorAll('input');
      inputs.forEach(function(input) { input.value = ''; });
    }
  }
// ===== UI: Nova Evolu√ß√£o R√°pida =====
  function novaEvolucaoRapida() {
    // Colapsa admiss√£o se estiver expandida
    if (!admissaoColapsada) {
      toggleAdmissao();
    }
    // Abre a evolu√ß√£o di√°ria
    abrirEvolucao();
  }
// ===== UI: Respirat√≥rio =====
  function toggleResp(tipo) {
    var vm = byId('resp_vm');
    var venturi = byId('resp_venturi');
    var cn = byId('resp_cn');
    var mr = byId('resp_mr');
    if (!vm || !venturi || !cn || !mr) return;

    vm.classList.add('hidden');
    venturi.classList.add('hidden');
    cn.classList.add('hidden');
    mr.classList.add('hidden');
// Se voltar para Ar ambiente, limpar campos dos suportes anteriores
    if (tipo === 'Ar ambiente') {
      clearContainer(vm);
      clearContainer(venturi);
      clearContainer(cn);
      clearContainer(mr);
      return;
    }
    if (tipo === 'VM') vm.classList.remove('hidden');
    else if (tipo === 'Venturi') venturi.classList.remove('hidden');
    else if (tipo === 'CN') cn.classList.remove('hidden');
    else if (tipo === 'MR') mr.classList.remove('hidden');
  }
// ===== UI: Gasometria =====
  function toggleGasometria() {
    var chk = byId('chk_gaso');
    var div = byId('gaso_fields');
    if (!chk || !div) return;

    if (chk.checked) {
      div.classList.remove('hidden');
    } else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }
// ===== UI: Hemodin√¢mica =====
  function toggleHemoDrug(drug) {
    var map = {
      dobutamina: { chk: 'chk_dobutamina', div: 'drug_dobutamina' },
      milrinona: { chk: 'chk_milrinona', div: 'drug_milrinona' },
      noradrenalina: { chk: 'chk_noradrenalina', div: 'drug_noradrenalina' },
      vasopressina: { chk: 'chk_vasopressina', div: 'drug_vasopressina' }
    };
    if (!map[drug]) return;

    var chk = byId(map[drug].chk);
    var div = byId(map[drug].div);
    if (!chk || !div) return;
    if (chk.checked) {
      div.classList.remove('hidden');
    } else {
      var input = div.querySelector('input');
      if (input) input.value = '';
      div.classList.add('hidden');
    }
  }

  function togglePerfusao() {
    var chk = byId('chk_perf');
    var div = byId('perf_fields');
    if (!chk || !div) return;
    if (chk.checked) {
      div.classList.remove('hidden');
    } else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }

  // ===== UI: Culturas =====
  function toggleCultOutros() {
    var chk = byId('cult_outros_chk');
    var wrap = byId('cult_outros_txt_wrap');
    if (!chk || !wrap) return;

    if (chk.checked) wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }
function toggleCulturas(sim) {
    var divSim = byId('culturas_sim');
    var divNao = byId('culturas_nao');
    if (!divSim || !divNao) return;
    if (sim) {
      divSim.classList.remove('hidden');
      divNao.classList.add('hidden');
      var motivo = divNao.querySelector('input');
      if (motivo) motivo.value = '';
    } else {
      divNao.classList.remove('hidden');
      divSim.classList.add('hidden');

      var cbs = divSim.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;

      var outrosTxt = qs('input[name="cult_outros_txt"]');
      if (outrosTxt) outrosTxt.value = '';
      var wrap = byId('cult_outros_txt_wrap');
      if (wrap) wrap.classList.add('hidden');
    }
  }
// ===== UI: Glasgow =====
  function calcGlasgow() {
    var ao = parseFloat((byId('glasgow_ao')||{}).value) || 0;
    var rv = parseFloat((byId('glasgow_rv')||{}).value) || 0;
    var rm = parseFloat((byId('glasgow_rm')||{}).value) || 0;
    var total = ao + rv + rm;
    var out = byId('glasgow_total');
    if (out) out.value = total > 0 ? total : '';
  }
// ===== UI: Analgesia/Seda√ß√£o =====
  function toggleAnalgesia(sim) {
    var div = byId('analgesia_lista');
    if (!div) return;

    if (sim) {
      div.classList.remove('hidden');
    } else {
      var cbs = div.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;

      var doses = div.querySelectorAll('input.dose-input');
      for (var j=0;j<doses.length;j++) {
        doses[j].value = '';
        doses[j].classList.add('hidden');
      }
      div.classList.add('hidden');
    }
  }
function toggleDose(chkId, doseId) {
    var chk = byId(chkId);
    var dose = byId(doseId);
    if (!chk || !dose) return;

    if (chk.checked) {
      dose.classList.remove('hidden');
      try { dose.focus(); } catch(e){}
    } else {
      dose.value = '';
      dose.classList.add('hidden');
    }
  }
// ===== Evolu√ß√£o: Neuro igual √† admiss√£o =====
  function evoCalcGlasgow() {
    var ao = parseFloat((byId('evo_glasgow_ao')||{}).value) || 0;
    var rv = parseFloat((byId('evo_glasgow_rv')||{}).value) || 0;
    var rm = parseFloat((byId('evo_glasgow_rm')||{}).value) || 0;
    var total = ao + rv + rm;
    var out = byId('evo_glasgow_total');
    if (out) out.value = total > 0 ? String(total) : '';
  }
function evoToggleDelirium(sim) {
    var tipos = byId('evo_delirium_tipos');
    if (!tipos) return;
    if (sim) {
      tipos.classList.remove('hidden');
    } else {
      var cbs = tipos.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;
      tipos.classList.add('hidden');
    }
  }
function evoToggleAnalgesia(sim) {
    var div = byId('evo_analgesia_lista');
    if (!div) return;
    if (sim) {
      div.classList.remove('hidden');
    } else {
      var cbs = div.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;

      var doses = div.querySelectorAll('input.dose-input');
      for (var j=0;j<doses.length;j++) { doses[j].value=''; doses[j].classList.add('hidden'); }

      div.classList.add('hidden');
    }
  }
  // ===== UI: Delirium =====
  function toggleDelirium(sim) {
    var tipos = byId('delirium_tipos');
    if (!tipos) return;
    if (sim) {
      tipos.classList.remove('hidden');
    } else {
      var cbs = tipos.querySelectorAll('input[type="checkbox"]');
      for (var i=0;i<cbs.length;i++) cbs[i].checked = false;
      tipos.classList.add('hidden');
    }
  }
// ===== Persist√™ncia (LocalStorage) =====
  function coletarDadosFormulario() {
    var data = {};
    var els = qsa('#admissaoConteudo input, #admissaoConteudo select, #admissaoConteudo textarea'); // Only admission fields
    for (var i=0;i<els.length;i++) {
      var el = els[i];
      var key = el.name || el.id;
      if (!key) continue;
      if (el.type === 'checkbox') data[key] = !!el.checked;
      else if (el.type === 'radio') {
        if (el.checked) data[key] = el.value;
        else if (typeof data[key] === 'undefined') data[key] = null;
      } else data[key] = el.value;
    }
    return data;
  }
function aplicarDadosFormulario(data) {
    if (!data) return;
    
    // Primeiro, aplicar campos com :: (checkboxes e radios salvos no formato antigo)
    for (var chave in data) {
      if (chave.includes('::')) {
        var partes = chave.split('::');
        var nome = partes[0];
        var valor = partes[1];
        var el = qs('input[name="'+nome+'"][value="'+valor+'"]');
        if (el) el.checked = true;
      }
    }
    
    // Depois, aplicar os demais campos
    var els = qsa('#admissaoConteudo input, #admissaoConteudo select, #admissaoConteudo textarea'); // Only admission fields
    for (var i=0;i<els.length;i++) {
      var el = els[i];
      var key = el.name || el.id;
      if (!key || typeof data[key] === 'undefined') continue;
      if (el.type === 'checkbox') el.checked = !!data[key];
      else if (el.type === 'radio') el.checked = (data[key] !== null && el.value === data[key]);
      else el.value = data[key] !== null ? data[key] : '';
    }

    calcularIMC();
    calcularPBW();

    // Alergias
    var alSim = qs('input[name="alergias_check"][value="sim"]');
    var alNao = qs('input[name="alergias_check"][value="nao"]');
    if (alSim && alSim.checked) toggleAlergiaCampo(true);
    else if (alNao && alNao.checked) toggleAlergiaCampo(false);
    else toggleAlergiaCampo(false); // Default to hidden if neither is checked

    // Respirat√≥rio
    var respSel = qs('input[name="resp_suporte"]:checked');
    if (respSel) toggleResp(respSel.value);
    else toggleResp('Ar ambiente'); // Default

    // Gasometria
    if (byId('chk_gaso')) { byId('chk_gaso').checked = !!data['chk_gaso']; toggleGasometria(); }

    // Culturas
    var cultSel = qs('input[name="inf_culturas"]:checked');
    if (cultSel) toggleCulturas(cultSel.value === 'sim');
    else toggleCulturas(false); // Default
    if (byId('cult_outros_chk')) { byId('cult_outros_chk').checked = !!data['cult_outros_chk']; toggleCultOutros(); }

    // Hemo drugs
    var drugs = ['dobutamina','milrinona','noradrenalina','vasopressina'];
    for (var d=0; d<drugs.length; d++) {
        var chkId = 'chk_' + drugs[d];
        if (byId(chkId)) {
            byId(chkId).checked = !!data[chkId];
            toggleHemoDrug(drugs[d]);
        }
    }
    if (byId('chk_perf')) { byId('chk_perf').checked = !!data['chk_perf']; togglePerfusao(); }

    // Analgesia
    var analgSel = qs('input[name="analg_sed"]:checked');
    if (analgSel) toggleAnalgesia(analgSel.value === 'sim');
    else toggleAnalgesia(false);

    // Doses (re-trigger to hide/show)
    var chkMeds = qsa('#analgesia_lista input[type="checkbox"]');
    for (var k=0;k<chkMeds.length;k++) {
      var chk = chkMeds[k];
      var doseId = 'dose_' + chk.id;
      if (byId(doseId)) {
        if (chk.checked) byId(doseId).classList.remove('hidden');
        else byId(doseId).classList.add('hidden');
      }
    }

    // Delirium
    var delSel = qs('input[name="delirium"]:checked');
    if (delSel) toggleDelirium(delSel.value === 'sim');
    else toggleDelirium(false);

    // Glasgow
    if (byId('glasgow_ao')) calcGlasgow();
  }

  // Helper to clear all admission fields when switching to an empty bed
  function limparFormularioCompleto() {
      var formElements = qsa('#admissaoConteudo input, #admissaoConteudo select, #admissaoConteudo textarea');
      formElements.forEach(function(el) {
          if (el.type === 'checkbox' || el.type === 'radio') {
              el.checked = false;
          } else {
              el.value = '';
          }
      });
      // Also ensure conditional fields are hidden and calculations reset
      toggleAlergiaCampo(false);
      toggleResp('Ar ambiente'); // Reset respiratory support
      if (byId('chk_gaso')) byId('chk_gaso').checked = false; toggleGasometria();
      var drugs = ['dobutamina','milrinona','noradrenalina','vasopressina'];
      for (var d=0; d<drugs.length; d++) {
        var chkId = 'chk_' + drugs[d];
        if (byId(chkId)) {
          byId(chkId).checked = false;
          toggleHemoDrug(drugs[d]);
        }
      }
      if (byId('chk_perf')) { byId('chk_perf').checked = false; togglePerfusao(); }
      toggleCulturas(false);
      toggleDelirium(false);
      toggleAnalgesia(false);
      byId('imc').value = '';
      byId('pbw').value = '';
      byId('glasgow_total').value = '';
  }


  // Function to save all current form data (Admission and Evolution last) for the current bed
  function salvarLeitoAtual() {
      // Save Admission data
      var admissionData = coletarDadosFormulario();
      localStorage.setItem('admissao_cti_adulto_leito_' + currentBed, JSON.stringify(admissionData));

      // Save current Evolution data as the 'last' for this bed
      var evoData = evoCollectFields();
      localStorage.setItem('evolucao_last_leito_' + currentBed, JSON.stringify(evoData));
  }

  // Function to load all form data for the current bed
  function carregarLeitoAtual() {
      // Clear forms first to avoid mixing data
      limparFormularioCompleto();
      limparCamposEvolucao(); // Clear evolution fields

      // Load Admission data
      var rawAdmission = localStorage.getItem('admissao_cti_adulto_leito_' + currentBed);
      if (rawAdmission) {
          aplicarDadosFormulario(JSON.parse(rawAdmission));
          // Toggle admission section to collapsed state if it was before for the previous patient
          // This ensures the summary is updated or the form is shown correctly.
          if (admissaoColapsada) {
            toggleAdmissao(); // Expand first to apply, then collapse if needed
            toggleAdmissao(); // Collapse to reflect new patient data summary
          } else {
            // If it was expanded, it should remain expanded after loading
          }
      } else {
          // If no admission data, ensure admission form is clear and expanded
          if (admissaoColapsada) toggleAdmissao(); // Expand it to allow new input
      }

      // Load last Evolution data for the current bed (to pre-fill for a new evolution)
      var rawEvo = localStorage.getItem('evolucao_last_leito_' + currentBed);
      if (rawEvo) {
          evoApply(JSON.parse(rawEvo)); // Apply to evolution form
      } else {
           // If no previous evolution, ensure some basic admission data is auto-copied for the first evo
          evoAutoFromAdmissao();
      }

      // Ensure all UI elements are updated after loading
      evoAtualizarDiaUTI(); // Recalculate UTI day
      evoRenderHistory(); // Render history specific to this bed
      try { evoUpdateBigHeader(); } catch(e) {}
  }


  // ===== Texto para copiar =====
  function val(nameOrId) {
    var el = qs('[name="'+nameOrId+'"]') || byId(nameOrId);
    if (!el) return '';
    if (el.type === 'checkbox') return el.checked ? 'Sim' : 'N√£o';
    if (el.type === 'radio') {
      var sel = qs('input[name="'+nameOrId+'"]:checked');
      return sel ? sel.value : '';
    }
    return (el.value || '').replace(/^\s+|\s+$/g,'');
  }
function abrirPainelTexto() {
    var p = byId('painelTexto');
    if (p) {
      p.classList.remove('hidden');
      try { p.scrollIntoView({behavior:'smooth', block:'start'}); } catch(e){ p.scrollIntoView(true); }
    }
  }

  function fecharPainelTexto() {
    var p = byId('painelTexto');
    if (p) p.classList.add('hidden');
  }
function copiarTexto() {
    var ta = byId('textoGerado');
    if (!ta) return;
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); } catch(e){}
  }

  function gerarTexto() {
    var linhas = [];

    var nome = val('nome');
    var idade = val('idade');
    var sexoEl = byId('sexo');
    var sexo = sexoEl ? sexoEl.value : '';
    var data = val('datahora_admissao'); // Changed to datahora_admissao
    var peso = val('peso');
    var altura = val('altura');
    var imc = val('imc');
    var pbw = val('pbw');
    linhas.push('ADMISS√ÉO CTI ADULTO');
    var idParts = [];
    if (nome) idParts.push('Nome: ' + nome);
    if (idade) idParts.push('Idade: ' + idade);
    if (sexo) idParts.push('Sexo: ' + sexo);
    if (data) idParts.push('Data: ' + data);
    linhas.push('Identifica√ß√£o: ' + idParts.join(' | '));
    var ant = [];
    if (peso) ant.push('Peso: ' + peso + ' kg');
    if (altura) ant.push('Altura: ' + altura + ' cm');
    if (imc) ant.push('IMC: ' + imc);
    if (pbw) ant.push('PBW: ' + pbw + ' kg');
    linhas.push('Dados antropom√©tricos: ' + ant.join(' | '));
    linhas.push('');

    var hma = val('hma'), hpp = val('hpp'), cir = val('cirurgias'), med = val('med_dom');
    var alSim = qs('input[name="alergias_check"][value="sim"]');
    var alergiasSim = alSim ? alSim.checked : false;
    var alergiasTxt = val('alergias');
    if (hma) { linhas.push('HMA: ' + hma); linhas.push(''); }
    if (hpp) { linhas.push('HPP: ' + hpp); linhas.push(''); }
    if (cir) { linhas.push('Cirurgias pr√©vias: ' + cir); linhas.push(''); }
    if (med) { linhas.push('Medica√ß√µes domiciliares: ' + med); linhas.push(''); }
    linhas.push('Alergias: ' + (alergiasSim ? (alergiasTxt || 'Sim') : 'N√£o'));
    linhas.push('');
// Imagem
    var ecg = val('ecg_admissao'), rx = val('rx_torax_admissao'), pocus = val('pocus_admissao'), imgout = val('img_outros');
    if (ecg || rx || pocus || imgout) {
      linhas.push('Exames de imagem:');
      if (ecg) linhas.push('- ECG: ' + ecg);
      if (rx) linhas.push('- Rx t√≥rax: ' + rx);
      if (pocus) linhas.push('- POCUS: ' + pocus);
      if (imgout) linhas.push('- Outros: ' + imgout);
      linhas.push('');
    }
// Laborat√≥rio
    var labs = [];
    function addLab(lbl, key){ var v = val(key); if (v) labs.push(lbl + ': ' + v); }
    addLab('Hb','hb'); addLab('Leuco','leuco'); addLab('Plaquetas','plaquetas');
    addLab('Ureia','ureia'); addLab('Creatinina','creatinina');
    addLab('Na','na'); addLab('K','k'); addLab('Mg','mg'); addLab('Ca','ca'); addLab('F√≥sforo','fosforo');
    addLab('INR','inr'); addLab('PTT','ptt'); addLab('BT','bt'); addLab('BD','bd'); addLab('TGO','tgo'); addLab('TGP','tgp');
    var labOut = val('lab_outros');
    if (labs.length || labOut) {
      linhas.push('Laborat√≥rio:');
      if (labs.length) linhas.push('- ' + labs.join(' | '));
      if (labOut) linhas.push('- Outros relevantes: ' + labOut);
      linhas.push('');
    }
    var previos = val('exames_previos_relevantes');
    if (previos) { linhas.push('Exames pr√©vios relevantes: ' + previos); linhas.push(''); }
    var exameFisico = val('exame_fisico');
    if (exameFisico) { linhas.push('Exame f√≠sico: ' + exameFisico); linhas.push(''); }
// Sistemas (resumo)
    var suporte = '';
    var respSel = qs('input[name="resp_suporte"]:checked');
    if (respSel) suporte = respSel.value;
    var respDet = [];
    if (suporte === 'VM') {
      function addVM(lbl, key){ var v = val(key); if (v) respDet.push(lbl + ': ' + v); }
      addVM('Modo','vm_modo'); addVM('Pinsp/PS','vm_pinsp_ps'); addVM('VC','vm_vc'); addVM('FR','vm_fr');
      addVM('PEEP','vm_peep'); addVM('FiO2','vm_fio2'); addVM('Ppico','vm_ppico'); addVM('Pplat√¥','vm_pplato'); addVM('Drive','vm_drive');
    } else if (suporte === 'Venturi') {
      var vf = val('venturi_fio2'); if (vf) respDet.push('FiO2 Venturi: ' + vf);
    } else if (suporte === 'CN') {
      var cl = val('cn_litros'); if (cl) respDet.push('CN: ' + cl + ' L/min');
    } else if (suporte === 'MR') {
      var ml = val('mr_litros'); if (ml) respDet.push('MR: ' + ml + ' L/min');
    }
    var gasChk = byId('chk_gaso');
    var gasMarcada = gasChk ? gasChk.checked : false;
    var gasDet = [];
    function addGas(lbl, key){ var v = val(key); if (v) gasDet.push(lbl + ': ' + v); }
    addGas('pH','gas_ph'); addGas('pO2','gas_po2'); addGas('pCO2','gas_pco2'); addGas('HCO3','gas_hco3'); addGas('BE','gas_be'); addGas('sO2','gas_so2');
    var hemoBase = [];
    function addH(lbl,key){ var v=val(key); if (v) hemoBase.push(lbl+': '+v); }
    addH('Ritmo','hemo_ritmo'); addH('PA','hemo_pa'); addH('FC','hemo_fc'); addH('SpO2','hemo_spo2');

    var drogas = [];
    function addD(lbl,key){ var v=val(key); if (v) drogas.push(lbl+': '+v); }
    addD('Dobutamina','dobutamina_dose'); addD('Milrinona','milrinona_dose'); addD('Noradrenalina','noradrenalina_dose'); addD('Vasopressina','vasopressina_dose');
    var perf = [];
    function addP(lbl,key){ var v=val(key); if (v) perf.push(lbl+': '+v); }
    addP('Lactato','perf_lactato'); addP('SvcO2','perf_svco2'); addP('GapCO2','perf_gapco2');
    var foco = val('inf_foco');
    var atbs = [];
    for (var i=1;i<=3;i++){
      var a = val('inf_atb'+i);
      var d = val('inf_dia_atb'+i);
      var t = val('inf_total_atb'+i);
      if (a) {
        var extra = (d || t) ? (' (D' + (d||'') + ' de ' + (t||'') + ')') : '';
        atbs.push(a + extra);
      }
    }
    var culturas = '';
    var cultSel = qs('input[name="inf_culturas"]:checked');
    if (cultSel && cultSel.value === 'sim') {
      var sites = [];
      if (qs('input[name="cult_urina"]') && qs('input[name="cult_urina"]').checked) sites.push('urina');
      if (qs('input[name="cult_hemo"]') && qs('input[name="cult_hemo"]').checked) sites.push('hemocultura');
      if (qs('input[name="cult_traqueal"]') && qs('input[name="cult_traqueal"]').checked) sites.push('secre√ß√£o traqueal');
      if (byId('cult_outros_chk') && byId('cult_outros_chk').checked) {
        var ot = val('cult_outros_txt');
        sites.push('outros' + (ot ? (' ('+ot+')') : ''));
      }
      culturas = 'Culturas: sim' + (sites.length ? (' ['+sites.join(', ')+']') : '');
    } else if (cultSel && cultSel.value === 'nao') {
      var mot = val('culturas_motivo');
      culturas = 'Culturas: n√£o' + (mot ? (' (motivo: '+mot+')') : '');
    }
    var glas = val('glasgow_total');
    var rass = val('rass_atual');
    var delirium = '';
    var delSel = qs('input[name="delirium"]:checked');
    if (delSel && delSel.value === 'nao') delirium = 'Delirium: n√£o';
    if (delSel && delSel.value === 'sim') {
      var tipos = [];
      if (byId('del_hiper') && byId('del_hiper').checked) tipos.push('hiperativo');
      if (byId('del_hipo') && byId('del_hipo').checked) tipos.push('hipoativo');
      if (byId('del_misto') && byId('del_misto').checked) tipos.push('misto');
      delirium = 'Delirium: sim' + (tipos.length ? (' ('+tipos.join(', ')+')') : '');
    }
    var analgTxt = '';
    var analgSel = qs('input[name="analg_sed"]:checked');
    if (analgSel && analgSel.value === 'nao') analgTxt = 'Analgesia/seda√ß√£o: n√£o';
    if (analgSel && analgSel.value === 'sim') {
      var meds = [];
      var items = qsa('#analgesia_lista .med-item');
      for (var ii=0; ii<items.length; ii++) {
        var chk = items[ii].querySelector('input[type="checkbox"]');
        var span = items[ii].querySelector('span');
        var dose = items[ii].querySelector('input.dose-input');
        if (chk && chk.checked) {
          meds.push((span ? span.textContent.replace(/^\s+|\s+$/g,'') : '') + (dose && dose.value ? (' ('+dose.value+')') : ''));
        }
      }
      analgTxt = 'Analgesia/seda√ß√£o: sim' + (meds.length ? (' ['+meds.join('; ')+']') : '');
    }
    var hasSist = suporte || respDet.length || (gasMarcada && gasDet.length) || hemoBase.length || drogas.length || perf.length || foco || atbs.length || culturas || glas || rass || delirium || analgTxt;
    if (hasSist) {
      linhas.push('Sistemas:');
      var respLine = [];
      if (suporte) respLine.push('Suporte: '+suporte);
      if (respDet.length) respLine.push(respDet.join(' | '));
      if (gasMarcada && gasDet.length) respLine.push('Gasometria: '+gasDet.join(' | '));
      if (respLine.length) linhas.push('- Respirat√≥rio: ' + respLine.join(' | '));
      var hemoLine = [];
      if (hemoBase.length) hemoLine.push(hemoBase.join(' | '));
      if (drogas.length) hemoLine.push('Drogas: '+drogas.join(' | '));
      if (perf.length) hemoLine.push('Perfus√£o: '+perf.join(' | '));
      if (hemoLine.length) linhas.push('- Hemodin√¢mica: ' + hemoLine.join(' | '));
      var infLine = [];
      if (foco) infLine.push('Foco: '+foco);
      if (atbs.length) infLine.push('ATB: '+atbs.join(' | '));
      if (culturas) infLine.push(culturas);
      if (infLine.length) linhas.push('- Infec√ß√£o: ' + infLine.join(' | '));

      var neuroLine = [];
      if (glas) neuroLine.push('Glasgow: '+glas);
      if (rass) neuroLine.push('RASS: '+rass);
      if (delirium) neuroLine.push(delirium);
      if (analgTxt) neuroLine.push(analgTxt);
      if (neuroLine.length) linhas.push('- Neuro/Seda√ß√£o: ' + neuroLine.join(' | '));

      linhas.push('');
    }

    // Invasivos
    var inv = [];
    function addInv(lbl, txt){ if (txt) inv.push(lbl + ': ' + txt); }
    var cvcLoc = val('cvc_local'), cvcDia = val('cvc_dia');
    if (cvcLoc || cvcDia) addInv('CVC', [cvcLoc, cvcDia ? ('dia '+cvcDia) : ''].filter(Boolean).join(' | '));
    var artLoc = val('art_local'), artDia = val('art_dia');
    if (artLoc || artDia) addInv('Cateter arterial', [artLoc, artDia ? ('dia '+artDia) : ''].filter(Boolean).join(' | '));
    var hdLoc = val('hd_local'), hdDia = val('hd_dia');
    if (hdLoc || hdDia) addInv('Cateter de HD', [hdLoc, hdDia ? ('dia '+hdDia) : ''].filter(Boolean).join(' | '));
    var svd = val('svd_dia'); if (svd) addInv('SVD', 'dia ' + svd);
    var tot = val('tot_tqt_dia'); if (tot) addInv('TOT/TQT', 'dia ' + tot);
    var drenos = val('drenos_outros'); if (drenos) addInv('Drenos/outros', drenos);
    if (inv.length) {
      linhas.push('Invasivos/Dispositivos:');
      for (var iii=0; iii<inv.length; iii++) linhas.push('- ' + inv[iii]);
      linhas.push('');
    }
    var diag = val('diagnostico_internacao');
    if (diag) { linhas.push('Diagn√≥stico(s) de interna√ß√£o: ' + diag); linhas.push(''); }

    var plano = val('plano_metas');
    if (plano) { linhas.push('Plano/Metas: ' + plano); linhas.push(''); }

    var ta = byId('textoGerado');
    if (ta) ta.value = linhas.join('\n');
    abrirPainelTexto();
  }

  function abrirEvolucao() {
    var area = byId('evolucaoArea');
    if (!area) return;

    area.classList.remove('hidden');

    // LIMPAR TODOS OS CAMPOS DA EVOLU√á√ÉO PRIMEIRO
    limparCamposEvolucao();

    // Auto-preencher data/hora da evolu√ß√£o (somente se vazio)
    setNowIfEmpty('evo_data', area);

    // Copiar identifica√ß√£o e hist√≥rico da ADMISS√ÉO (se n√£o houver evolu√ß√£o anterior)
    var rawEvo = localStorage.getItem('evolucao_last_leito_' + currentBed);
    if (!rawEvo) { // Only auto-copy from admission if it's the very first evolution for this bed
        evoAutoFromAdmissao();
    } else {
        // If there's a previous evolution, the `novaEvolucao()` function already handles copying maintained fields.
        // `carregarLeitoAtual()` also handles initial load of the last evolution.
    }
    
    evoAtualizarDiaUTI();

    try { area.scrollIntoView({behavior:'smooth', block:'start'}); }
    catch(e) { area.scrollIntoView(true); }
  
    try { evoUpdateBigHeader(); } catch(e) {}
  }
function limparCamposEvolucao() {
    var area = byId('evolucaoArea');
    if (!area) return;
    
    var els = qsa('#evolucaoArea input, #evolucaoArea textarea, #evolucaoArea select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      // N√£o limpa campos readonly (identifica√ß√£o vem da admiss√£o/evo anterior)
      if (el.readOnly || el.readonly) continue;
      
      // Do not clear fields that should be maintained in `novaEvolucao()`
      // This function is mainly for a full clear or initial setup.
      // `novaEvolucao()` will handle intelligent clearing.
      // For now, let's clear everything editable for a clean state when *opening* the evolution.
      if (el.type === 'checkbox' || el.type === 'radio') {
        el.checked = false;
      } else {
        el.value = '';
      }
    }
    // Also reset conditional visibility of fields
    var toHide = [
      'evo_resp_vm','evo_resp_venturi','evo_resp_cn','evo_resp_mr',
      'evo_gaso_fields',
      'evo_pocus_pulm_desc','evo_rx_torax_desc',
      'evo_pocus_card_desc','evo_vexus_desc',
      'evo_ecg_txt_wrap',
      'evo_delirium_tipos','evo_analgesia_lista',
      'evo_trs_tipo_wrap',
      'evo_cult_pend_wrap','evo_cult_pos_wrap',
      'evo_nefro_txt_wrap','evo_cg_txt_wrap','evo_vasc_txt_wrap',
      'evo_estase_wrap', 'evo_hipo_wrap', 'evo_hiper_wrap',
      'evo_marcapasso_wrap', 'evo_escco_wrap',
      'evo_doppler_wrap'
    ];
    for (var k=0;k<toHide.length;k++) evoToggleBox(toHide[k], false);
  }

  // This function is mostly for initial load from previous EVOLUTION (evolucao_last_leito_X)
  // It applies the saved data to the current form state, triggering visual updates.
function copiarDadosEvolucaoAnterior() {
    try {
        // Usa a chave espec√≠fica do leito para a √∫ltima evolu√ß√£o
        var prev = localStorage.getItem('evolucao_last_leito_' + currentBed); // Updated key
        if (!prev) return; // Primeira evolu√ß√£o, n√£o tem anterior
        
        var data = JSON.parse(prev);
        // Apply data to form fields and trigger all necessary visual updates.
        // The evoApply(data) function below handles this comprehensively.
        evoApply(data);

    } catch(e) {
        console.error('Erro ao copiar evolu√ß√£o anterior:', e);
    }
}
function evoAtualizarDiaUTI() {
    var out = qs('#evolucaoArea [name="evo_dia_uti"]');
    if (!out) return;
    var admDT = val('datahora_admissao');
    var admD = val('data_admissao'); // Fallback, though datahora_admissao should be primary
    var adm = admDT || admD;
    var evoEl = qs('#evolucaoArea [name="evo_data"]');
    var evoDT = evoEl ? evoEl.value : '';
    if (!adm) { out.value=''; return; }
    var admDate = parseLocalDateTime(adm);
    var evoDate = evoDT ? parseLocalDateTime(evoDT) : new Date();
    if (!admDate || !evoDate) { out.value=''; return; }
    var diffMs = evoDate.getTime() - admDate.getTime();
    var dia = Math.floor(diffMs / 86400000) + 1;
    out.value = (dia>0 ? String(dia) : '');
  }
// ===== Evolu√ß√£o di√°ria (ES5) =====
  function fecharEvolucao() {
    var area = byId('evolucaoArea');
    if (area) area.classList.add('hidden');
    
    // Limpar modo de edi√ß√£o
    if (typeof evolucaoEmEdicao !== 'undefined') {
      evolucaoEmEdicao = null;
    }
    var statusDiv = document.getElementById('status_evo_save');
    if (statusDiv) statusDiv.innerHTML = '';
  }
function evoToggleResp(tipo) {
    var vm = byId('evo_resp_vm');
    var venturi = byId('evo_resp_venturi');
    var cn = byId('evo_resp_cn');
    var mr = byId('evo_resp_mr');
    if (!vm || !venturi || !cn || !mr) return;

    vm.classList.add('hidden');
    venturi.classList.add('hidden');
    cn.classList.add('hidden');
    mr.classList.add('hidden');

    // Se voltar para Ar ambiente, limpar campos dos suportes anteriores
    if (tipo === 'Ar ambiente') {
      clearContainer(vm);
      clearContainer(venturi);
      clearContainer(cn);
      clearContainer(mr);
      return;
    }

    if (tipo === 'VM') vm.classList.remove('hidden');
    else if (tipo === 'Venturi') venturi.classList.remove('hidden');
    else if (tipo === 'CN') cn.classList.remove('hidden');
    else if (tipo === 'MR') mr.classList.remove('hidden');
    // Ar ambiente: n√£o abre nada
  }
function evoToggleGasometria() {
    var chk = byId('evo_gaso_check'); // Corrected ID
    var div = byId('evo_gaso_fields');
    if (!chk || !div) return;

    if (chk.checked) div.classList.remove('hidden');
    else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }
function evoToggleHemoDrug(drug) {
    var map = {
      dobutamina: { chk: 'evo_chk_dobutamina', div: 'evo_drug_dobutamina' },
      milrinona: { chk: 'evo_chk_milrinona', div: 'evo_drug_milrinona' },
      noradrenalina: { chk: 'evo_chk_noradrenalina', div: 'evo_drug_noradrenalina' },
      vasopressina: { chk: 'evo_chk_vasopressina', div: 'evo_drug_vasopressina' }
    };
    if (!map[drug]) return;

    var chk = byId(map[drug].chk);
    var div = byId(map[drug].div);
    if (!chk || !div) return;
    if (chk.checked) div.classList.remove('hidden');
    else {
      var input = div.querySelector('input');
      if (input) input.value = '';
      div.classList.add('hidden');
    }
  }

  function evoTogglePerfusao() {
    var chk = byId('evo_chk_perf');
    var div = byId('evo_perf_fields');
    if (!chk || !div) return;
    if (chk.checked) div.classList.remove('hidden');
    else {
      var ins = div.querySelectorAll('input');
      for (var i=0;i<ins.length;i++) ins[i].value = '';
      div.classList.add('hidden');
    }
  }

  function evoToggleECG() { // This function doesn't seem to be used with evo_ecg_dia, which uses evoToggleBox
    // Let's ensure evoToggleBox is called correctly
  }
function evoToggleTRS() {
    var sel = qs('input[name="evo_trs"]:checked');
    var wrap = byId('evo_trs_tipo_wrap');
    if (!wrap) return;
    if (sel && sel.value === 'sim') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }
function evoToggleCulturas(valor) {
    var wrapPos = byId('evo_cult_pos_wrap');
    var wrapPend = byId('evo_cult_pend_wrap');
    if (!wrapPos || !wrapPend) return;
    
    evoToggleBox('evo_cult_pos_wrap', valor === 'positivas');
    evoToggleBox('evo_cult_pend_wrap', valor === 'pendentes');
  }
function evoToggleTEV() {
    var sel = qs('input[name="evo_tev"]:checked');
    var wrap = byId('evo_tev_just_wrap');
    if (!wrap) return;
    if (sel && sel.value === 'nao') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('input');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }
function evoToggleInterconsulta(name, wrapId) {
    var sel = qs('#evolucaoArea input[name="'+name+'"]:checked');
    var wrap = byId(wrapId);
    if (!wrap) return;
    if (sel && sel.value === 'sim') wrap.classList.remove('hidden');
    else {
      var inp = wrap.querySelector('textarea');
      if (inp) inp.value = '';
      wrap.classList.add('hidden');
    }
  }

  function evoSetRenalPeriodo(horas) {
    var bh = byId('evo_bh_label');
    var diu = byId('evo_diurese_label');
    if (bh) bh.textContent = 'BH ' + horas + 'h';
    if (diu) diu.textContent = 'Diurese ' + horas + 'h';
// marcar r√°dio correspondente
    var r = document.querySelector('input[name="evo_renal_periodo"][value="'+String(horas)+'"]');
    if (r) r.checked = true;
  }
function evoSyncRenalPeriodoDefault() {
    // Se o usu√°rio n√£o escolheu, define padr√£o pelo turno (diurna=24h, noturna=12h)
    var chosen = document.querySelector('input[name="evo_renal_periodo"]:checked');
    if (chosen) { evoSetRenalPeriodo(parseInt(chosen.value,10)); return; }

    var t = document.querySelector('input[name="evo_turno"]:checked');
    if (t && (t.value === 'Noturna' || t.value === 'noturna')) evoSetRenalPeriodo(12);
    else evoSetRenalPeriodo(24);
  }

  function evoCopiarIdentificacao() {
    evoAutoFromAdmissao();
    try { if (typeof evoAtualizarDiaUTI === 'function') evoAtualizarDiaUTI(); } catch(e) {}
    try { if (typeof evoApply === 'function') evoApply(evoCollectFields()); } catch(e) {} // Pass current fields
  }

  function evoCopiarHPPDaAdmissao() {
    var area = byId('evolucaoArea');
    if (!area) return;

    function byName(n){ return document.querySelector('[name="'+n+'"]'); }
    function vName(n){ var el = byName(n); return el ? (el.value || '') : ''; }
    var dstH = area.querySelector('[name="evo_comorbidades"]');
    var dstA = area.querySelector('[name="evo_alergias"]');
    var dstS = area.querySelector('[name="evo_cirurgias"]');

    if (dstH) dstH.value = vName('hpp');
    if (dstA) dstA.value = vName('alergias');
    if (dstS) dstS.value = vName('cirurgias');

    try { evoCalcularTFGeClCr && evoCalcularTFGeClCr(); } catch(e) {}
    try { evoUpdateBigHeader && evoUpdateBigHeader(); } catch(e) {}
  }

  function evoKey(turno) { return 'evolucao_' + (turno === 'Noturna' ? 'noturna' : 'diurna'); }

  function evoCollectFields() { // Renamed from evoCollect to avoid confusion with new evoCollectFields
    var data = {};
    var area = byId('evolucaoArea');
    if (!area) return {};
    var els = area.querySelectorAll('input, textarea, select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      var key = el.name || el.id;
      if (!key) continue;
      if (el.type === 'checkbox') data[key] = !!el.checked;
      else if (el.type === 'radio') {
        if (el.checked) data[key] = el.value;
        else if (typeof data[key] === 'undefined') data[key] = null;
      } else data[key] = el.value;
    }
    return data;
  }
function evoApply(data) {
    if (!data) return;
    var els = qsa('#evolucaoArea input, #evolucaoArea textarea, #evolucaoArea select');
    for (var i=0;i<els.length;i++){
      var el = els[i];
      var key = el.name || el.id;
      if (!key || typeof data[key] === 'undefined') continue;
      if (el.type === 'checkbox') el.checked = !!data[key];
      else if (el.type === 'radio') el.checked = (data[key] !== null && el.value === data[key]);
      else el.value = data[key] !== null ? data[key] : '';
    }

    // re-aplicar condicionais
    evoAtualizarLabelsRenal(); // This function is not defined in the provided code, removing call for now, or adding a stub if necessary. (It's about updating BH/Diurese labels, let's keep evoSetRenalPeriodo)
    if (data.evo_renal_periodo) evoSetRenalPeriodo(parseInt(data.evo_renal_periodo, 10)); // Ensure labels are updated if period was saved
    else evoSyncRenalPeriodoDefault(); // If not saved, apply default

    var respSel = qs('#evolucaoArea input[name="evo_resp_suporte"]:checked');
    if (respSel) evoToggleRespSuporte(respSel.value);
    else evoToggleRespSuporte('Ar ambiente'); // Default

    if (byId('evo_gaso_check')) byId('evo_gaso_check').checked = !!data['evo_gaso_check']; evoToggleGasometria();

    if (byId('evo_chk_perf')) byId('evo_chk_perf').checked = !!data['evo_chk_perf']; evoTogglePerfusao();

    if (qs('#evolucaoArea input[name="evo_ecg_dia"]')) {
      var ecgSel = qs('#evolucaoArea input[name="evo_ecg_dia"]:checked');
      evoToggleBox('evo_ecg_txt_wrap', ecgSel && ecgSel.value === 'sim');
    }
    if (qs('#evolucaoArea input[name="evo_pocus_pulm"]')) {
      var pocusPulmSel = qs('#evolucaoArea input[name="evo_pocus_pulm"]:checked');
      evoToggleBox('evo_pocus_pulm_desc', pocusPulmSel && pocusPulmSel.value === 'sim');
    }
    if (qs('#evolucaoArea input[name="evo_rx_torax"]')) {
      var rxToraxSel = qs('#evolucaoArea input[name="evo_rx_torax"]:checked');
      evoToggleBox('evo_rx_torax_desc', rxToraxSel && rxToraxSel.value === 'sim');
    }
    if (qs('#evolucaoArea input[name="evo_pocus_card"]')) {
      var pocusCardSel = qs('#evolucaoArea input[name="evo_pocus_card"]:checked');
      evoToggleBox('evo_pocus_card_desc', pocusCardSel && pocusCardSel.value === 'sim');
    }
    if (qs('#evolucaoArea input[name="evo_vexus"]')) {
      var vexusSel = qs('#evolucaoArea input[name="evo_vexus"]:checked');
      evoToggleBox('evo_vexus_desc', vexusSel && vexusSel.value === 'sim');
    }


    if (qs('#evolucaoArea input[name="evo_trs"]')) {
      var trsSel = qs('#evolucaoArea input[name="evo_trs"]:checked');
      evoToggleBox('evo_trs_tipo_wrap', trsSel && trsSel.value === 'sim');
    }
    evoToggleCulturas(data.evo_culturas); // Pass the value directly
    if (qs('#evolucaoArea input[name="evo_tev"]')) {
      var tevSel = qs('#evolucaoArea input[name="evo_tev"]:checked');
      evoToggleBox('evo_tev_just_wrap', tevSel && tevSel.value === 'nao');
    }

    evoToggleInterconsulta('evo_nefro','evo_nefro_txt_wrap');
    evoToggleInterconsulta('evo_cg','evo_cg_txt_wrap');
    // Removed evo_ccv_txt_wrap
    evoToggleInterconsulta('evo_vasc','evo_vasc_txt_wrap');

    // hemo drugs
    var drugs = ['dobutamina','milrinona','noradrenalina','vasopressina'];
    for (var d=0; d<drugs.length; d++) {
        var chkId = 'evo_chk_' + drugs[d];
        if (byId(chkId)) {
            byId(chkId).checked = !!data[chkId];
            evoToggleHemoDrug(drugs[d]);
        }
    }

    // Neuro Extra (Marcapasso, esCCO, Doppler)
    if (qs('#evolucaoArea input[name="evo_marcapasso_check"]')) {
      qs('#evolucaoArea input[name="evo_marcapasso_check"]').checked = !!data['evo_marcapasso_check'];
      toggleHemoExtra('marcapasso');
    }
    if (qs('#evolucaoArea input[name="evo_escco_check"]')) {
      qs('#evolucaoArea input[name="evo_escco_check"]').checked = !!data['evo_escco_check'];
      toggleHemoExtra('escco');
    }
    if (qs('#evolucaoArea input[name="evo_doppler_check"]')) {
      qs('#evolucaoArea input[name="evo_doppler_check"]').checked = !!data['evo_doppler_check'];
      toggleNeuroExtra('doppler');
    }


    // Nutri√ß√£o
    if (byId('evo_dieta_select')) {
      byId('evo_dieta_select').value = data['evo_dieta_select'] || 'fresubin_original';
      evoToggleBox("evo_dieta_custom_wrap", byId('evo_dieta_select').value === "custom");
    }
    evoRecalcNutricao();

    // GI
    var estaseSel = qs('#evolucaoArea input[name="evo_estase"]:checked');
    evoToggleBox('evo_estase_wrap', estaseSel && estaseSel.value === 'sim');
    var hipoSel = qs('#evolucaoArea input[name="evo_hipo"]:checked');
    evoToggleBox('evo_hipo_wrap', hipoSel && hipoSel.value === 'sim');
    var hiperSel = qs('#evolucaoArea input[name="evo_hiper"]:checked');
    evoToggleBox('evo_hiper_wrap', hiperSel && hiperSel.value === 'sim');

    // Analgesia/Seda√ß√£o in evo section
    var evoAnalgSel = qs('#evolucaoArea input[name="evo_analg_sed"]:checked');
    if (evoAnalgSel) evoToggleAnalgesia(evoAnalgSel.value === 'sim');
    else evoToggleAnalgesia(false);

    // Delirium in evo section
    var evoDeliriumSel = qs('#evolucaoArea input[name="evo_delirium"]:checked');
    if (evoDeliriumSel) evoToggleDelirium(evoDeliriumSel.value === 'sim');
    else evoToggleDelirium(false);

    // Doses in evo (re-trigger to hide/show)
    var evoChkMeds = qsa('#evo_analgesia_lista input[type="checkbox"]');
    for (var k=0;k<evoChkMeds.length;k++) {
      var chk = evoChkMeds[k];
      var doseId = 'dose_' + chk.id;
      if (byId(doseId)) {
        if (chk.checked) byId(doseId).classList.remove('hidden');
        else byId(doseId).classList.add('hidden');
      }
    }

    evoCalcularTFGeClCr(); // Re-calculate eGFR/ClCr after loading data

    try { evoUpdateBigHeader(); } catch(e) {}
  }
function evoSalvarEvolucaoAtual() {
    try {
        var turnoSel = qs('input[name="evo_turno"]:checked');
        var turno = turnoSel ? turnoSel.value : 'Diurna';
        var data = evoCollectFields();
        data._saved_at = (new Date()).toISOString();
        data._turno = turno;

        // Get existing history for the current bed
        var hist = evoGetHistory();
        
        hist.push({ meta: { datahora: data.evo_data, turno: turno }, data: data });
        evoSetHistory(hist); // Save updated history
        evoRenderHistory(); // Re-render history list in UI
        
        // Also save this as the 'last' evolution for the current bed for quick copy feature
        localStorage.setItem('evolucao_last_leito_' + currentBed, JSON.stringify(data));
        
        var st = byId('status_evo_save');
        if (st) {
            st.textContent = 'Salvo ‚úî';
            setTimeout(function(){ st.textContent = ''; }, 2000);
        }
    } catch(e){ console.error('Erro ao salvar evolu√ß√£o:', e); }
}

function evoCarregarTurnoAtual() {
    try {
      var turnoSel = qs('input[name="evo_turno"]:checked');
      var turno = turnoSel ? turnoSel.value : 'Diurna';
      var raw = localStorage.getItem(evoKey(turno));
      if (!raw) return;
      evoApply(JSON.parse(raw));
    } catch(e){}
  }
function evoCopiarTurnoAnterior() {
    try {
      var raw = localStorage.getItem('evolucao_last_leito_' + currentBed); // Use current bed's last evo
      if (!raw) return;
      var data = JSON.parse(raw);
      // n√£o sobrescreve turno selecionado (o usu√°rio escolhe)
      var turnoSel = qs('input[name="evo_turno"]:checked');
      var turnoAtual = turnoSel ? turnoSel.value : 'Diurna';

      // copiar campos comuns
      evoApply(data);

      // ajustes de per√≠odo (diurna/noturna)
      // evoAtualizarLabelsRenal(); // This function is not defined. Using evoSetRenalPeriodo via evoApply()
      
      // se estiver indo para Noturna e houver dia de UTI num√©rico, manter (usu√°rio ajusta se necess√°rio)
      if (turnoAtual === 'Noturna') {
        var di = qs('[name="evo_dia_uti"]');
        if (di && data['evo_dia_uti']) di.value = data['evo_dia_uti'];
      }
      // marcar turno atual visualmente (sem reescrever localStorage)
      var ts = qsa('input[name="evo_turno"]');
      for (var i=0;i<ts.length;i++) ts[i].checked = (ts[i].value === turnoAtual);
      // evoAtualizarLabelsRenal(); // This function is not defined. Using evoSetRenalPeriodo via evoApply()
    } catch(e){}
  }

  function evoAbrirPainelTexto() {
    var p = byId('painelTextoEvo');
    if (p) {
      p.classList.remove('hidden');
      try { p.scrollIntoView({behavior:'smooth', block:'start'}); } catch(e){ p.scrollIntoView(true); }
    }
  }

  function evoFecharPainelTexto() {
    var p = byId('painelTextoEvo');
    if (p) p.classList.add('hidden');
  }
function evoCopiarTexto() {
    var ta = byId('textoGeradoEvo');
    if (!ta) return;
    ta.focus();
    ta.select();
    try { document.execCommand('copy'); } catch(e){}
  }
function evoVal(nameOrId) {
    var el = qs('#evolucaoArea [name="'+nameOrId+'"]') || byId(nameOrId);
    if (!el) return '';
