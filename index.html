<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PassômetroUTI - Sistema de Evolução CTI</title>

<style>
body{font-family:Arial,sans-serif;background:#f2f2f2;margin:20px}
.hidden{display:none}
.section{background:#fff;border:1px solid #ccc;border-radius:8px;padding:16px;margin-bottom:16px}
.topo{display:flex;align-items:center;gap:20px;margin-bottom:16px}
.topo img{height:65px}
.topo h1{flex:1;text-align:center;margin:0}
.row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
label{display:flex;flex-direction:column;min-width:160px}
input,select,textarea{padding:6px;border:1px solid #bbb;border-radius:4px}
textarea{width:100%;resize:vertical}
button{padding:10px 14px;border-radius:6px;border:1px solid #777;background:#f2f2f2;cursor:pointer}

/* Passômetro */
.leitos{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.leito{border-radius:10px;padding:12px;color:#fff;text-align:center;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.2)}
.leito small{display:block;margin-top:6px;opacity:.9}
.livre{background:#2e7d32}
.ocupado{background:#c62828}
.bloqueado{background:#f9a825;color:#333}
.leito.ativo{outline:4px solid #1565c0}

/* Histórico */
.hist-item{border-bottom:1px solid #ddd;padding:8px 0}
.hist-item:last-child{border-bottom:none}
.hist-meta{font-size:12px;color:#666}
</style>
</head>

<body>

<div class="topo">
  <img src="HNSS.jpeg">
  <h1>Admissão CTI Adulto</h1>
  <img src="intensivale.png">
</div>

<!-- LOGIN -->
<div class="section" id="loginArea">
  <h3>Login</h3>
  <div class="row">
    <label>Email<input id="email" type="email"></label>
    <label>Senha<input id="senha" type="password"></label>
    <button onclick="login()">Entrar</button>
  </div>
</div>

<!-- PASSÔMETRO -->
<div class="section hidden" id="passometroArea">
  <h3>Passômetro – UTI</h3>
  <div class="leitos" id="leitos"></div>
</div>

<!-- ADMISSÃO / EVOLUÇÃO -->
<div class="section hidden" id="admissaoArea">
  <h3 id="tituloLeito">Leito</h3>

  <!-- Identificação -->
  <h4>Identificação</h4>
  <div class="row">
    <label>Nome<input name="nome"></label>
    <label>Idade<input name="idade"></label>
    <label>Sexo
      <select name="sexo"><option></option><option>M</option><option>F</option></select>
    </label>
    <label>Data/hora admissão<input type="datetime-local" name="datahora_admissao"></label>
  </div>
  <div class="row">
    <label style="flex:1">HMA<textarea name="hma" rows="3"></textarea></label>
  </div>

  <button onclick="salvarLeito()">Salvar/Atualizar Leito</button>

  <hr>

  <!-- Evolução diária -->
  <h4>Evolução diária</h4>
  <div class="row">
    <label>Data<input type="date" id="evoData"></label>
    <label>Turno
      <select id="evoTurno"><option>Diurna</option><option>Noturna</option></select>
    </label>
  </div>
  <div class="row">
    <label style="flex:1">Evolução<textarea id="evoTexto" rows="4"></textarea></label>
  </div>
  <button onclick="salvarEvolucao()">Salvar evolução</button>

  <hr>

  <!-- Histórico -->
  <h4>Histórico</h4>
  <div id="historico"></div>

  <hr>

  <!-- Alta -->
  <h4>Alta</h4>
  <div class="row">
    <label>Data/hora alta<input type="datetime-local" id="altaData"></label>
  </div>
  <div class="row">
    <label style="flex:1">Resumo de alta<textarea id="altaResumo" rows="3"></textarea></label>
  </div>
  <button onclick="darAlta()">Dar alta (arquivar)</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* Firebase HNSS */
const firebaseConfig = {
  apiKey: "AIzaSyB7Mt4NsiXOam36i5MgClhKa-IOimlQ4DE",
  authDomain: "gestaoutihnss.firebaseapp.com",
  projectId: "gestaoutihnss",
  storageBucket: "gestaoutihnss.firebasestorage.app",
  messagingSenderId: "664272211913",
  appId: "1:664272211913:web:66e30e6670126b3e51a218",
  measurementId: "G-K0ZB5KLRGY"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let leitoAtual = null;

/* Login */
window.login = () =>
  signInWithEmailAndPassword(auth, email.value, senha.value)
    .catch(e=>alert(e.message));

onAuthStateChanged(auth,u=>{
  if(u){ loginArea.classList.add('hidden'); passometroArea.classList.remove('hidden'); ouvirLeitos(); }
});

/* Passômetro */
function ouvirLeitos(){
  for(let i=1;i<=10;i++){
    const ref=doc(db,"leitos","UTI_"+i);
    onSnapshot(ref,s=>renderLeito(i,s.exists()?s.data():null));
  }
}
function renderLeito(n,d){
  let div=document.getElementById("leito_"+n);
  if(!div){
    div=document.createElement("div");
    div.id="leito_"+n;
    div.onclick=()=>selecionarLeito(n);
    leitos.appendChild(div);
  }
  const status=d?.status||"livre";
  const nome=d?.nome||"";
  div.className=`leito ${status} ${leitoAtual===n?'ativo':''}`;
  div.innerHTML=`Leito ${n}<small>${nome}</small>`;
}

/* Seleção */
window.selecionarLeito = async (n)=>{
  leitoAtual=n;
  tituloLeito.innerText="Leito "+n;
  admissaoArea.classList.remove('hidden');
  document.querySelectorAll(".leito").forEach(l=>l.classList.remove("ativo"));
  document.getElementById("leito_"+n).classList.add("ativo");

  // carregar leito
  document.querySelectorAll("[name]").forEach(el=>el.value="");
  const snap=await getDoc(doc(db,"leitos","UTI_"+n));
  if(snap.exists()){
    const d=snap.data();
    document.querySelectorAll("[name]").forEach(el=>{ if(d[el.name]) el.value=d[el.name]; });
  }
  ouvirHistorico();
};

/* Salvar leito */
window.salvarLeito = async ()=>{
  if(!leitoAtual) return;
  let dados={status:"ocupado"};
  document.querySelectorAll("[name]").forEach(el=>dados[el.name]=el.value);
  await setDoc(doc(db,"leitos","UTI_"+leitoAtual),dados,{merge:true});
  alert("Leito atualizado");
};

/* Evolução */
window.salvarEvolucao = async ()=>{
  if(!leitoAtual) return;
  await addDoc(collection(db,"evolucoes","UTI_"+leitoAtual,"dias"),{
    data:evoData.value,
    turno:evoTurno.value,
    texto:evoTexto.value,
    criado_em:new Date()
  });
  evoTexto.value="";
};

/* Histórico */
function ouvirHistorico(){
  historico.innerHTML="";
  onSnapshot(collection(db,"evolucoes","UTI_"+leitoAtual,"dias"),snap=>{
    historico.innerHTML="";
    snap.forEach(d=>{
      const v=d.data();
      const div=document.createElement("div");
      div.className="hist-item";
      div.innerHTML=`<div class="hist-meta">${v.data} – ${v.turno}</div><div>${v.texto}</div>`;
      historico.appendChild(div);
    });
  });
}

/* Alta */
window.darAlta = async ()=>{
  if(!leitoAtual) return;
  const leitoRef=doc(db,"leitos","UTI_"+leitoAtual);
  const leitoSnap=await getDoc(leitoRef);
  if(!leitoSnap.exists()) return;

  const evolSnap=await getDocs(collection(db,"evolucoes","UTI_"+leitoAtual,"dias"));
  let evolucoes=[];
  evolSnap.forEach(e=>evolucoes.push(e.data()));

  await addDoc(collection(db,"altas"),{
    leito:leitoAtual,
    paciente:leitoSnap.data(),
    evolucoes,
    alta_em:altaData.value,
    resumo:altaResumo.value
  });

  // limpar
  for(const e of evolSnap.docs) await deleteDoc(e.ref);
  await setDoc(leitoRef,{status:"livre"});

  alert("Alta realizada e arquivada");
  admissaoArea.classList.add("hidden");
};
</script>

</body>
</html>
